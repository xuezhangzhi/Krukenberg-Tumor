```{r extract peptide and protein matrix}
rm(list=ls())
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)
library(magrittr)
source("datamining_library_ge20200902.R")
info<-read_excel("name.xlsx",sheet = 1)
info$subtype<-paste0(info$PType,info$Location)
df<-read.table("diann_KRUK_protein_20200828.txt",sep = "\t",stringsAsFactors = F,header = T)
names(df) <- ge.split(names(df),"\\.mzML",1,"DIA_")
df1<-df[,-1]
row.names(df1)<-df[,1]

##prepare metastasis delete protein group
df2<-df1[-grep(";",row.names(df1)),]
df3<-data.frame(t(df2))
df3$label<-row.names(df3)
pool<-df3[grep("pool",df3$label),]
df3$label<-gsub("b","",df3$label)
##delete 200834977
info1<-info[-grep("200834977",info$pathology),]
info2<-info1[which(info1$subtype %in% c("AG","AL","AR","BC","BL","BR")),]
info2$batch<-gsub("b","",info2$batch)
df4<-df3[which(df3$label %in% info2$batch),]
df5<-df4
df6<-df5[,-ncol(df5)]
df8<-data.frame(t(df6))
df9<-df8[apply(df8,1,function(x) {sum(is.na(x))/ncol(df8)}) < 1,]
df9[is.na(df9)]<-NA
write.csv(df9,"diann_KRUK_metastasis_protein_20211006_1.csv",row.names = T)


##prepare "GG","AG","BC","CC" delete protein group
df2<-df1[-grep(";",row.names(df1)),]
df3<-data.frame(t(df2))
df3$label<-row.names(df3)
pool<-df3[grep("pool",df3$label),]
df3$label<-gsub("b","",df3$label)
info2<-info[which(info$subtype %in% c("GG","AG","BC","CC")),]
info2$batch<-gsub("b","",info2$batch)
df4<-df3[which(df3$label %in% info2$batch),]
df5<-rbind(pool,df4)
df6<-df5[,-ncol(df5)]
df8<-data.frame(t(df6))
df9<-df8[apply(df8,1,function(x) {sum(is.na(x))/ncol(df8)}) < 1,]
df9[is.na(df9)]<-NA
write.csv(df9,"diann_KRUK_protein_20200828_1.csv",row.names = T)





rm(list=ls())
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)
library(magrittr)

source("datamining_library_ge20200902.R")
info<-read_excel("name.xlsx",sheet = 1)
info$subtype<-paste0(info$PType,info$Location)
df<-read.table("diann_KRUK_peptide_20200828.txt",sep = "\t",stringsAsFactors = F,header = T)
df2<-df
names(df2) <- ge.split(names(df2),"\\.mzML",1,"DIA_")
prot<-read.csv("diann_KRUK_protein_20200828.csv")
df3<-df2[,which(names(df2) %in% names(prot) )]

df4<-data.frame(df[,c(1,2)],df3)
df8<-df4
df9<-df8[apply(df8[,-c(1:2)],1,function(x) {sum(is.na(x))/ncol(df8[,-c(1:2)])}) < 1,]
df9[is.na(df9)]<-NA
write.csv(df9,"diann_KRUK_peptide_20200828.csv",row.names = F)

```

```{r  prepare matrix}
rm(list=ls())
library(readxl)
library(randomForest)
library(umap)
library(ROSE)

library(pROC)
library(magrittr)
library(magrittr)

source("datamining_library_ge20200902.R")
info<-read_excel("name.xlsx",sheet = 1)
info$subtype<-paste0(info$PType,info$Location)
df<-read.table("diann_KRUK_protein_20200828_REnames.txt",sep = "\t",stringsAsFactors = F,header = T)
names(df) <- ge.split(names(df),"\\.mzML",1,"DIA_")
df1<-df[,-1]
row.names(df1)<-df[,1]

##delete protein group
df2<-df1[-grep(";",row.names(df1)),]

## average tech rep
df3<-data.frame(t(df2))
df3$label<-row.names(df3)
df4<-df3[-grep("pool",df3$label),]
df4$label<-gsub("b","",df4$label)
df5<-aggregate(x = df4[,-which(names(df4)=="label")], by = list(df4$label), FUN = "mean",na.rm=T)
df5$batch<-paste0("b",df5$Group.1)
df6<-df5[,-1]
df7<-merge(info,df6,by.x="batch",all=F)
df7<-df7[-grep("A20",df7$sampleID),]
##  delete G18Ga,G20Ga,G29Ga,G37Ga,G40Ga,
df7<-df7[-grep("G18Ga|G20Ga|G29Ga|G37Ga|G40Ga", df7$sampleID),]

```

```{r  raw matrix statistics}
### for protein
rm(list=ls())
library(readxl)
library(randomForest)
library(umap)
library(ROSE)

library(pROC)
library(magrittr)
library(magrittr)
source("datamining_library_ge20200902.R")
info<-read_excel("name.xlsx",sheet = 1)
info$subtype<-paste0(info$PType,info$Location)
df<-read.table("diann_KRUK_protein_20200828_REnames.txt",sep = "\t",stringsAsFactors = F,header = T)
names(df) <- ge.split(names(df),"\\.mzML",1,"DIA_")
df1<-df[,-1]
row.names(df1)<-df[,1]
# df2<-df1
df2<-df1[-grep(";",row.names(df1)),]

## average tech rep
df3<-data.frame(t(df2))
df3$label<-row.names(df3)
df4<-df3[-grep("pool",df3$label),]
# df4$label<-gsub("b","",df4$label)
df5<-df4[,-which(names(df4)=="label")]
# df5$batch<-paste0("b",df4$label)

df5$batch<-gsub("b","",df4$label)
df5$batch<-paste0("b",df5$batch)
# df5<-aggregate(x = df4[,-which(names(df4)=="label")], by = list(df4$label), FUN = "mean",na.rm=T)
# df5<-df4[,-which(names(df4)=="label")]
# df5$batch<-paste0("b",df4$label)
df6<-merge(info,df5,by.x="batch",all=F)
row.names(df6)<-row.names(df5)
df7<-df6[-grep("A20",df6$sampleID),]
df7<-df7[-grep("G18Ga|G20Ga|G29Ga|G37Ga|G40Ga", df7$sampleID),]
df7<-df7[grep("AG|GG|BC|CC",df7$subtype),]
df8<-df7[,-12]

all_matrix<-df8
all_matrix2<-all_matrix[, -which(apply(all_matrix,2,function(x)all(is.na(x))))]
options(digits = 3)
NA_all_matrix<-  sprintf("%0.3f" ,mean(is.na(all_matrix2[,-c(1:12)])))

write.csv(all_matrix2 ,paste0("AG_GG_BC_CC_matrix",NA_all_matrix,"_",ncol(all_matrix2)-12,"Protein_20220317_1.csv"),row.names = F)


####peptide
source("datamining_library_ge20200902.R")
df<-read.table("diann_KRUK_peptide_20200828.txt",sep = "\t",stringsAsFactors = F,header = T)
df0<-df
names(df) <- ge.split(names(df),"\\.mzML",1,"DIA_")
df1<-df[,-c(1:2)]
row.names(df1)<-df[,1]
# df2<-df1
df2<-df1

## average tech rep
df3<-data.frame(t(df2))
df3$label<-row.names(df3)
df4<-df3[-grep("pool",df3$label),]
# df4$label<-gsub("b","",df4$label)
# df5<-aggregate(x = df4[,-which(names(df4)=="label")], by = list(df4$label), FUN = "mean",na.rm=T)
df5<-df4[,-which(names(df4)=="label")]
# df5$batch<-paste0("b",df4$label)

df5$batch<-gsub("b","",df4$label)
df5$batch<-paste0("b",df5$batch)
df6<-merge(info,df5,by.x="batch",all=F)
row.names(df6)<-row.names(df5)

df7<-df6[-grep("A20",df6$sampleID),]
df7<-df7[-grep("G18Ga|G20Ga|G29Ga|G37Ga|G40Ga", df7$sampleID),]
df7<-df7[grep("AG|GG|BC|CC",df7$subtype),]
df8<-df7[,-12]

all_matrix<-df8
all_matrix2<-all_matrix[, -which(apply(all_matrix,2,function(x)all(is.na(x))))]
options(digits = 3)

NA_all_matrix<-  sprintf("%0.3f" ,mean(is.na(all_matrix2[,-c(1:12)])))
write.csv(all_matrix2 ,paste0("AG_GG_BC_CCmatrix",NA_all_matrix,"_",ncol(all_matrix2)-12,"peptide_20220316.csv"),row.names = F)

``` 

```{r QC-AG-GG-BC-CC correlation}
library(RColorBrewer)
library(corrplot)
BC1<-df7[which(df7$subtype %in% c("BC")),-c(2:11)]
BC2<-BC1[,-c(1:2)]
# row.names(BC2)<-BC1$batch
BC2[is.na(BC2)]<-NA
BC3<-BC2[, apply(BC2,2,function(x) {sum(is.na(x))/nrow(BC2)}) < 0.99]

BC3$batch<-row.names(BC3)
info<-data.frame(info)
BC4<-merge(info,BC3, by="batch", all.x = F)
BC5<-aggregate(BC4[,15:ncol(BC4)], by=list(BC4$pathology), mean, na.rm=T)
BC6<-BC5[,-1]
row.names(BC6)<-BC5$Group.1
BC7<-data.frame(t(BC6))
BC8<-log2(BC7)
BC9<- as.vector(cor(BC8,use ="pairwise.complete.obs"))


CC1<-df7[which(df7$subtype %in% c("CC")),-c(2:11)]
CC2<-CC1[,-c(1:2)]
# row.names(CC2)<-CC1$batch
CC2[is.na(CC2)]<-NA
CC3<-CC2[, apply(CC2,2,function(x) {sum(is.na(x))/nrow(CC2)}) < 0.99]

CC3$batch<-row.names(CC3)
info<-data.frame(info)
CC4<-merge(info,CC3, by="batch", all.x = F)
CC5<-aggregate(CC4[,15:ncol(CC4)], by=list(CC4$pathology), mean, na.rm=T)
CC6<-CC5[,-1]
row.names(CC6)<-CC5$Group.1
CC7<-data.frame(t(CC6))
CC8<-log2(CC7)
CC9<- as.vector(cor(CC8,use ="pairwise.complete.obs"))



AG1<-df7[which(df7$subtype %in% c("AG")),-c(2:11)]
AG2<-AG1[,-c(1:2)]
# row.names(AG2)<-AG1$batch
AG2[is.na(AG2)]<-NA
AG3<-AG2[, apply(AG2,2,function(x) {sum(is.na(x))/nrow(AG2)}) < 0.99]

AG3$batch<-row.names(AG3)
info<-data.frame(info)
AG4<-merge(info,AG3, by="batch", all.x = F)
AG5<-aggregate(AG4[,15:ncol(AG4)], by=list(AG4$pathology), mean, na.rm=T)
AG6<-AG5[,-1]
row.names(AG6)<-AG5$Group.1
AG7<-data.frame(t(AG6))
AG8<-log2(AG7)
AG9<- as.vector(cor(AG8,use ="pairwise.complete.obs"))


GG1<-df7[which(df7$subtype %in% c("GG")),-c(2:11)]
GG2<-GG1[,-c(1:2)]
# row.names(GG2)<-GG1$batch
GG2[is.na(GG2)]<-NA
GG3<-GG2[, apply(GG2,2,function(x) {sum(is.na(x))/nrow(GG2)}) < 0.99]

GG3$batch<-row.names(GG3)
info<-data.frame(info)
GG4<-merge(info,GG3, by="batch", all.x = F)
GG5<-aggregate(GG4[,15:ncol(GG4)], by=list(GG4$pathology), mean, na.rm=T)
GG6<-GG5[,-1]
row.names(GG6)<-GG5$Group.1
GG7<-data.frame(t(GG6))
GG8<-log2(GG7)
GG9<- as.vector(cor(GG8,use ="pairwise.complete.obs"))

library(vioplot)
pdf("QC/AG_GG_BC_CC_corrplot_violin_2022031.pdf")

a<-vioplot(AG9,GG9,BC9,CC9,
        areaEqual=FALSE, col=c("seagreen4", "seagreen4","seagreen4", "seagreen4"),
      rectCol=c("seagreen4","seagreen4","seagreen4", "seagreen4"),
     lineCol=c("black", "black","black", "black"),
    border=c("black","black","black", "black"),
 names=c( "AG"  ,"GG","BC"  ,"CC"),
      main="", xlab=, ylab="Pearson correlation",plotCentre = "point")
fivenum(AG9)
fivenum(GG9)
fivenum(BC9)
fivenum(CC9)

p_AG_GG<-  t.test(AG9,GG9, paired = F, var.equal = F)$p.value 

p_BC_BC<-  t.test(BC9,CC9, paired = F, var.equal = F)$p.value 


```

```{r QC-AG-GG-BC-CC CV density}
library(ggridges)
library(viridis)
library(RColorBrewer)
library(corrplot)
BC1<-df7[which(df7$subtype %in% c("BC")),-c(2:11)]
BC2<-BC1[,-c(1:2)]
# row.names(BC2)<-BC1$batch
BC2[is.na(BC2)]<-NA
BC3<-BC2[, apply(BC2,2,function(x) {sum(is.na(x))/nrow(BC2)}) < 0.99]
BC4<-log2(BC3[,-1])
BC_CV<-as.vector(apply(BC4, 2, function(x){sd(x,na.rm = T)/mean(x,na.rm=T)}))
BC_CV2<-data.frame("BC",BC_CV)
names(BC_CV2)<-c("type","cv")
BC_density<-as.vector(as.matrix(BC4))
BC_density2<-data.frame("BC",BC_density)
names(BC_density2)<-c("type","density")

CC1<-df7[which(df7$subtype %in% c("CC")),-c(2:11)]
CC2<-CC1[,-c(1:2)]
# row.names(CC2)<-CC1$batch
CC2[is.na(CC2)]<-NA
CC3<-CC2[, apply(CC2,2,function(x) {sum(is.na(x))/nrow(CC2)}) < 0.99]
CC4<-log2(CC3[,-1])
CC_CV<-as.vector(apply(CC4, 2, function(x){sd(x,na.rm = T)/mean(x,na.rm=T)}))
CC_CV2<-data.frame("CC",CC_CV)
names(CC_CV2)<-c("type","cv")
CC_density<-as.vector(as.matrix(CC4))
CC_density2<-data.frame("CC",CC_density)
names(CC_density2)<-c("type","density")


AG1<-df7[which(df7$subtype %in% c("AG")),-c(2:11)]
AG2<-AG1[,-c(1:2)]
# row.names(AG2)<-AG1$batch
AG2[is.na(AG2)]<-NA
AG3<-AG2[, apply(AG2,2,function(x) {sum(is.na(x))/nrow(AG2)}) < 0.99]
AG4<-log2(AG3[,-1])
AG_CV<-as.vector(apply(AG4, 2, function(x){sd(x,na.rm = T)/mean(x,na.rm=T)}))
AG_CV2<-data.frame("AG",AG_CV)
names(AG_CV2)<-c("type","cv")
AG_density<-as.vector(as.matrix(AG4))
AG_density2<-data.frame("AG",AG_density)
names(AG_density2)<-c("type","density")

GG1<-df7[which(df7$subtype %in% c("GG")),-c(2:11)]
GG2<-GG1[,-c(1:2)]
# row.names(GG2)<-GG1$batch
GG2[is.na(GG2)]<-NA
GG3<-GG2[, apply(GG2,2,function(x) {sum(is.na(x))/nrow(GG2)}) < 0.99]
GG4<-log2(GG3[,-1])
GG_CV<-as.vector(apply(GG4, 2, function(x){sd(x,na.rm = T)/mean(x,na.rm=T)}))
GG_CV2<-data.frame("GG",GG_CV)
names(GG_CV2)<-c("type","cv")
GG_density<-as.vector(as.matrix(GG4))
GG_density2<-data.frame("GG",GG_density)
names(GG_density2)<-c("type","density")

CV<-rbind(BC_CV2,CC_CV2,AG_CV2,GG_CV2)

density<-rbind(BC_density2,CC_density2,AG_density2,GG_density2)

density<-ggplot(density,aes(x=density, y= type, fill= type))+
geom_density_ridges(alpha=0.6,bandwidth=4,jittered_points=FALSE)+
scale_fill_viridis(discrete =TRUE)+
scale_color_viridis(discrete =TRUE)+
theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 15,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())+
            theme(axis.text = element_text(size = 15,color = "black"))+
theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
            theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
            theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))

ggsave(plot = density, "QC/AG_GG_BC_CC_density_20220316.pdf")


library(vioplot)
pdf("QC/AG_GG_BC_CC_CV_violin_2022031.pdf")

a<-vioplot(BC_CV,CC_CV,AG_CV,GG_CV,
        areaEqual=FALSE, col=c("seagreen4", "seagreen4","seagreen4", "seagreen4"),
      rectCol=c("seagreen4","seagreen4","seagreen4", "seagreen4"),
     lineCol=c("black", "black","black", "black"),
    border=c("black","black","black", "black"),
 names=c( "AG"  ,"GG","BC"  ,"CC"),
      main="", xlab=, ylab="Pearson correlation",plotCentre = "point")
fivenum(BC_CV)
fivenum(CC_CV)
fivenum(AG_CV)
fivenum(GG_CV)
```

```{r  QC-AG-GG-BC-CC CV abundance}
library(ggridges)
library(viridis)
library(RColorBrewer)
library(corrplot)
library(ggplot2)
BC1<-df7[which(df7$subtype %in% c("BC")),-c(2:11)]
BC2<-BC1[,-c(1:2)]
row.names(BC2)<-BC1$batch
BC2[is.na(BC2)]<-NA
BC3<-BC2[, apply(BC2,2,function(x) {sum(is.na(x))/nrow(BC2)}) < 0.99]
BC4<-log2(BC3[,-1])
BC_CV<-as.vector(apply(BC4, 2, function(x){sd(x,na.rm = T)/mean(x,na.rm=T)}))
BC_abundance<-as.vector(apply(BC4, 2, function(x){mean(x,na.rm=T)}))
BC_CV_abundance<-data.frame(BC_CV,BC_abundance)
PlotBC<-ggplot(data = BC_CV_abundance,aes(x=BC_abundance, y= BC_CV))+
  geom_point(color="#00000033")+
  labs(x = "Log2(abundance)", y = "CV of protein abundance", title = "BC")+
theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 5,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())
ggsave("QC/BC_protein_abundance_cv_20220316.pdf",plot = PlotBC,width = 3,height = 3)

CC1<-df7[which(df7$subtype %in% c("CC")),-c(2:11)]
CC2<-CC1[,-c(1:2)]
row.names(CC2)<-CC1$batch
CC2[is.na(CC2)]<-NA
CC3<-CC2[, apply(CC2,2,function(x) {sum(is.na(x))/nrow(CC2)}) < 0.99]
CC4<-log2(CC3[,-1])
CC_CV<-as.vector(apply(CC4, 2, function(x){sd(x,na.rm = T)/mean(x,na.rm=T)}))
CC_abundance<-as.vector(apply(CC4, 2, function(x){mean(x,na.rm=T)}))
CC_CV_abundance<-data.frame(CC_CV,CC_abundance)
PlotCC<-ggplot(data = CC_CV_abundance,aes(x=CC_abundance, y= CC_CV))+
  geom_point(color="#00000033")+
  labs(x = "Log2(abundance)", y = "CV of protein abundance", title = "CC")+
theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 5,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())
ggsave("QC/CC_protein_abundance_cv_20220316.pdf",plot = PlotCC,width = 3,height = 3)


AG1<-df7[which(df7$subtype %in% c("AG")),-c(2:11)]
AG2<-AG1[,-c(1:2)]
row.names(AG2)<-AG1$batch
AG2[is.na(AG2)]<-NA
AG3<-AG2[, apply(AG2,2,function(x) {sum(is.na(x))/nrow(AG2)}) < 0.99]
AG4<-log2(AG3[,-1])
AG_CV<-as.vector(apply(AG4, 2, function(x){sd(x,na.rm = T)/mean(x,na.rm=T)}))
AG_abundance<-as.vector(apply(AG4, 2, function(x){mean(x,na.rm=T)}))
AG_CV_abundance<-data.frame(AG_CV,AG_abundance)
PlotAG<-ggplot(data = AG_CV_abundance,aes(x=AG_abundance, y= AG_CV))+
  geom_point(color="#00000033")+
  labs(x = "Log2(abundance)", y = "CV of protein abundance", title = "AG")+
theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 5,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())
ggsave("QC/AG_protein_abundance_cv_20220316.pdf",plot = PlotAG,width = 3,height = 3)



GG1<-df7[which(df7$subtype %in% c("GG")),-c(2:11)]
GG2<-GG1[,-c(1:2)]
row.names(GG2)<-GG1$batch
GG2[is.na(GG2)]<-NA
GG3<-GG2[, apply(GG2,2,function(x) {sum(is.na(x))/nrow(GG2)}) < 0.99]
GG4<-log2(GG3[,-1])
GG_CV<-as.vector(apply(GG4, 2, function(x){sd(x,na.rm = T)/mean(x,na.rm=T)}))
GG_abundance<-as.vector(apply(GG4, 2, function(x){mean(x,na.rm=T)}))
GG_CV_abundance<-data.frame(GG_CV,GG_abundance)
PlotGG<-ggplot(data = GG_CV_abundance,aes(x=GG_abundance, y= GG_CV))+
  geom_point(color="#00000033")+
  labs(x = "Log2(abundance)", y = "CV of protein abundance", title = "GG")+
theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 5,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())
ggsave("QC/GG_protein_abundance_cv_20220316.pdf",plot = PlotGG,width = 3,height = 3)
```


```{r QC-AG-GG-BC-CC PCA UMAP}
source("common.R")
###############
del_NA_col<-function(mat,ratio=0.1){
  mat = mat[,apply(mat, 2, function(x) {sum(is.na(x))/length(x) < ratio})]
  return(mat)
}
remove_narow <- function(mat,ratio=1){
  mat = mat[apply(mat, 1, function(x) {sum(is.na(x))/length(x) < ratio}),]
  return(mat)
}
library(RColorBrewer)
library(corrplot)
library(stringr)
df7<-read.csv("AG_GG_BC_CC_matrix0.531_10837Protein_20220317.csv",header = T)
all1<-df7[which(df7$subtype %in% c("BC","CC","AG","GG")),-c(2:11)]
all2<-all1[,-c(1:2)]
# row.names(all2)<-all1$batch
all2[is.na(all2)]<-NA
all3<-all2[, apply(all2,2,function(x) {sum(is.na(x))/nrow(all2)}) ==0]
all4<-cbind(df7[,1:12],all3)
write.csv(all4,"20250417_KT_missing0_protmat.csv",row.names = F)
# all3<-del_NA_col(all2)

type<-log2(all3)
type$label<-all1$subtype
all3_batch<- data.frame(str_split_fixed( all1$batch,"_",2 ))
all3_batch$X1<-gsub("b","",all3_batch$X1)
batch<-log2(all3)
batch$label<-as.factor(as.numeric(all3_batch$X1))

color1<-c("#D9942C","#8C2826","#80AA31","#5B7BAA")
color2<-c(brewer.pal(11,"YlOrRd")[4:9],brewer.pal(11,"YlGnBu")[4:9],brewer.pal(11,"Purples")[4:9],brewer.pal(11,"YlGn")[4:8])
set.seed(2021)
features<-ncol(type)-1
Plottype<-drawUMAP(strTitle = paste0( features," features"),type,ptColors = color1,rowNormalization = F,colNormalization = T)
Plotbatch<-drawUMAP(strTitle = paste0( features," features"),batch,ptColors = color2,rowNormalization = T,colNormalization = F)


ggsave(plot=Plottype, "QC/AG_GG_BC_CC_4types_10031ptot_UMAP_20230601.pdf",width = 8,height = 8)

ggsave(plot=Plotbatch, "QC/AG_GG_BC_CC_23batchs__10031ptot_UMAP_20230601.pdf",width = 8,height = 8)

```


```{r QC-AG-GG-BC-CC PCA UMAP for 23 overlapped proteins}

source("common.R")
library(RColorBrewer)
library(corrplot)
library(stringr)
###23 prot
df1<-read.csv("IPA/AG_GG_ipa.csv")
names(df1)<-c("prot",names(df1[,-1]))
df2<-read.csv("IPA/BC_CC_ipa.csv")
names(df2)<-c("prot",names(df2[,-1]))
df3<-df1[which(df1$prot %in% df2$prot),]
prot<-c(as.matrix(df3$prot))

all0<-df7[which(df7$subtype %in% c("BC","CC","AG","GG")),-c(2:11)]
all1<-all0[,which(names(all0) %in% prot )]
all2<-data.frame(all0$subtype,all1)
all2[is.na(all2)]<-NA
all3<-all2[, apply(all2,2,function(x) {sum(is.na(x))/nrow(all2)}) < 1]
row.names(all3)<-all0$batch
type<-log2(all3[,-1])
type$label<-all0$subtype
all3_batch<- data.frame(str_split_fixed( row.names(all3),"_",2 ))
all3_batch$X1<-gsub("b","",all3_batch$X1)
batch<-log2(all3[,-1])
batch$label<-as.numeric(all3_batch$X1)
batch1<-batch[order(batch$label,decreasing = F),]
batch1$label<-as.factor(batch1$label)


color1<-c("#D9942C","#8C2826","#80AA31","#5B7BAA")
color2<-c(brewer.pal(11,"YlOrRd")[4:9],brewer.pal(11,"YlGnBu")[4:9],brewer.pal(11,"Purples")[4:9],brewer.pal(11,"YlGn")[4:8])
set.seed(2021)
features<-ncol(type)-1

Plottype<-drawUMAP(strTitle = paste0( features," features"),type,ptColors = color1,rowNormalization = F,colNormalization = T)

Plotbatch<-drawUMAP(strTitle = paste0( features," features"),batch1,ptColors = color2,rowNormalization = F,colNormalization = T)

ggsave(plot=Plottype, "QC/AG_GG_BC_CC_4types_23prot_UMAP.pdf",width = 8,height = 8)
ggsave(plot=Plotbatch, "QC/AG_GG_BC_CC_23batchs_23_prot_UMAP.pdf",width = 8,height = 8)

```

```{r volcanoplot}
###BC_CC
library(RColorBrewer)
BC_CC1<-df7[which(df7$subtype %in% c("BC","CC")),-c(2:11)]
BC_CC2<-BC_CC1[,-1]
row.names(BC_CC2)<-BC_CC1$batch
BC_CC2[is.na(BC_CC2)]<-NA
write.csv(BC_CC2,"all_BC_CC_gsea.csv")

####NA less 70%
BC_CC3<-BC_CC2[, apply(BC_CC2,2,function(x) {sum(is.na(x))/nrow(BC_CC2)}) < 0.7]
### volcano
BC_CC4<-log2(BC_CC3[,-1])
BC_CC4$subtype<-BC_CC3$subtype
BC_CC4[is.na(BC_CC4)]<-0
fd <- data.frame(apply(2^BC_CC4[,-ncol(BC_CC4)],2, function(x) log2((mean(na.omit(x[which(BC_CC3$subtype=="BC")]))/mean(na.omit(x[which(BC_CC3$subtype=="CC")]))))))

pvalue<- data.frame(apply(BC_CC4[,-ncol(BC_CC4)],2, function(x)  t.test(x[which(BC_CC4$subtype=="BC")],x[which(BC_CC4$subtype=="CC")], paired = F, var.equal = F)$p.value ))

vol<-cbind(fd,pvalue)
names(vol)<-c("fd","P_value")

BC_CC<-data.frame(t(rbind(BC_CC4[,-ncol(BC_CC4)],t(vol))))
BC_CC$P_value_adjust<-p.adjust(BC_CC$P_value, method="BH")

# write.csv(BC_CC,"BC_CC_all2021111.csv")


pdf("volcano/BC_CC_volcano.pdf",width = 6,height = 6)
plot(BC_CC$fd, -log10(BC_CC$P_value_adjust), col="#00000033", pch=19,cex=3,
     
      xlab=paste("log2(fold change)"),
      ylab="-log10 adjusted p value",
      main="BC_CC")
# 
up <- subset(BC_CC, BC_CC$P_value_adjust < 0.05 & BC_CC$fd > 0.5)
down <- subset(BC_CC, BC_CC$P_value_adjust< 0.05 & BC_CC$fd< -0.5)
dif_BC_CC<-rbind(up[,100:102],down[,100:102])
write.csv(dif_BC_CC,file = "BC_CC_dif_prot_20250429.csv")
write.csv(up,file = "BC_CC_up.csv")
write.csv(down,file = "BC_CC_down.csv")

# 
points(up$fd, -log10(up$P_value_adjust), col=1, bg = brewer.pal(9, "YlOrRd")[6], pch=21, cex=3)
points(down$fd, -log10(down$P_value_adjust), col = 1,  bg = brewer.pal(11, "RdBu")[9], pch = 21,cex=3)
  
abline(h=1.3,v=c(-0.5,0.5),lty=2,lwd=1)

#}
dev.off()


###AG_GG
library(RColorBrewer)


AG_GG1<-df7[which(df7$subtype %in% c("AG","GG")),-c(2:11)]
AG_GG2<-AG_GG1[,-1]

AG_GG3 <- AG_GG2[, colSums(is.na(AG_GG2)) < nrow(AG_GG2)]
row.names(AG_GG2)<-AG_GG1$batch
AG_GG2[is.na(AG_GG2)]<-NA


write.csv(AG_GG2,"all_AG_GG_gsea.csv")

####NA less70%
AG_GG3<-AG_GG2[, apply(AG_GG2,2,function(x) {sum(is.na(x))/nrow(AG_GG2)}) < 0.7]
### volcano
AG_GG4<-log2(AG_GG3[,-1])
AG_GG4$subtype<-AG_GG3$subtype
AG_GG4[is.na(AG_GG4)]<-0
fd <- data.frame(apply(2^AG_GG4[,-ncol(AG_GG4)],2, function(x) log2((mean(na.omit(x[which(AG_GG3$subtype=="AG")]))/mean(na.omit(x[which(AG_GG3$subtype=="GG")]))))))

pvalue<- data.frame(apply(AG_GG4[,-ncol(AG_GG4)],2, function(x)  t.test(x[which(AG_GG4$subtype=="AG")],x[which(AG_GG4$subtype=="GG")], paired = F, var.equal = F)$p.value ))

vol<-cbind(fd,pvalue)
names(vol)<-c("fd","P_value")

AG_GG<-data.frame(t(rbind(AG_GG4[,-ncol(AG_GG4)],t(vol))))
AG_GG$P_value_adjust<-p.adjust(AG_GG$P_value, method="BH")
write.csv(AG_GG,"AG_GG_all_protein_20220318.csv")

pdf("volcano/AG_GG_volcano.pdf",width = 6,height = 6)
plot(AG_GG$fd, -log10(AG_GG$P_value_adjust), col="#00000033", pch=19,cex=3,
     
      xlab=paste("log2(fold change)"),
      ylab="-log10 adjusted p value",
      main="AG_GG")
# 
up <- subset(AG_GG, AG_GG$P_value_adjust < 0.05 & AG_GG$fd > 0.5)
down <- subset(AG_GG, AG_GG$P_value_adjust< 0.05 & AG_GG$fd< -0.5)
dif_AG_GG<-rbind(up[,96:98],down[,96:98])
write.csv(dif_AG_GG,file = "AG_GG_dif_prot_1.csv")
write.csv(up,file = "AG_GG_up.csv")
write.csv(down,file = "AG_GG_down.csv")


  #
points(up$fd, -log10(up$P_value_adjust), col=1, bg = brewer.pal(9, "YlOrRd")[6], pch=21, cex=3)
points(down$fd, -log10(down$P_value_adjust), col = 1,  bg = brewer.pal(11, "RdBu")[9], pch = 21,cex=3)
  #
abline(h=1.3,v=c(-0.5,0.5),lty=2,lwd=1)

#}
dev.off()

```

```{r}
#umap bind AG_GG，BC_CC 
umap_prot<-unique(c(row.names(dif_AG_GG),row.names(dif_BC_CC)))
source("common.R")
library(RColorBrewer)
library(corrplot)
library(stringr)
all1<-df7[which(df7$subtype %in% c("BC","CC","AG","GG")),-c(2:11)]
all2<-all1[,-c(1:2)]
# row.names(all2)<-all1$batch
all2[is.na(all2)]<-NA
all3<-all2[, apply(all2,2,function(x) {sum(is.na(x))/nrow(all2)}) < 1]

type<-log2(all3[,-1])
type$label<-all3$subtype
all3_batch<- data.frame(str_split_fixed( row.names(all3),"_",2 ))
all3_batch$X1<-gsub("b","",all3_batch$X1)
batch<-log2(all3[,-1])
batch$label<-as.factor(as.numeric(all3_batch$X1))

color1<-c("#D9942C","#8C2826","#80AA31","#5B7BAA")
color2<-c(brewer.pal(11,"YlOrRd")[4:9],brewer.pal(11,"YlGnBu")[4:9],brewer.pal(11,"Purples")[4:9],brewer.pal(11,"YlGn")[4:8])

type1<-type[,names(type)%in%umap_prot]
type1$label<-type$label

batch1<-batch[,names(batch)%in%umap_prot]
batch1$label<-batch$label

set.seed(2021)
features<-ncol(type1)-1
Plottype<-drawUMAP(strTitle = paste0( features," features"),type1,ptColors = color1,rowNormalization = T,colNormalization = T)
Plotbatch<-drawUMAP(strTitle = paste0( features," features"),batch1,ptColors = color2,rowNormalization = T,colNormalization = T)


ggsave(plot=Plottype, "AG_GG_BC_CC_4types_10031ptot_UMAP_20230601.pdf",width = 8,height = 8)

ggsave(plot=Plotbatch, "AG_GG_BC_CC_23batchs__10031ptot_UMAP_20230601.pdf",width = 8,height = 8)


set.seed(2021)
features<-ncol(type)-1
Plottype<-drawPCA(strTitle = paste0( features," features"),type,ptColors = color1,rowNormalization = T,colNormalization = T)
Plotbatch<-drawPCA(strTitle = paste0( features," features"),batch,ptColors = color2,rowNormalization = T,colNormalization = T)


set.seed(2021)
features<-ncol(type1)-1
Plottype<-drawTSNE(strTitle = paste0( features," features"),type1,ptColors = color1,rowNormalization = F,colNormalization = T)
Plotbatch<-drawTSNE(strTitle = paste0( features," features"),batch1,ptColors = color2,rowNormalization = F,colNormalization = T)






```




```{r boxplot for AG_GG  BC_CC}
###AG_GG
library(RColorBrewer)
AG_GG1<-df7[which(df7$subtype %in% c("AG","GG")),-c(2:12)]
AG_GG2<-AG_GG1[,-1]
row.names(AG_GG2)<-AG_GG1$batch
AG_GG2[is.na(AG_GG2)]<-NA
AG_GG3<-log2(AG_GG2[,-1])
AG_GG3$DiseaseType<-AG_GG2$subtype
library(ggplot2)
library(readxl)
library(ggpubr)
data<-AG_GG3

for (i in 1:c(ncol(data)-1)) {
 p <- ggplot(data, aes(x=DiseaseType, y=data[,i],color=DiseaseType)) +ylab("Log2(protein abundance)")+ ggtitle(paste0(names(data)[i]))+
  geom_boxplot( na.rm = T,outlier.shape = NA)+geom_jitter(shape=16, position=position_jitter(0.2))+
   scale_color_manual(values=c("#80AA31","#D9942C"))

  my_comparisons <- list(c("AG", "GG"))
  
  
  q <- p+stat_compare_means(method = "t.test",comparisons = my_comparisons)+
   
theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 15,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())+
            theme(axis.text = element_text(size = 30,color = "black"))+
  
            theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
            theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+
            theme(axis.title.y=element_text(size=30, hjust=0.5, color="black"))
  
  
  
  ggsave(filename  = paste0("boxplot/AG_GG/AG_GG_",names(data)[i],".pdf"),plot=q,device = NULL,width = 6,height = 6)
  
}


###BC_CC
library(RColorBrewer)
BC_CC1<-df7[which(df7$subtype %in% c("BC","CC")),-c(2:12)]
BC_CC2<-BC_CC1[,-1]
row.names(BC_CC2)<-BC_CC1$batch
BC_CC2[is.na(BC_CC2)]<-NA
BC_CC3<-log2(BC_CC2[,-1])
BC_CC3$DiseaseType<-BC_CC2$subtype
library(ggplot2)
library(readxl)
library(ggpubr)
data<-BC_CC3

for (i in 1:c(ncol(data)-1)) {
 p <- ggplot(data, aes(x=DiseaseType, y=data[,i],color=DiseaseType)) +ylab("Log2(protein abundance)")+ ggtitle(paste0(names(data)[i]))+
  geom_boxplot( na.rm = T,outlier.shape = NA)+geom_jitter(shape=16, position=position_jitter(0.2))+
   scale_color_manual(values=c("#80AA31","#D9942C"))

  my_comparisons <- list(c("BC", "CC"))
  
  
  q <- p+stat_compare_means(method = "t.test",comparisons = my_comparisons)+
   
theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 15,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())+
            theme(axis.text = element_text(size = 30,color = "black"))+
  
            theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
            theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+
            theme(axis.title.y=element_text(size=30, hjust=0.5, color="black"))
  
  
  
  ggsave(filename  = paste0("boxplot/BC_CC/BC_CC_",names(data)[i],".pdf"),plot=q,device = NULL,width = 6,height = 6)
  
}

```

```{r volcanol for GSEA}
###BC_CC
library(RColorBrewer)
BC_CC1<-df7[which(df7$subtype %in% c("BC","CC")),-c(2:11)]
BC_CC2<-BC_CC1[,-1]
row.names(BC_CC2)<-BC_CC1$batch
BC_CC2[is.na(BC_CC2)]<-NA
write.csv(BC_CC2,"all_BC_CC_gsea.csv")

####NA 小于70%
BC_CC3<-BC_CC2[, apply(BC_CC2,2,function(x) {sum(is.na(x))/nrow(BC_CC2)}) < 1]
### volcano
BC_CC3[is.na(BC_CC3)]<-NA
fd <- data.frame(apply(BC_CC3[,-1],2, function(x) log2((mean(na.omit(x[which(BC_CC3$subtype=="BC")]))/mean(na.omit(x[which(BC_CC3$subtype=="CC")]))))))

BC_CC4<-BC_CC3
BC_CC4[is.na(BC_CC4)]<-0
pvalue<- data.frame(apply(BC_CC4[,-1],2, function(x)  t.test(x[which(BC_CC4$subtype=="BC")],x[which(BC_CC3$subtype=="CC")], paired = F, var.equal = F)$p.value ))

vol<-cbind(fd,pvalue)
names(vol)<-c("fd","P_value")

BC_CC<-data.frame(t(rbind(BC_CC3[,-1],t(vol))))
BC_CC$P_value_adjust<-p.adjust(BC_CC$P_value, method="BH")

write.csv(BC_CC,file = "BC_CC_all.csv")

 

###AG_GG
library(RColorBrewer)
AG_GG1<-df7[which(df7$subtype %in% c("AG","GG")),-c(2:11)]
AG_GG2<-AG_GG1[,-c(1:2)]
row.names(AG_GG2)<-AG_GG1$batch

AG_GG2[is.na(AG_GG2)]<-NA

write.csv(AG_GG2,"20200425all_AG_GG_gsea.csv")

####NA less 70%
AG_GG3<-AG_GG2[, apply(AG_GG2,2,function(x) {sum(is.na(x))/nrow(AG_GG2)}) < 1]
### volcano
AG_GG3[is.na(AG_GG3)]<-NA
fd <- data.frame(apply(AG_GG3[,-1],2, function(x) log2((mean(na.omit(x[which(AG_GG3$subtype=="AG")]))/mean(na.omit(x[which(AG_GG3$subtype=="GG")]))))))

AG_GG4<-AG_GG3
AG_GG4[is.na(AG_GG4)]<-0
pvalue<- data.frame(apply(AG_GG4[,-1],2, function(x)  t.test(x[which(AG_GG4$subtype=="AG")],x[which(AG_GG3$subtype=="GG")], paired = F, var.equal = F)$p.value ))

vol<-cbind(fd,pvalue)
names(vol)<-c("fd","P_value")

AG_GG<-data.frame(t(rbind(AG_GG3[,-1],t(vol))))
AG_GG$P_value_adjust<-p.adjust(AG_GG$P_value, method="BH")


write.csv(AG_GG,file = "20210425AG_GG_all.csv")


```

```{r prepare matrix for feature selection }
rm(list=ls())
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)

info<-read_excel("name.xlsx",sheet = 1)
info<-info[-grep("A20", info$sampleID),]

info$subtype<-paste0(info$PType,info$Location)
df<-read.table("diann_KRUK_protein_20200828.txt",sep = "\t",stringsAsFactors = F,header = T)

AG_GG_up<-read.csv("AG_GG_up.csv")
AG_GG_down<-read.csv("AG_GG_down.csv")
AG_GG<-rbind(AG_GG_up,AG_GG_down)
AG_GG2<-AG_GG[,-c(1,97:99)]
row.names(AG_GG2)<-AG_GG$X
AG_GG3<-data.frame(t(AG_GG2))
AG_GG3$batch<-row.names(AG_GG3)
AG_GG4<-merge(info,AG_GG3,by.x="batch",all=F)
AG_GG5<-AG_GG4[AG_GG4$subtype %in% c("AG","GG"),]
AG_GG6<-aggregate(AG_GG5[,-c(1:13)],  by=list(AG_GG5$pathology),  mean,na.rm=T)
names(AG_GG6)<-c("pathology",names(AG_GG6[,-1]))
AG_GG7<-merge(data.frame(unique(AG_GG5[,c("pathology","subtype")])),AG_GG6,by.x ="pathology",all.Y=F)
AG_GG8<-AG_GG7[,-1]
row.names(AG_GG8)<-AG_GG7$pathology
# AG_GG9<-data.frame(AG_GG8[,1],log2(AG_GG8[,-1]))
AG_GG9<-AG_GG8
names(AG_GG9)<-c("label",names(AG_GG9[,-1]))#####AG_GG9 is the training matrix

BC_CC_up<-read.csv("BC_CC_up.csv")
BC_CC_down<-read.csv("BC_CC_down.csv")
BC_CC<-rbind(BC_CC_up,BC_CC_down)
BC_CC2<-BC_CC[,-c(1,101:103)]
row.names(BC_CC2)<-BC_CC$X
BC_CC3<-data.frame(t(BC_CC2))
BC_CC3$batch<-row.names(BC_CC3)
BC_CC4<-merge(info,BC_CC3,by.x="batch",all=F)
BC_CC5<-BC_CC4[BC_CC4$subtype %in% c("BC","CC"),]
BC_CC6<-aggregate(BC_CC5[,-c(1:13)],  by=list(BC_CC5$pathology),  mean,na.rm=T)
names(BC_CC6)<-c("pathology",names(BC_CC6[,-1]))
BC_CC7<-merge(data.frame(unique(BC_CC5[,c("pathology","subtype")])),BC_CC6,by.x ="pathology",all.Y=F)
BC_CC8<-BC_CC7[,-1]
row.names(BC_CC8)<-BC_CC7$pathology
# BC_CC9<-data.frame(BC_CC8[,1],log2(BC_CC8[,-1]))
BC_CC9<-BC_CC8
names(BC_CC9)<-c("label",names(BC_CC9[,-1]))#####BC_CC9 is the training matrix
```

```{r AG_GG_BC_CC_prepare matrix for feature DIA data selection  }
rm(list=ls())
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)

info<-read_excel("name.xlsx",sheet = 1)
info<-info[-grep("A20", info$sampleID),]

info$subtype<-paste0(info$PType,info$Location)
df<-read.table("E:/Qsync/work/zheyi_luanchaoai/KTiscience-yixiao20240131/matrix/diann_KRUK_protein_20200828.txt",sep = "\t",stringsAsFactors = F,header = T)

AG_GG_up<-read.csv("volcano/AG_GG_up.csv")
AG_GG_down<-read.csv("volcano/AG_GG_down.csv")
AG_GG<-rbind(AG_GG_up,AG_GG_down)
AG_GG2<-AG_GG[,-c(1,93:95)]
row.names(AG_GG2)<-AG_GG$X
AG_GG2$intensity<-(apply(AG_GG2,1,sum))
AG_GG2.5<-data.frame(AG_GG2[AG_GG2$intensity >0,-97])

AG_GG3<-data.frame(t(AG_GG2.5))
AG_GG3$batch<-row.names(AG_GG3)
AG_GG4<-merge(info,AG_GG3,by.x="batch",all=F)
AG_GG5<-AG_GG4[AG_GG4$subtype %in% c("AG","GG"),]
AG_GG6<-aggregate(AG_GG5[,-c(1:13)],  by=list(AG_GG5$pathology),  mean,na.rm=T)
names(AG_GG6)<-c("pathology",names(AG_GG6[,-1]))
AG_GG7<-merge(data.frame(unique(AG_GG5[,c("pathology","subtype")])),AG_GG6,by.x ="pathology",all.Y=F)
AG_GG8<-AG_GG7[,-1]
row.names(AG_GG8)<-AG_GG7$pathology
AG_GG9<-data.frame(AG_GG8[,1],(AG_GG8[,-1]))
names(AG_GG9)<-c("label",names(AG_GG9[,-1]))#####AG_GG9 is the training matrix

BC_CC_up<-read.csv("volcano/BC_CC_up.csv")
BC_CC_down<-read.csv("volcano/BC_CC_down.csv")
BC_CC<-rbind(BC_CC_up,BC_CC_down)
BC_CC2<-BC_CC[,-c(1,96:98)]
row.names(BC_CC2)<-BC_CC$X
BC_CC3<-data.frame(t(BC_CC2))
BC_CC3$batch<-row.names(BC_CC3)
BC_CC4<-merge(info,BC_CC3,by.x="batch",all=F)
BC_CC5<-BC_CC4[BC_CC4$subtype %in% c("BC","CC"),]
BC_CC6<-aggregate(BC_CC5[,-c(1:13)],  by=list(BC_CC5$pathology),  mean,na.rm=T)
names(BC_CC6)<-c("pathology",names(BC_CC6[,-1]))
BC_CC7<-merge(data.frame(unique(BC_CC5[,c("pathology","subtype")])),BC_CC6,by.x ="pathology",all.Y=F)
BC_CC8<-BC_CC7[,-1]
row.names(BC_CC8)<-BC_CC7$pathology
BC_CC9<-data.frame(BC_CC8[,1],(BC_CC8[,-1]))
names(BC_CC9)<-c("label",names(BC_CC9[,-1]))#####BC_CC9 is the training matrix

```

```{r  prepare AG-GG DIA matrix for validation }
AGGG_valid<-df<-read.table("E:/Qsync/work/zheyi_luanchaoai/KTiscience-yixiao20240131/matrix/DIA_validation/20211019KRUK_A_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
library(stringr)
AGGG_sampleName<-data.frame(str_split_fixed(c(names(AGGG_valid)),pattern = "_",10))
AGGG_portName<-data.frame(str_split_fixed(c(names(AG_GG9)),pattern = "_",2))
names(AGGG_portName)<-c("prot","gene")
AGGG_valid2<-AGGG_valid[which(AGGG_valid$prot %in% AGGG_portName$prot),]
AGGG_valid3<-merge(AGGG_portName,AGGG_valid2,by.x = "prot", all=F)
AGGG_valid4<-AGGG_valid3[,-c(1:2)]
row.names(AGGG_valid4)<-paste0(AGGG_valid3$prot,"_",AGGG_valid3$gene)
AGGG_valid5<-data.frame(t(AGGG_valid4))
AG_valid<-AGGG_valid5[grep("AG",row.names(AGGG_valid5)),]
GG_valid<-AGGG_valid5[grep("GG",row.names(AGGG_valid5)),]
AGGG_valid6<-data.frame(rbind(AG_valid, GG_valid))
AGGG_sampleName<-data.frame(str_split_fixed(c(row.names(AGGG_valid6)),pattern = "_",10))
AGGG_sampleName2<-gsub("_rep","",AGGG_sampleName[,10])
AGGG_valid7<-aggregate(AGGG_valid6, by=list(AGGG_sampleName2), mean, na.rm=T)
AGGG_valid8<-AGGG_valid7[,-1]
AGGG_valid9<-log2(AGGG_valid8)
AGGG_valid9[is.na(AGGG_valid9)]<-0
row.names(AGGG_valid9)<-AGGG_valid7$Group.1
 ##AGGG_valid9 is test matrix


```

```{r  prepare BC-CC DIA matrix for validation }


```


```{r DIA validation for BC_CC}
set.seed(2020)
BC_CC10<-data.frame(apply(BC_CC9[,-1],2, function(v){min(v,na.rm=T)}))
BC_CC11<-data.frame(BC_CC9[,-1])
BC_CC11<-BC_CC11[,-1]
# BC_CC11<-c()
for(i in 2:ncol(BC_CC9)){
BC_CC10<-data.frame(BC_CC9[,i])
 names(BC_CC10)<-names(BC_CC9)[i]
 BC_CC10[is.na(BC_CC10)]<-min(BC_CC10,na.rm = T)
 BC_CC11<-cbind(BC_CC11,BC_CC10)
}
row.names(BC_CC11)<-row.names(BC_CC9)
BC_CC11$label<-BC_CC9$label
tmpRF_BC_CC <- randomForest(as.factor(label) ~ . ,data=BC_CC11,importance=T,ntree=5000,nodesize=1)
result_BC_CC <- data.frame(importance(tmpRF_BC_CC,type=1))
plot(tmpRF_BC_CC)
pdf("varImpPlot_BC_CC_20220406_1.pdf")
varImpPlot(tmpRF_BC_CC)
dev.off()

feature <- data.frame(row.names(result_BC_CC)[result_BC_CC$MeanDecreaseAccuracy>7.3])
names(feature)<-"venn.X"
##prepare trains
trainsModel<- BC_CC11[,names(BC_CC11) %in% feature$venn.X]
# trainsModel<-data.frame((apply(trainsModel,2,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trainsModel$label<-BC_CC9$label
################
BCCC_valid<-df<-read.table("DIA_validation/202101022KRUK_B_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
library(stringr)
BCCC_sampleName<-data.frame(str_split_fixed(c(names(BCCC_valid)),pattern = "_",10))
BCCC_portName<-data.frame(str_split_fixed(c(names(BC_CC9)),pattern = "_",2))
names(BCCC_portName)<-c("prot","gene")
BCCC_valid2<-BCCC_valid[which(BCCC_valid$prot %in% BCCC_portName$prot),]
BCCC_valid3<-merge(BCCC_portName,BCCC_valid2,by.x = "prot", all=F)
BCCC_valid4<-BCCC_valid3[,-c(1:2)]
row.names(BCCC_valid4)<-paste0(BCCC_valid3$prot)
BCCC_valid5<-data.frame(t(BCCC_valid4))
BC_valid<-BCCC_valid5[grep("_BC",row.names(BCCC_valid5)),]
CC_valid<-BCCC_valid5[grep("_CC",row.names(BCCC_valid5)),]
BCCC_valid6<-data.frame(rbind(BC_valid, CC_valid))
BCCC_sampleName<-data.frame(str_split_fixed(c(row.names(BCCC_valid6)),pattern = "_",10))
BCCC_sampleName2<-gsub("_rep","",BCCC_sampleName[,10])
BCCC_valid7<-aggregate(BCCC_valid6, by=list(BCCC_sampleName2), mean, na.rm=T)
BCCC_valid8<-BCCC_valid7[,-1]
BCCC_valid9<-log2(BCCC_valid8)
BCCC_valid9[is.na(BCCC_valid9)]<-0
row.names(BCCC_valid9)<-BCCC_valid7$Group.1




##############
##prepare valids
validsModel<-BCCC_valid9
# validsModel<-data.frame((apply(BCCC_valid9,2,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
validsModel$label<-gsub("[0-9]|.raw","",row.names(BCCC_valid9))

prot_list<-data.frame(names(BC_CC9)[2:ncol(BC_CC9)])
names(prot_list)<-"prot_gene"
prot_list$prot<-sapply(strsplit(prot_list$prot_gene,"_"),function(e){e[1]})
prot_list$gene<-sapply(strsplit(prot_list$prot_gene,"_"),function(e){e[2]})
names(validsModel)<-prot_list$prot_gene[match(names(validsModel),prot_list$prot)]
names(validsModel)[ncol(validsModel)]<-"label"
## feature select and build model
accu <- c()
for (i in 2:5) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1:ncol(feature2)) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)

trains <- data.frame(trainsModel[,result1])
trains$label<-trainsModel$label

valids <- data.frame(validsModel[,result1])
valids$label <- validsModel$label
set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)

  predicts<- data.frame(predict(tmpRF,valids,type='prob'))
  predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
  predicts$observed <- valids$label
  ROC <- roc(predicts$observed, as.numeric(predicts$BC))
  auc <- as.numeric(ROC[["auc"]])
  acc <- sum(predicts$predicted==predicts$observed)
  sum<-c(i,m, c(acc/53,auc))
  accu <- data.frame(rbind(accu,sum))
 }
  }
write.csv(accu,"20250429_ktcc_train_auc.csv")
##best feature i=5 m=33
accu <- c()
for (i in 5) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 33) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
trains <- data.frame(trainsModel[,result1])

trains$label<-trainsModel$label
valids <- data.frame(validsModel[,result1])

valids$label <- validsModel$label
set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=TRUE)
    	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$BC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/53,auc))
         accu <- data.frame(rbind(accu,sum))
 }
  }


###model visualization  ###"P01042_KNG1" "P02763_ORM1" "P51884_LUM" 
set.seed(2021)
source("common_change_label.R")
color<-c("red","blue")
train<-drawPCA(trains,ptColors = color,F,F)
row.names(valids)<-gsub(".raw","",row.names(valids))

valid<-drawPCA(valids,ptColors = color,F,F, strTitle = paste0(names(trains)[1:5] ))

ggsave("BC_CC_DIA_valid_Pca.pdf", plot = valid, device = NULL)

##roc
pdf("BC_CC_DIA_valid_ROC_diffprot.pdf")
plot(ROC,cor="blue",main= auc)
dev.off()

##point plot
mean <- apply( valids[,-4],1,median)
data <- data.frame(mean,predicts=predicts$CC,sample2=row.names(predicts),type2=predicts$observed )
data$sample2<-gsub("[0-9]","",data$sample2)

ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
  a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
    geom_point()+geom_vline(xintercept = 0.35 ,linetype="dotted")+
    ggtitle(paste0(title,"_pointplot"))+
    xlab(xlab)+
    ylab(ylab)+
    xlim(0,1)+
    theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
          legend.title = element_text(size=15,color="black") ,
          panel.grid.major =element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"))+
    scale_color_manual(values=c("#FDB462","#BC80BD"))+
    theme(panel.grid =element_blank())+
    theme(axis.text = element_text(size = 10,color = "black"))+
    theme(axis.text.x = element_text( hjust = 0.5))+
    theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
    theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
    theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
  ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
}

ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/BC_CC_DIA_valid_PointPlot","predict value","median")
```



```{r  Boxplot for DIA validation data AG_GG  BC_CC}
rm(list=ls())
library(ggplot2)
library(readxl)
library(ggpubr)
source("datamining_library_ge20200902.R")
AGGG_valid<-read.table("matrix/DIA_validation/20211019KRUK_A_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
library(stringr)
MRM_prot<-read.csv("matrix/MRM_validation/KRUK_AG_GG_MRM_matrix.csv")
MRM_prot2<-data.frame(str_split_fixed(MRM_prot$Protein,"_",2))
MRM_prot2$protein<-MRM_prot$Protein
names(MRM_prot2)<-c("prot","gene","protein")
AGGG_valid2<-merge(MRM_prot2,AGGG_valid,by="prot", all=F)
AGGG_valid3<-data.frame(unique(AGGG_valid2))
AGGG_valid4<-AGGG_valid3[,-c(1:3)]
row.names(AGGG_valid4)<-AGGG_valid3$protein
AGGG_valid5<-data.frame(t(log2(AGGG_valid4)))
AGGG_valid5_AG<-AGGG_valid5[grep("AG",row.names(AGGG_valid5)),]
AGGG_valid5_AG$DiseaseType<-"AG"
AGGG_valid5_GG<-AGGG_valid5[grep("GG",row.names(AGGG_valid5)),]
AGGG_valid5_GG$DiseaseType<-"GG"
AGGG_valid6<-rbind(AGGG_valid5_AG,AGGG_valid5_GG)
data<-AGGG_valid6

for (i in 1:c(ncol(data)-1)) {
 p <- ggplot(data, aes(x=DiseaseType, y=data[,i],color=DiseaseType)) +ylab("Log2(protein abundance)")+ ggtitle(paste0(names(data)[i]))+
  geom_boxplot( na.rm = T,outlier.shape = NA)+geom_jitter(shape=16, position=position_jitter(0.2))+
   scale_color_manual(values=c("#80AA31","#D9942C"))
 my_comparisons <- list(c("AG", "GG"))
 q <- p+stat_compare_means(method = "t.test",comparisons = my_comparisons)+
   theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 15,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())+
            theme(axis.text = element_text(size = 30,color = "black"))+
  
            theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
            theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+
            theme(axis.title.y=element_text(size=30, hjust=0.5, color="black"))
  
  
  
  ggsave(filename  = paste0("boxplot/AG_GG_DIA_validation/AG_GG_DIA_validation",names(data)[i],".pdf"),plot=q,device = NULL,width = 6,height = 6)
  
}

rm(list=ls())
library(ggplot2)
library(readxl)
library(ggpubr)
source("datamining_library_ge20200902.R")
BCCC_valid<-read.table("matrix/DIA_validation/202101022KRUK_B_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
library(stringr)
MRM_prot<-read.csv("matrix/MRM_validation/KRUK_BC_CC_MRM_matrix.csv")
MRM_prot2<-data.frame(str_split_fixed(MRM_prot$Protein,"_",2))
MRM_prot2$protein<-MRM_prot$Protein
names(MRM_prot2)<-c("prot","gene","protein")
BCCC_valid2<-merge(MRM_prot2,BCCC_valid,by="prot", all=F)
BCCC_valid3<-data.frame(unique(BCCC_valid2))
BCCC_valid4<-BCCC_valid3[,-c(1:3)]
row.names(BCCC_valid4)<-BCCC_valid3$protein
BCCC_valid5<-data.frame(t(log2(BCCC_valid4)))
BCCC_valid5_BC<-BCCC_valid5[grep("_BC",row.names(BCCC_valid5)),]
BCCC_valid5_BC$DiseaseType<-"BC"
BCCC_valid5_CC<-BCCC_valid5[grep("_CC",row.names(BCCC_valid5)),]
BCCC_valid5_CC$DiseaseType<-"CC"
BCCC_valid6<-rbind(BCCC_valid5_BC,BCCC_valid5_CC)
data<-BCCC_valid6

for (i in 1:c(ncol(data)-1)) {
 p <- ggplot(data, aes(x=DiseaseType, y=data[,i],color=DiseaseType)) +ylab("Log2(protein abundance)")+ ggtitle(paste0(names(data)[i]))+
  geom_boxplot( na.rm = T,outlier.shape = NA)+geom_jitter(shape=16, position=position_jitter(0.2))+
   scale_color_manual(values=c("#80AA31","#D9942C"))
 my_comparisons <- list(c("BC", "CC"))
 q <- p+stat_compare_means(method = "t.test",comparisons = my_comparisons)+
   theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 15,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())+
            theme(axis.text = element_text(size = 30,color = "black"))+
  
            theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
            theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+
            theme(axis.title.y=element_text(size=30, hjust=0.5, color="black"))
  
  
  
  ggsave(filename  = paste0("boxplot/BC_CC_DIA_validation/BC_CC_DIA_validation",names(data)[i],".pdf"),plot=q,device = NULL,width = 6,height = 6)
  
}


```

```{r  Boxplot for MRM validation data AG_GG  BC_CC}
rm(list=ls())
library(ggplot2)
library(readxl)
library(ggpubr)
source("datamining_library_ge20200902.R")
AG_GG_MRM<-read.csv("matrix/MRM_validation/KRUK_AG_GG_MRM_matrix.csv")
AG_GG_MRM1<-AG_GG_MRM[,-c(1:4)]
row.names(AG_GG_MRM1)<-paste0(AG_GG_MRM$Protein,"_",AG_GG_MRM$Peptide)

AG_GG_MRM1.5<-data.frame(t(AG_GG_MRM1))
AG_GG_MRM2<-log2(AG_GG_MRM1.5)
AG_GG_MRM_AG<-AG_GG_MRM2[grep("AG",row.names(AG_GG_MRM2)),]
AG_GG_MRM_AG$DiseaseType<-"AG"
AG_GG_MRM_GG<-AG_GG_MRM2[grep("GG",row.names(AG_GG_MRM2)),]
AG_GG_MRM_GG$DiseaseType<-"GG"
AG_GG_MRM3<-rbind(AG_GG_MRM_AG,AG_GG_MRM_GG)
data<-AG_GG_MRM3

for (i in 1:c(ncol(data)-1)) {
 p <- ggplot(data, aes(x=DiseaseType, y=data[,i],color=DiseaseType)) +ylab("Log2(protein abundance)")+ ggtitle(paste0(names(data)[i]))+
  geom_boxplot( na.rm = T,outlier.shape = NA)+geom_jitter(shape=16, position=position_jitter(0.2))+
   scale_color_manual(values=c("#80AA31","#D9942C"))
 my_comparisons <- list(c("AG", "GG"))
 q <- p+stat_compare_means(method = "t.test",comparisons = my_comparisons)+
   theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 15,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())+
            theme(axis.text = element_text(size = 30,color = "black"))+
  
            theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
            theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+
            theme(axis.title.y=element_text(size=30, hjust=0.5, color="black"))
  
  
  
  ggsave(filename  = paste0("boxplot/MRM_boxplot/Peptide/AG_GG_MRM",names(data)[i],".pdf"),plot=q,device = NULL,width = 6,height = 6)
  
}

rm(list=ls())
library(ggplot2)
library(readxl)
library(ggpubr)
source("datamining_library_ge20200902.R")
BC_CC_MRM<-read.csv("matrix/MRM_validation/KRUK_BC_CC_MRM_matrix.csv")
BC_CC_MRM1<-BC_CC_MRM[,-c(1:4)]
row.names(BC_CC_MRM1)<-paste0(BC_CC_MRM$Protein,"_",BC_CC_MRM$Peptide)

BC_CC_MRM1.5<-data.frame(t(BC_CC_MRM1))
BC_CC_MRM2<-log2(BC_CC_MRM1.5)
BC_CC_MRM_BC<-BC_CC_MRM2[grep("BC",row.names(BC_CC_MRM2)),]
BC_CC_MRM_BC$DiseaseType<-"BC"
BC_CC_MRM_CC<-BC_CC_MRM2[grep("CC",row.names(BC_CC_MRM2)),]
BC_CC_MRM_CC$DiseaseType<-"CC"
BC_CC_MRM3<-rbind(BC_CC_MRM_BC,BC_CC_MRM_CC)
data<-BC_CC_MRM3

for (i in 1:c(ncol(data)-1)) {
 p <- ggplot(data, aes(x=DiseaseType, y=data[,i],color=DiseaseType)) +ylab("Log2(protein abundance)")+ ggtitle(paste0(names(data)[i]))+
  geom_boxplot( na.rm = T,outlier.shape = NA)+geom_jitter(shape=16, position=position_jitter(0.2))+
   scale_color_manual(values=c("#80AA31","#D9942C"))
 my_comparisons <- list(c("BC", "CC"))
 q <- p+stat_compare_means(method = "t.test",comparisons = my_comparisons)+
   theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 15,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())+
            theme(axis.text = element_text(size = 30,color = "black"))+
  
            theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
            theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+
            theme(axis.title.y=element_text(size=30, hjust=0.5, color="black"))
  
  
  
  ggsave(filename  = paste0("boxplot/MRM_boxplot/Peptide/BC_CC/BC_CC_MRM",names(data)[i],".pdf"),plot=q,device = NULL,width = 6,height = 6)
  
}

```

```{r  volcanoplot for AG_GG BC_CC DIA validation }
library(RColorBrewer)
AGGG_valid_volcano<-df<-read.table("DIA_validation/20211019KRUK_A_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
##delete protein groups
AGGG_valid_volcano1<-AGGG_valid_volcano[-grep(";", AGGG_valid_volcano$prot),]
AGGG_valid_volcano2<-data.frame(t(AGGG_valid_volcano1[,-1]))
names(AGGG_valid_volcano2)<-AGGG_valid_volcano1$prot
AGGG_valid_volcano2<-AGGG_valid_volcano2[grep("AG|GG",row.names(AGGG_valid_volcano2)),]

AGGG_sampleName<-data.frame(str_split_fixed(c(row.names(AGGG_valid_volcano2)),pattern = "_",10))
AGGG_sampleName2<-gsub("_rep","",AGGG_sampleName[,10])
AGGG_valid_volcano3<-aggregate(AGGG_valid_volcano2, by=list(AGGG_sampleName2), mean, na.rm=T)
AGGG_valid_volcano4<-AGGG_valid_volcano3[,-1]
row.names(AGGG_valid_volcano4)<-gsub(".raw", "", AGGG_valid_volcano3$Group.1)
AGGG_valid_volcano5<-AGGG_valid_volcano4[, apply(AGGG_valid_volcano4,2,function(x) {sum(is.na(x))/nrow(AGGG_valid_volcano4)}) < 0.7]
AGGG_valid_volcano6<-data.frame(log2(AGGG_valid_volcano5))
AGGG_valid_volcano6[is.na(AGGG_valid_volcano6)]<-0

### volcano

fd <- data.frame(apply(2^AGGG_valid_volcano6,2, function(x) log2((mean(na.omit(x[grep("AG",row.names(AGGG_valid_volcano6) )]))/mean(na.omit(x[grep("GG",row.names(AGGG_valid_volcano6) )]))))))

pvalue<- data.frame(apply(AGGG_valid_volcano6,2, function(x)  t.test(x[grep("AG",row.names(AGGG_valid_volcano6) )],x[grep("GG",row.names(AGGG_valid_volcano6) )], paired = F, var.equal = F)$p.value ))

vol<-cbind(fd,pvalue)
names(vol)<-c("fd","P_value")

AGGG_valid_volcano7<-data.frame(t(rbind(AGGG_valid_volcano6,t(vol))))
AGGG_valid_volcano7$P_value_adjust<-p.adjust(AGGG_valid_volcano7$P_value, method="BH")

pdf("volcano/AGGG_valid_volcano.pdf",width = 6,height = 6)
plot(AGGG_valid_volcano7$fd, -log10(AGGG_valid_volcano7$P_value), col="#00000033", pch=19,cex=3,
     
      xlab=paste("log2(fold change)"),
      ylab="-log10  p value",
      main="AG_GG_DIA Valid")
# 
up <- subset(AGGG_valid_volcano7, AGGG_valid_volcano7$P_value < 0.05 & AGGG_valid_volcano7$fd > 0.5)
down <- subset(AGGG_valid_volcano7, AGGG_valid_volcano7$P_value< 0.05 & AGGG_valid_volcano7$fd< -0.5)

write.csv(up,file = "volcano/AGGG_valid_volcano_up.csv")
write.csv(down,file = "volcano/AGGG_valid_volcano_down.csv")


  # 
points(up$fd, -log10(up$P_value), col=1, bg = brewer.pal(9, "YlOrRd")[6], pch=21, cex=3)
points(down$fd, -log10(down$P_value), col = 1,  bg = brewer.pal(11, "RdBu")[9], pch = 21,cex=3)
  #
abline(h=1.3,v=c(-0.5,0.5),lty=2,lwd=1)

#}
dev.off()


###BC_CC

library(RColorBrewer)
library(stringr)
BCCC_valid_volcano<-df<-read.table("matrix/DIA_validation/202101022KRUK_B_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
##delete protein groups
BCCC_valid_volcano1<-BCCC_valid_volcano[-grep(";", BCCC_valid_volcano$prot),]
BCCC_valid_volcano2<-data.frame(t(BCCC_valid_volcano1[,-1]))
names(BCCC_valid_volcano2)<-BCCC_valid_volcano1$prot
BCCC_valid_volcano2<-BCCC_valid_volcano2[grep("_BC|_CC",row.names(BCCC_valid_volcano2)),]

BCCC_sampleName<-data.frame(str_split_fixed(c(row.names(BCCC_valid_volcano2)),pattern = "_",10))
BCCC_sampleName2<-gsub("_rep","",BCCC_sampleName[,10])
BCCC_valid_volcano3<-aggregate(BCCC_valid_volcano2, by=list(BCCC_sampleName2), mean, na.rm=T)
BCCC_valid_volcano4<-BCCC_valid_volcano3[,-1]
row.names(BCCC_valid_volcano4)<-gsub(".raw", "", BCCC_valid_volcano3$Group.1)
BCCC_valid_volcano5<-BCCC_valid_volcano4[, apply(BCCC_valid_volcano4,2,function(x) {sum(is.na(x))/nrow(BCCC_valid_volcano4)}) < 0.7]
BCCC_valid_volcano6<-data.frame(log2(BCCC_valid_volcano5))
BCCC_valid_volcano6[is.na(BCCC_valid_volcano6)]<-0

### volcano

fd <- data.frame(apply(2^BCCC_valid_volcano6,2, function(x) log2((mean(na.omit(x[grep("BC",row.names(BCCC_valid_volcano6) )]))/mean(na.omit(x[grep("CC",row.names(BCCC_valid_volcano6) )]))))))

pvalue<- data.frame(apply(BCCC_valid_volcano6,2, function(x)  t.test(x[grep("BC",row.names(BCCC_valid_volcano6) )],x[grep("CC",row.names(BCCC_valid_volcano6) )], paired = F, var.equal = F)$p.value ))

vol<-cbind(fd,pvalue)
names(vol)<-c("fd","P_value")

BCCC_valid_volcano7<-data.frame(t(rbind(BCCC_valid_volcano6,t(vol))))
BCCC_valid_volcano7$P_value_adjust<-p.adjust(BCCC_valid_volcano7$P_value, method="BH")

pdf("volcano/BCCC_valid_volcano_noadjust.pdf",width = 6,height = 6)
plot(BCCC_valid_volcano7$fd, -log10(BCCC_valid_volcano7$P_value), col="#00000033", pch=19,cex=3,
     
      xlab=paste("log2(fold change)"),
      ylab="-log10  p value",
      main="BC_CC_DIA Valid")
# 
up <- subset(BCCC_valid_volcano7, BCCC_valid_volcano7$P_value < 0.05 & BCCC_valid_volcano7$fd > 0.5)
down <- subset(BCCC_valid_volcano7, BCCC_valid_volcano7$P_value< 0.05 & BCCC_valid_volcano7$fd< -0.5)

write.csv(up,file = "volcano/BCCC_valid_volcano_up_noadjust.csv")
write.csv(down,file = "volcano/BCCC_valid_volcano_down_noadjust.csv")


  # 
points(up$fd, -log10(up$P_value), col=1, bg = brewer.pal(9, "YlOrRd")[6], pch=21, cex=3)
points(down$fd, -log10(down$P_value), col = 1,  bg = brewer.pal(11, "RdBu")[9], pch = 21,cex=3)
  #
abline(h=1.3,v=c(-0.5,0.5),lty=2,lwd=1)

#}
dev.off()

```


```{r  volcanoplot for AG_AN BC_BN  AN_GN BN_CN}
library(RColorBrewer)
library(stringr)
AGAN_valid_volcano<-df<-read.table("matrix/DIA_validation/20211019KRUK_A_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
##delete protein groups
AGAN_valid_volcano1<-AGAN_valid_volcano[-grep(";", AGAN_valid_volcano$prot),]
AGAN_valid_volcano2<-data.frame(t(AGAN_valid_volcano1[,-1]))
names(AGAN_valid_volcano2)<-AGAN_valid_volcano1$prot
AGAN_valid_volcano2<-AGAN_valid_volcano2[grep("AG|AN",row.names(AGAN_valid_volcano2)),]

AGAN_sampleName<-data.frame(str_split_fixed(c(row.names(AGAN_valid_volcano2)),pattern = "_",10))
AGAN_sampleName2<-gsub("_rep","",AGAN_sampleName[,10])
AGAN_valid_volcano3<-aggregate(AGAN_valid_volcano2, by=list(AGAN_sampleName2), mean, na.rm=T)
AGAN_valid_volcano4<-AGAN_valid_volcano3[,-1]
row.names(AGAN_valid_volcano4)<-gsub(".raw", "", AGAN_valid_volcano3$Group.1)
AGAN_valid_volcano5<-AGAN_valid_volcano4[, apply(AGAN_valid_volcano4,2,function(x) {sum(is.na(x))/nrow(AGAN_valid_volcano4)}) < 0.7]
AGAN_valid_volcano6<-data.frame(log2(AGAN_valid_volcano5))
AGAN_valid_volcano6[is.na(AGAN_valid_volcano6)]<-0

### volcano

fd <- data.frame(apply(2^AGAN_valid_volcano6,2, function(x) log2((mean(na.omit(x[grep("AG",row.names(AGAN_valid_volcano6) )]))/mean(na.omit(x[grep("AN",row.names(AGAN_valid_volcano6) )]))))))

pvalue<- data.frame(apply(AGAN_valid_volcano6,2, function(x)  t.test(x[grep("AG",row.names(AGAN_valid_volcano6) )],x[grep("AN",row.names(AGAN_valid_volcano6) )], paired = F, var.equal = F)$p.value ))

vol<-cbind(fd,pvalue)
names(vol)<-c("fd","P_value")

AGAN_valid_volcano7<-data.frame(t(rbind(AGAN_valid_volcano6,t(vol))))
AGAN_valid_volcano7$P_value_adjust<-p.adjust(AGAN_valid_volcano7$P_value, method="BH")

pdf("volcano/AGAN_valid_volcano.pdf",width = 6,height = 6)
plot(AGAN_valid_volcano7$fd, -log10(AGAN_valid_volcano7$P_value), col="#00000033", pch=19,cex=3,
     
      xlab=paste("log2(fold change)"),
      ylab="-log10  p value",
      main="AG_AN_DIA Valid")
# 
up <- subset(AGAN_valid_volcano7, AGAN_valid_volcano7$P_value < 0.05 & AGAN_valid_volcano7$fd > 0.5)
down <- subset(AGAN_valid_volcano7, AGAN_valid_volcano7$P_value< 0.05 & AGAN_valid_volcano7$fd< -0.5)

write.csv(up,file = "volcano/AGAN_valid_volcano_up.csv")
write.csv(down,file = "volcano/AGAN_valid_volcano_down.csv")


  # 
points(up$fd, -log10(up$P_value), col=1, bg = brewer.pal(9, "YlOrRd")[6], pch=21, cex=3)
points(down$fd, -log10(down$P_value), col = 1,  bg = brewer.pal(11, "RdBu")[9], pch = 21,cex=3)
  #
abline(h=1.3,v=c(-0.5,0.5),lty=2,lwd=1)

#}
dev.off()

##BCBN

library(RColorBrewer)
library(stringr)
BCBN_valid_volcano<-df<-read.table("matrix/DIA_validation/202101022KRUK_B_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
##delete protein groups
BCBN_valid_volcano1<-BCBN_valid_volcano[-grep(";", BCBN_valid_volcano$prot),]
BCBN_valid_volcano2<-data.frame(t(BCBN_valid_volcano1[,-1]))
names(BCBN_valid_volcano2)<-BCBN_valid_volcano1$prot
BCBN_valid_volcano2<-BCBN_valid_volcano2[grep("_BC|_BN",row.names(BCBN_valid_volcano2)),]

BCBN_sampleName<-data.frame(str_split_fixed(c(row.names(BCBN_valid_volcano2)),pattern = "_",10))
BCBN_sampleName2<-gsub("_rep","",BCBN_sampleName[,10])
BCBN_valid_volcano3<-aggregate(BCBN_valid_volcano2, by=list(BCBN_sampleName2), mean, na.rm=T)
BCBN_valid_volcano4<-BCBN_valid_volcano3[,-1]
row.names(BCBN_valid_volcano4)<-gsub(".raw", "", BCBN_valid_volcano3$Group.1)
BCBN_valid_volcano5<-BCBN_valid_volcano4[, apply(BCBN_valid_volcano4,2,function(x) {sum(is.na(x))/nrow(BCBN_valid_volcano4)}) < 0.7]
BCBN_valid_volcano6<-data.frame(log2(BCBN_valid_volcano5))
BCBN_valid_volcano6[is.na(BCBN_valid_volcano6)]<-0

### volcano

fd <- data.frame(apply(2^BCBN_valid_volcano6,2, function(x) log2((mean(na.omit(x[grep("BC",row.names(BCBN_valid_volcano6) )]))/mean(na.omit(x[grep("BN",row.names(BCBN_valid_volcano6) )]))))))
pvalue<- data.frame(apply(BCBN_valid_volcano6,2, function(x)  t.test(x[grep("BC",row.names(BCBN_valid_volcano6) )],x[grep("BN",row.names(BCBN_valid_volcano6) )], paired = F, var.equal = F)$p.value ))
vol<-cbind(fd,pvalue)
names(vol)<-c("fd","P_value")
BCBN_valid_volcano7<-data.frame(t(rbind(BCBN_valid_volcano6,t(vol))))
BCBN_valid_volcano7$P_value_adjust<-p.adjust(BCBN_valid_volcano7$P_value, method="BH")

pdf("volcano/BCBN_valid_volcano.pdf",width = 6,height = 6)
plot(BCBN_valid_volcano7$fd, -log10(BCBN_valid_volcano7$P_value), col="#00000033", pch=19,cex=3,
     
      xlab=paste("log2(fold change)"),
      ylab="-log10  p value",
      main="BC_BN_DIA Valid")
# 
up <- subset(BCBN_valid_volcano7, BCBN_valid_volcano7$P_value < 0.05 & BCBN_valid_volcano7$fd > 0.5)
down <- subset(BCBN_valid_volcano7, BCBN_valid_volcano7$P_value< 0.05 & BCBN_valid_volcano7$fd< -0.5)

  write.csv(up,file = "volcano/BCBN_valid_volcano_up.csv")
write.csv(down,file = "volcano/BCBN_valid_volcano_down.csv")
# 
points(up$fd, -log10(up$P_value), col=1, bg = brewer.pal(9, "YlOrRd")[6], pch=21, cex=3)
points(down$fd, -log10(down$P_value), col = 1,  bg = brewer.pal(11, "RdBu")[9], pch = 21,cex=3)
  #
abline(h=1.3,v=c(-0.5,0.5),lty=2,lwd=1)
#}
dev.off()

 
### AN_GN

library(RColorBrewer)
library(stringr)
ANGN_valid_volcano<-df<-read.table("matrix/DIA_validation/20211019KRUK_A_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
##delete protein groups
ANGN_valid_volcano1<-ANGN_valid_volcano[-grep(";", ANGN_valid_volcano$prot),]
ANGN_valid_volcano2<-data.frame(t(ANGN_valid_volcano1[,-1]))
names(ANGN_valid_volcano2)<-ANGN_valid_volcano1$prot
ANGN_valid_volcano2<-ANGN_valid_volcano2[grep("AN|GN",row.names(ANGN_valid_volcano2)),]

ANGN_sampleName<-data.frame(str_split_fixed(c(row.names(ANGN_valid_volcano2)),pattern = "_",10))
ANGN_sampleName2<-gsub("_rep","",ANGN_sampleName[,10])
ANGN_valid_volcano3<-aggregate(ANGN_valid_volcano2, by=list(ANGN_sampleName2), mean, na.rm=T)
ANGN_valid_volcano4<-ANGN_valid_volcano3[,-1]
row.names(ANGN_valid_volcano4)<-gsub(".raw", "", ANGN_valid_volcano3$Group.1)
ANGN_valid_volcano5<-ANGN_valid_volcano4[, apply(ANGN_valid_volcano4,2,function(x) {sum(is.na(x))/nrow(ANGN_valid_volcano4)}) < 0.7]
ANGN_valid_volcano6<-data.frame(log2(ANGN_valid_volcano5))
ANGN_valid_volcano6[is.na(ANGN_valid_volcano6)]<-0

### volcano

fd <- data.frame(apply(2^ANGN_valid_volcano6,2, function(x) log2((mean(na.omit(x[grep("AN",row.names(ANGN_valid_volcano6) )]))/mean(na.omit(x[grep("GN",row.names(ANGN_valid_volcano6) )]))))))

pvalue<- data.frame(apply(ANGN_valid_volcano6,2, function(x)  t.test(x[grep("AN",row.names(ANGN_valid_volcano6) )],x[grep("GN",row.names(ANGN_valid_volcano6) )], paired = F, var.equal = F)$p.value ))

vol<-cbind(fd,pvalue)
names(vol)<-c("fd","P_value")

ANGN_valid_volcano7<-data.frame(t(rbind(ANGN_valid_volcano6,t(vol))))
ANGN_valid_volcano7$P_value_adjust<-p.adjust(ANGN_valid_volcano7$P_value, method="BH")

pdf("volcano/ANGN_valid_volcano.pdf",width = 6,height = 6)
plot(ANGN_valid_volcano7$fd, -log10(ANGN_valid_volcano7$P_value), col="#00000033", pch=19,cex=3,
     
      xlab=paste("log2(fold change)"),
      ylab="-log10 p value",
      main="AN_GN_DIA Valid")
# 
up <- subset(ANGN_valid_volcano7, ANGN_valid_volcano7$P_value < 0.05 & ANGN_valid_volcano7$fd > 0.5)
down <- subset(ANGN_valid_volcano7, ANGN_valid_volcano7$P_value< 0.05 & ANGN_valid_volcano7$fd< -0.5)

write.csv(up,file = "volcano/ANGN_valid_volcano_up.csv")
write.csv(down,file = "volcano/ANGN_valid_volcano_down.csv")


  # 
points(up$fd, -log10(up$P_value), col=1, bg = brewer.pal(9, "YlOrRd")[6], pch=21, cex=3)
points(down$fd, -log10(down$P_value), col = 1,  bg = brewer.pal(11, "RdBu")[9], pch = 21,cex=3)
  #
abline(h=1.3,v=c(-0.5,0.5),lty=2,lwd=1)

#}
dev.off()


### BN_CN

library(RColorBrewer)
library(stringr)
BNCN_valid_volcano<-df<-read.table("matrix/DIA_validation/202101022KRUK_B_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
##delete protein groups
BNCN_valid_volcano1<-BNCN_valid_volcano[-grep(";", BNCN_valid_volcano$prot),]
BNCN_valid_volcano2<-data.frame(t(BNCN_valid_volcano1[,-1]))
names(BNCN_valid_volcano2)<-BNCN_valid_volcano1$prot
BNCN_valid_volcano2<-BNCN_valid_volcano2[grep("BN|CN",row.names(BNCN_valid_volcano2)),]

BNCN_sampleName<-data.frame(str_split_fixed(c(row.names(BNCN_valid_volcano2)),pattern = "_",10))
BNCN_sampleName2<-gsub("_rep","",BNCN_sampleName[,10])
BNCN_valid_volcano3<-aggregate(BNCN_valid_volcano2, by=list(BNCN_sampleName2), mean, na.rm=T)
BNCN_valid_volcano4<-BNCN_valid_volcano3[,-1]
row.names(BNCN_valid_volcano4)<-gsub(".raw", "", BNCN_valid_volcano3$Group.1)
BNCN_valid_volcano5<-BNCN_valid_volcano4[, apply(BNCN_valid_volcano4,2,function(x) {sum(is.na(x))/nrow(BNCN_valid_volcano4)}) < 0.7]
BNCN_valid_volcano6<-data.frame(log2(BNCN_valid_volcano5))
BNCN_valid_volcano6[is.na(BNCN_valid_volcano6)]<-0

### volcano

fd <- data.frame(apply(2^BNCN_valid_volcano6,2, function(x) log2((mean(na.omit(x[grep("BN",row.names(BNCN_valid_volcano6) )]))/mean(na.omit(x[grep("CN",row.names(BNCN_valid_volcano6) )]))))))

pvalue<- data.frame(apply(BNCN_valid_volcano6,2, function(x)  t.test(x[grep("BN",row.names(BNCN_valid_volcano6) )],x[grep("CN",row.names(BNCN_valid_volcano6) )], paired = F, var.equal = F)$p.value ))

vol<-cbind(fd,pvalue)
names(vol)<-c("fd","P_value")

BNCN_valid_volcano7<-data.frame(t(rbind(BNCN_valid_volcano6,t(vol))))
BNCN_valid_volcano7$P_value_adjust<-p.adjust(BNCN_valid_volcano7$P_value, method="BH")

pdf("volcano/BNCN_valid_volcano.pdf",width = 6,height = 6)
plot(BNCN_valid_volcano7$fd, -log10(BNCN_valid_volcano7$P_value), col="#00000033", pch=19,cex=3,
     
      xlab=paste("log2(fold change)"),
      ylab="-log10 p value",
      main="BN_CN_DIA Valid")
# 
up <- subset(BNCN_valid_volcano7, BNCN_valid_volcano7$P_value < 0.05 & BNCN_valid_volcano7$fd > 0.5)
down <- subset(BNCN_valid_volcano7, BNCN_valid_volcano7$P_value< 0.05 & BNCN_valid_volcano7$fd< -0.5)

write.csv(up,file = "volcano/BNCN_valid_volcano_up.csv")
write.csv(down,file = "volcano/BNCN_valid_volcano_down.csv")


  # 
points(up$fd, -log10(up$P_value), col=1, bg = brewer.pal(9, "YlOrRd")[6], pch=21, cex=3)
points(down$fd, -log10(down$P_value), col = 1,  bg = brewer.pal(11, "RdBu")[9], pch = 21,cex=3)
  #
abline(h=1.3,v=c(-0.5,0.5),lty=2,lwd=1)

#}
dev.off()

```
  
```{r compare AG_GG BCCC in two volcanoplot}
AGGG_vol_test<- rbind(up,down)
trian_up<-read.csv("volcano/AG_GG_up.csv")
trian_down<-read.csv("volcano/AG_GG_down.csv")
AGGG_vol_train<- rbind(trian_up,trian_down)
row.names(AGGG_vol_train)<-data.frame(str_split_fixed(AGGG_vol_train$X,"_",2))[,1]
library(VennDiagram)
AGGG_vol_train$label<-row.names(AGGG_vol_train)
AGGG_vol_test$label<-row.names(AGGG_vol_test)
venn<-merge(AGGG_vol_test,AGGG_vol_train, by="label",all=F)
venn.plot <- venn.diagram(
#
x = list(AG_GG_train= c(row.names(AGGG_vol_train)),AG_GG_test= c(row.names(AGGG_vol_test))),
filename = NULL,
#
col = "transparent", #
fill = c("cornflowerblue", "yellow"), #
alpha = 0.50, #
cex = 1.5, #
fontfamily = "serif", #
fontface = "bold",#
cat.col = c("#3B82C5", "#EF7C1B"), #
cat.cex = 1.5, #
cat.pos = 0,#
cat.dist = 0.07, #
cat.fontfamily = "serif",#
rotation.degree = 270,  #
margin = 0.2#


)
pdf("volcano/AG_GG_train_test_volcano_venn.pdf")

grid.draw(venn.plot)
dev.off()

####BCCC

BCCC_vol_test<- rbind(up,down)
trian_up<-read.csv("volcano/BC_CC_up.csv")
trian_down<-read.csv("volcano/BC_CC_down.csv")
BCCC_vol_train<- rbind(trian_up,trian_down)
row.names(BCCC_vol_train)<-data.frame(str_split_fixed(BCCC_vol_train$X,"_",2))[,1]
library(VennDiagram)

BCCC_vol_train$label<-row.names(BCCC_vol_train)
BCCC_vol_test$label<-row.names(BCCC_vol_test)


venn<-merge(BCCC_vol_test,BCCC_vol_train, by="label",all=F)


venn.plot <- venn.diagram(
#
x = list(BC_CC_train= c(row.names(BCCC_vol_train)),BC_CC_test= c(row.names(BCCC_vol_test))),

filename = NULL,
#
col = "transparent", #
fill = c("cornflowerblue", "yellow"), #
alpha = 0.50, #

cex = 1.5, #
fontfamily = "serif", #
fontface = "bold",#
cat.col = c("#3B82C5", "#EF7C1B"), #
cat.cex = 1.5, #
cat.pos = 0,#
cat.dist = 0.07, #
cat.fontfamily = "serif",#
rotation.degree = 270,  #
margin = 0.2#


)
pdf("volcano/BC_CC_train_test_volcano_venn.pdf")

grid.draw(venn.plot)
dev.off()





```

```{r feature selection and visualization from vennAG_GG}
##feature from venn
feature<-data.frame(venn$X)
accu <- c()
df3<-AG_GG9
for (i in c(4)) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
  
for (m in c(2)) {
    
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
folds <- createFolds(df3$label,4)
select<-data.frame(combn(c(1:4),2))


    for(k in c(1:6)){
    a<-as.numeric(select[,k])
    fold= unlist(folds[a])
    # valids <- df3[,result1]
    valids <- data.frame(df3[fold,result1])
    names(valids)<-result1
  	valids$label <- df3$label[fold]
    
  	   trains <- data.frame(df3[setdiff(1:dim(df3)[1],fold),result1])
  	   names(trains)<-result1
  	   trains$label <- df3$label[setdiff(1:dim(df3)[1],fold)]
  	   trains$label <- as.factor(trains$label)
   	   set.seed(2020)
  	   tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1)
  	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
       predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
       predicts$observed <- valids$label
       ROC<- roc(predicts$observed, as.numeric(predicts$AG))
       
       assign(paste0("AG_GG_ROC",k),roc(predicts$observed, as.numeric(predicts$AG)))
       
       auc <- as.numeric(ROC[["auc"]])
    	 acc <- sum(predicts$predicted==predicts$observed)
    	 sum<-c(i,m,k, c(acc/length(fold),auc))
    	  accu <- data.frame(rbind(accu,sum))
  }

  }
  
}


train_result<-data.frame(tmpRF$votes)

trianing<-roc(trains$label, as.numeric(train_result$AG))

pdf("RandomForest/AG_GG_ROC_training1.pdf")
plot(trianing,cor="black")
dev.off()



pdf("RandomForest/AG_GG_ROC_training.pdf")
plot(AG_GG_ROC1,cor="white",main= mean(accu$X5))
 
library(RColorBrewer)
 
for (a in (1:6)){
  
plot.roc(get(paste0("AG_GG_ROC",a)),add=TRUE,col = brewer.pal(11, "Set3")[a])
}

dev.off()
best_feature_AG_GG<-result1
###"O95125_ZNF202" "P08572_COL4A2" "P35573_AGL"    "Q8IYJ3_SYTL1"  "Q9UQ16_DNM3" 
best_feature_AG_GG_matirx<- AG_GG8[,c("subtype",best_feature_AG_GG)]
write.csv(best_feature_AG_GG_matirx,"best_feature_AG_GG_matirx_AG_GG.csv")



```

```{r prepare matrix for pathway based feature selection }
rm(list=ls())
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)

info<-read_excel("name.xlsx",sheet = 1)
info<-info[-grep("A20", info$sampleID),]

info$subtype<-paste0(info$PType,info$Location)
df<-read.table("matrix/diann_KRUK_protein_20200828.txt",sep = "\t",stringsAsFactors = F,header = T)
AG_GG<-read.csv("GSEA/data/all_AG_GG_gsea.csv")
AG_GG2<-AG_GG[,-c(1)]
row.names(AG_GG2)<-AG_GG$X
AG_GG3<-data.frame(t(AG_GG2))
AG_GG3$batch<-row.names(AG_GG3)
AG_GG4<-merge(info,AG_GG3,by.x="batch",all=F)
AG_GG5<-AG_GG4[AG_GG4$subtype %in% c("AG","GG"),]
AG_GG6<-aggregate(AG_GG5[,-c(1:13)],  by=list(AG_GG5$pathology),  mean,na.rm=T)
names(AG_GG6)<-c("pathology",names(AG_GG6[,-1]))
AG_GG7<-merge(data.frame(unique(AG_GG5[,c("pathology","subtype")])),AG_GG6,by.x ="pathology",all.Y=F)
AG_GG8<-AG_GG7[,-1]
row.names(AG_GG8)<-AG_GG7$pathology
AG_GG9<-data.frame(AG_GG8[,1],log2(AG_GG8[,-1]))
names(AG_GG9)<-c("label",names(AG_GG9[,-1]))
AG_GG9[is.na(AG_GG9)]<-0
#####AG_GG9 is the training matrix

BC_CC<-read.csv("GSEA/data/all_BC_CC_gsea.csv")
BC_CC2<-BC_CC[,-c(1)]
row.names(BC_CC2)<-BC_CC$X
BC_CC3<-data.frame(t(BC_CC2))
BC_CC3$batch<-row.names(BC_CC3)
BC_CC4<-merge(info,BC_CC3,by.x="batch",all=F)
BC_CC5<-BC_CC4[BC_CC4$subtype %in% c("BC","CC"),]
BC_CC6<-aggregate(BC_CC5[,-c(1:13)],  by=list(BC_CC5$pathology),  mean,na.rm=T)
names(BC_CC6)<-c("pathology",names(BC_CC6[,-1]))
BC_CC7<-merge(data.frame(unique(BC_CC5[,c("pathology","subtype")])),BC_CC6,by.x ="pathology",all.Y=F)
BC_CC8<-BC_CC7[,-1]
row.names(BC_CC8)<-BC_CC7$pathology
BC_CC9<-data.frame(BC_CC8[,1],log2(BC_CC8[,-1]))
names(BC_CC9)<-c("label",names(BC_CC9[,-1]))
BC_CC9[is.na(BC_CC9)]<-0
#####BC_CC9 is the training matrix
```

```{r  using pathway feature  valid  from DIA AG_GG }
AGGG_valid<-df<-read.table("matrix/DIA_validation/20211019KRUK_A_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
library(stringr)
AGGG_sampleName<-data.frame(str_split_fixed(c(names(AGGG_valid)),pattern = "_",10))
AGGG_portName<-data.frame(str_split_fixed(c(names(AG_GG9)),pattern = "_",2))
names(AGGG_portName)<-c("prot","gene")
AGGG_valid2<-AGGG_valid[which(AGGG_valid$prot %in% AGGG_portName$prot),]
AGGG_valid3<-merge(AGGG_portName,AGGG_valid2,by.x = "prot", all=F)
AGGG_valid4<-AGGG_valid3[,-c(1:2)]
row.names(AGGG_valid4)<-paste0(AGGG_valid3$prot)
AGGG_valid5<-data.frame(t(AGGG_valid4))
AG_valid<-AGGG_valid5[grep("AG",row.names(AGGG_valid5)),]
GG_valid<-AGGG_valid5[grep("GG",row.names(AGGG_valid5)),]
AGGG_valid6<-data.frame(rbind(AG_valid, GG_valid))
AGGG_sampleName<-data.frame(str_split_fixed(c(row.names(AGGG_valid6)),pattern = "_",10))
AGGG_sampleName2<-gsub("_rep","",AGGG_sampleName[,10])
AGGG_valid7<-aggregate(AGGG_valid6, by=list(AGGG_sampleName2), mean, na.rm=T)
AGGG_valid8<-AGGG_valid7[,-1]
AGGG_valid9<-log2(AGGG_valid8)
AGGG_valid9[is.na(AGGG_valid9)]<-0
row.names(AGGG_valid9)<-AGGG_valid7$Group.1
 ##AGGG_valid9 is test matrix


##feature from pathway
set.seed(2020)
AG_GG10<-data.frame(apply(AG_GG9[,-1],2, function(v){min(v,na.rm=T)}))
AG_GG11<-data.frame(AG_GG9[,1])
AG_GG11<-AG_GG11[,-1]
for(i in 2:ncol(AG_GG9)){
AG_GG10<-data.frame(AG_GG9[,i])
 names(AG_GG10)<-names(AG_GG9)[i]
 AG_GG10[is.na(AG_GG10)]<-min(AG_GG10,na.rm = T)
 AG_GG11<-cbind(AG_GG11,AG_GG10)
}
row.names(AG_GG11)<-row.names(AG_GG9)
AG_GG11$label<-AG_GG9$label
# feature<-data.frame( c("P14543_NID1",   "Q16363_LAMA4",  "O15230_LAMA5",  "P07942_LAMB1",  "P11047_LAMC1",  "P23634_ATP2B4", "P20020_ATP2B1","Q16787_LAMA3",  "P24043_LAMA2",  "P55268_LAMB2",  "Q14112_NID2",   "P23229_ITGA6",  "P16144_ITGB4",  "P26006_ITGA3", "P02452_COL1A1", "P02461_COL3A1"))

feature<-data.frame( c("P14543",   "Q16363",  "O15230",  "P07942",  "P11047",  "P23634", "P20020","Q16787",  "P24043",  "P55268",  "Q14112",   "P23229",  "P16144",  "P26006", "P02452", "P02461"))

names(feature)<-"pathway"

##prepare trains
trainsModel<- AG_GG11[,names(AG_GG11) %in% feature$pathway]
# trainsModel<-data.frame((apply(trainsModel,2,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trainsModel$label<-AG_GG9$label

##prepare valids
validsModel<-AGGG_valid9
# validsModel<-data.frame((apply(AGGG_valid9,2,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
validsModel$label<-gsub("[0-9]|.raw","",row.names(AGGG_valid9))

## feature select and build model
accu <- c()
for (i in 7:10) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1:ncol(feature2)) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)

trains <- data.frame(trainsModel[,result1])
trains$label<-trainsModel$label

valids <- data.frame(validsModel[,result1])
valids$label <- validsModel$label
set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
    	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$AG))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/27,auc))
         accu <- data.frame(rbind(accu,sum))
 }
  }
accu2_6<-accu

##best feature i=4 m=2
accu <- c()
for (i in 4) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 2) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
trains <- data.frame(trainsModel[,result1])

trains$label<-trainsModel$label
valids <- data.frame(validsModel[,result1])

valids$label <- validsModel$label
set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=TRUE)
    	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$AG))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/27,auc))
         accu <- data.frame(rbind(accu,sum))
 }
  }

###model visualization
set.seed(2021)
source("common_change_label.R")
color<-c("red","blue")
train<-drawPCA(trains,ptColors = color,F,F)
row.names(valids)<-gsub(".raw","",row.names(valids))

valid<-drawPCA(valids,ptColors = color,F,F, strTitle = paste0("O43866_CD5L O43920_NDUFS5 P02461_COL3A1 Q9BW30_TPPP3" ))

ggsave("RandomForest/AG_GG_DIA_valid_Pca.pdf", plot = valid, device = NULL)

##roc
pdf("RandomForest/AG_GG_DIA_valid_ROC.pdf")
plot(ROC,cor="blue",main= auc)
dev.off()

##point plot
mean <- apply( valids[,-5],1,median)
data <- data.frame(mean,predicts=predicts$GG,sample2=row.names(predicts),type2=predicts$observed )
data$sample2<-gsub("[0-9]","",data$sample2)

ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
  a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
    geom_point()+geom_vline(xintercept = 0.65 ,linetype="dotted")+
    ggtitle(paste0(title,"_pointplot"))+
    xlab(xlab)+
    ylab(ylab)+
    xlim(0,1)+
    theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
          legend.title = element_text(size=15,color="black") ,
          panel.grid.major =element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"))+
    scale_color_manual(values=c("#FDB462","#BC80BD"))+
    theme(panel.grid =element_blank())+
    theme(axis.text = element_text(size = 10,color = "black"))+
    theme(axis.text.x = element_text( hjust = 0.5))+
    theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
    theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
    theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
  ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
}

ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/AG_GG_DIA_valid_PointPlot","predict value","median")

```

```{r  using pathway feature  valid  from DIA BC_CC }
BCCC_valid<-df<-read.table("DIA_validation/202101022KRUK_B_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
library(stringr)
BCCC_sampleName<-data.frame(str_split_fixed(c(names(BCCC_valid)),pattern = "_",10))
BCCC_portName<-data.frame(str_split_fixed(c(names(BC_CC9)),pattern = "_",2))
names(BCCC_portName)<-c("prot","gene")
BCCC_valid2<-BCCC_valid[which(BCCC_valid$prot %in% BCCC_portName$prot),]
BCCC_valid3<-merge(BCCC_portName,BCCC_valid2,by.x = "prot", all=F)
BCCC_valid4<-BCCC_valid3[,-c(1:2)]
row.names(BCCC_valid4)<-paste0(BCCC_valid3$prot)
BCCC_valid5<-data.frame(t(BCCC_valid4))
BC_valid<-BCCC_valid5[grep("_BC",row.names(BCCC_valid5)),]
CC_valid<-BCCC_valid5[grep("_CC",row.names(BCCC_valid5)),]
BCCC_valid6<-data.frame(rbind(BC_valid, CC_valid))
BCCC_sampleName<-data.frame(str_split_fixed(c(row.names(BCCC_valid6)),pattern = "_",10))
BCCC_sampleName2<-gsub("_rep","",BCCC_sampleName[,10])
BCCC_valid7<-aggregate(BCCC_valid6, by=list(BCCC_sampleName2), mean, na.rm=T)
BCCC_valid8<-BCCC_valid7[,-1]
BCCC_valid9<-log2(BCCC_valid8)
BCCC_valid9[is.na(BCCC_valid9)]<-0
row.names(BCCC_valid9)<-BCCC_valid7$Group.1
 ##BCCC_valid9 is test matrix

set.seed(2020)
BC_CC10<-data.frame(apply(BC_CC9[,-1],2, function(v){min(v,na.rm=T)}))
BC_CC11<-data.frame(BC_CC9[,-1])
BC_CC11<-BC_CC11[,-1]
for(i in 2:ncol(BC_CC9)){
BC_CC10<-data.frame(BC_CC9[,i])
 names(BC_CC10)<-names(BC_CC9)[i]
 BC_CC10[is.na(BC_CC10)]<-min(BC_CC10,na.rm = T)
 BC_CC11<-cbind(BC_CC11,BC_CC10)
}
row.names(BC_CC11)<-row.names(BC_CC9)
BC_CC11$label<-BC_CC9$label


# feature<-data.frame( c("P24043_LAMA2",   "O15230_LAMA5",  "P07942_LAMB1",  "P55268_LAMB2",  "P11047_LAMC1",  "P20020_ATP2B1", "P02452_COL1A1","P02461_COL3A1",  "P08123_COL1A2",  "P02462_COL4A1",  "P08572_COL4A2",   "P14543_NID1",  "P23634_ATP2B4",  "P26006", "P02452", "P02461","P20908_COL5A1","P05997_COL5A2","P39060_COL18A1","P13942_COL11A2","P12111_COL6A3","P05556_ITGB1","Q14112_NID2","","Q13683_ITGA7","P56199_ITGA1","P06756_ITGAV","P08648_ITGA5","P12110_COL6A2","P12109_COL6A1"))


feature<-data.frame( c("P24043",   "O15230",  "P07942",  "P55268",  "P11047",  "P20020", "P02452","P02461",  "P08123",  "P02462",  "P08572",   "P14543",  "P23634",  "P26006", "P02452", "P02461","P20908", "P05997","P39060", "P13942","P12111", "P05556","Q14112","Q13683","P56199","P06756","P08648","P12110","P12109"))
 
names(feature)<-"pathway"
##prepare trains
trainsModel<- BC_CC11[,names(BC_CC11) %in% feature$pathway]
# trainsModel<-data.frame((apply(trainsModel,2,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trainsModel$label<-BC_CC9$label

##prepare valids
validsModel<-BCCC_valid9
# validsModel<-data.frame((apply(BCCC_valid9,2,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
validsModel$label<-gsub("[0-9]|.raw","",row.names(BCCC_valid9))

## feature select and build model
accu <- c()
for (i in 2:5) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1:ncol(feature2)) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)

trains <- data.frame(trainsModel[,result1])
trains$label<-trainsModel$label

valids <- data.frame(validsModel[,result1])
valids$label <- validsModel$label
set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
    	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$BC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/53,auc))
         accu <- data.frame(rbind(accu,sum))
 }
  }

##best feature i=4 m=2
accu <- c()
for (i in 3) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 22) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
trains <- data.frame(trainsModel[,result1])

trains$label<-trainsModel$label
valids <- data.frame(validsModel[,result1])

valids$label <- validsModel$label
set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=TRUE)
    	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$BC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/53,auc))
         accu <- data.frame(rbind(accu,sum))
 }
  }


###model visualization  ###"P01042_KNG1" "P02763_ORM1" "P51884_LUM" 
set.seed(2021)
source("common_change_label.R")
color<-c("red","blue")
train<-drawPCA(trains,ptColors = color,F,F)
row.names(valids)<-gsub(".raw","",row.names(valids))

valid<-drawPCA(valids,ptColors = color,F,F, strTitle = paste0("P01042_KNG1 P02763_ORM1 P51884_LUM" ))

ggsave("RandomForest/BC_CC_DIA_valid_Pca.pdf", plot = valid, device = NULL)

##roc
pdf("RandomForest/BC_CC_DIA_valid_ROC.pdf")
plot(ROC,cor="blue",main= auc)
dev.off()

##point plot
mean <- apply( valids[,-4],1,median)
data <- data.frame(mean,predicts=predicts$CC,sample2=row.names(predicts),type2=predicts$observed )
data$sample2<-gsub("[0-9]","",data$sample2)

ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
  a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
    geom_point()+geom_vline(xintercept = 0.35 ,linetype="dotted")+
    ggtitle(paste0(title,"_pointplot"))+
    xlab(xlab)+
    ylab(ylab)+
    xlim(0,1)+
    theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
          legend.title = element_text(size=15,color="black") ,
          panel.grid.major =element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"))+
    scale_color_manual(values=c("#FDB462","#BC80BD"))+
    theme(panel.grid =element_blank())+
    theme(axis.text = element_text(size = 10,color = "black"))+
    theme(axis.text.x = element_text( hjust = 0.5))+
    theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
    theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
    theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
  ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
}

ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/BC_CC_DIA_valid_PointPlot","predict value","median")









```



```{r prepare matrix for  AG_GG BC CC pathway protein feature selection }
rm(list=ls())
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)

info<-read_excel("name.xlsx",sheet = 1)
info<-info[-grep("A20", info$sampleID),]

info$subtype<-paste0(info$PType,info$Location)
df<-read.table("matrix/diann_KRUK_protein_20200828.txt",sep = "\t",stringsAsFactors = F,header = T)
AG_GG_up<-read.csv("volcano/AG_GG_up.csv")
AG_GG_down<-read.csv("volcano/AG_GG_down.csv")
AG_GG<-rbind(AG_GG_up,AG_GG_down)
AG_GG2<-AG_GG[,-c(1,93:95)]
row.names(AG_GG2)<-AG_GG$X
AG_GG3<-data.frame(t(AG_GG2))
AG_GG3$batch<-row.names(AG_GG3)
AG_GG4<-merge(info,AG_GG3,by.x="batch",all=F)
AG_GG5<-AG_GG4[AG_GG4$subtype %in% c("AG","GG"),]
AG_GG6<-aggregate(AG_GG5[,-c(1:13)],  by=list(AG_GG5$pathology),  mean,na.rm=T)
names(AG_GG6)<-c("pathology",names(AG_GG6[,-1]))
AG_GG7<-merge(data.frame(unique(AG_GG5[,c("pathology","subtype")])),AG_GG6,by.x ="pathology",all.Y=F)
AG_GG8<-AG_GG7[,-1]
row.names(AG_GG8)<-AG_GG7$pathology
AG_GG9<-data.frame(AG_GG8[,1],(AG_GG8[,-1]))
names(AG_GG9)<-c("label",names(AG_GG9[,-1]))#####AG_GG9 is the training matrix

BC_CC_up<-read.csv("volcano/BC_CC_up.csv")
BC_CC_down<-read.csv("volcano/BC_CC_down.csv")
BC_CC<-rbind(BC_CC_up,BC_CC_down)
BC_CC2<-BC_CC[,-c(1,96:98)]
row.names(BC_CC2)<-BC_CC$X
BC_CC3<-data.frame(t(BC_CC2))
BC_CC3$batch<-row.names(BC_CC3)
BC_CC4<-merge(info,BC_CC3,by.x="batch",all=F)
BC_CC5<-BC_CC4[BC_CC4$subtype %in% c("BC","CC"),]
BC_CC6<-aggregate(BC_CC5[,-c(1:13)],  by=list(BC_CC5$pathology),  mean,na.rm=T)
names(BC_CC6)<-c("pathology",names(BC_CC6[,-1]))
BC_CC7<-merge(data.frame(unique(BC_CC5[,c("pathology","subtype")])),BC_CC6,by.x ="pathology",all.Y=F)
BC_CC8<-BC_CC7[,-1]
row.names(BC_CC8)<-BC_CC7$pathology
BC_CC9<-data.frame(BC_CC8[,1],log2(BC_CC8[,-1]))
names(BC_CC9)<-c("label",names(BC_CC9[,-1]))#####BC_CC9 is the training matrix
```

```{r feature selection_AG_GG_old}
set.seed(2020)
AG_GG9[is.na(AG_GG9)]<-0
tmpRF_AG_GG <- randomForest(as.factor(label) ~ . ,data=AG_GG9,importance=T,ntree=5000,nodesize=1)
result_AG_GG <- data.frame(importance(tmpRF_AG_GG,type=1))
plot(tmpRF_AG_GG)
pdf("varImpPlot_AG_GG_20210412.pdf")
varImpPlot(tmpRF_AG_GG)

df3<-AG_GG9
feature <- data.frame(row.names(result_AG_GG)[result_AG_GG$MeanDecreaseAccuracy>9])

accu <- c()
for (i in 1:nrow(feature)) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1:ncol(feature2)) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
folds <- createFolds(df3$label,4)
select<-data.frame(combn(c(1:4),2))
for(k in c(1:6)){
    a<-as.numeric(select[,k])
    fold= unlist(folds[a])
    # valids <- df3[,result1]
    valids <- data.frame(df3[fold,result1])
    names(valids)<-result1
  	valids$label <- df3$label[fold]
    trains <- data.frame(df3[setdiff(1:dim(df3)[1],fold),result1])
  	names(trains)<-result1
  	trains$label <- df3$label[setdiff(1:dim(df3)[1],fold)]
  	trains$label <- as.factor(trains$label)
    set.seed(2020)
    	   tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
    	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$AG))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m,k, c(acc/length(fold),auc))
         accu <- data.frame(rbind(accu,sum))
 }
  }
}
names(accu)<-c("feature_num","feature_pos","fold","acc","auc")
accu_sum<-accu
accu_sum2<-aggregate(accu_sum,by=list(accu_sum$feature_num,accu_sum$feature_pos),mean, na.rm=T)

##best feature_num=5 feature_pos=129

accu <- c()

for (i in c(5)) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
  
for (m in c(129)) {
    
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
folds <- createFolds(df3$label,4)
select<-data.frame(combn(c(1:4),2))


    for(k in c(1:6)){
    a<-as.numeric(select[,k])
    fold= unlist(folds[a])
    # valids <- df3[,result1]
    valids <- data.frame(df3[fold,result1])
    names(valids)<-result1
  	valids$label <- df3$label[fold]
    
  	   trains <- data.frame(df3[setdiff(1:dim(df3)[1],fold),result1])
  	   names(trains)<-result1
  	   trains$label <- df3$label[setdiff(1:dim(df3)[1],fold)]
  	   trains$label <- as.factor(trains$label)
   	   set.seed(2020)
  	   tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1)
  	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
       predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
       predicts$observed <- valids$label
       ROC<- roc(predicts$observed, as.numeric(predicts$AG))
       
       assign(paste0("AG_GG_ROC",k),roc(predicts$observed, as.numeric(predicts$AG)))
       
       auc <- as.numeric(ROC[["auc"]])
    	 acc <- sum(predicts$predicted==predicts$observed)
    	 sum<-c(i,m,k, c(acc/length(fold),auc))
    	 
    	 accu <- data.frame(rbind(accu,sum))
  }

  }
  
}

pdf("AG_GG_ROC_20210412.pdf")
plot(AG_GG_ROC1,cor="white",main= mean(accu$X5))
 
library(RColorBrewer)
 
for (a in (1:6)){
  
plot.roc(get(paste0("AG_GG_ROC",a)),add=TRUE,col = brewer.pal(11, "Set3")[a])
}

best_feature_AG_GG<-result1
###"O95125_ZNF202" "P08572_COL4A2" "P35573_AGL"    "Q8IYJ3_SYTL1"  "Q9UQ16_DNM3" 
best_feature_AG_GG_matirx<- AG_GG8[,c("subtype",best_feature_AG_GG)]
write.csv(best_feature_AG_GG_matirx,"best_feature_AG_GG_matirx_AG_GG.csv")



```

```{r MRM validation for AG_GG}
#select best 10 feature
set.seed(2020)
AG_GG10<-data.frame(apply(AG_GG9[,-1],2, function(v){min(v,na.rm=T)}))
AG_GG11<-data.frame(AG_GG9[,1])
AG_GG11<-AG_GG11[,-1]
for(i in 2:ncol(AG_GG9)){
AG_GG10<-data.frame(AG_GG9[,i])
 names(AG_GG10)<-names(AG_GG9)[i]
 AG_GG10[is.na(AG_GG10)]<-min(AG_GG10,na.rm = T)
 AG_GG11<-cbind(AG_GG11,AG_GG10)
}
row.names(AG_GG11)<-row.names(AG_GG9)
AG_GG11$label<-AG_GG9$label
set.seed(2020)
tmpRF_AG_GG <- randomForest(as.factor(label) ~ . ,data=AG_GG11,importance=T,ntree=5000,nodesize=1)
result_AG_GG <- data.frame(importance(tmpRF_AG_GG,type=1))
# plot(tmpRF_AG_GG)
pdf("RandomForest/varImpPlot_AG_GG_20220319.pdf")
varImpPlot(tmpRF_AG_GG)
dev.off()
feature <- data.frame(row.names(result_AG_GG)[result_AG_GG$MeanDecreaseAccuracy> 8])

names(feature)<-"MeanDecreaseAccuracy"

##prepare trains
trainsModel0<- AG_GG11[,names(AG_GG11) %in% feature$MeanDecreaseAccuracy]
trainsModel<-(trainsModel0)
# trainsModel<-data.frame(t(apply(trainsModel,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trainsModel$label<-AG_GG9$label

##prepare valids
mrmAG<-read.csv("matrix/MRM_validation/KRUK_AG_GG_MRM_matrix.csv")
test<-mrmAG[mrmAG$Protein %in% names(trainsModel),]
test<-test[-which(test$Peptide %in% c("WVEDIQMAIDLAEK")),]
test1<-test[,-c(1:4)]
row.names(test1)<-test$Protein
test2<-data.frame(t(test1))
testAG<-test2[grep("AG", row.names(test2)),]
testAG$subtype<-"AG"
testGG<-test2[grep("GG", row.names(test2)),]
testGG$subtype<-"GG"
test3<-data.frame(rbind(testAG,testGG))
test4<-log2(test3[,-15])
# test4.5<-data.frame(t(apply(test4,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
test4$label<-test3$subtype
validsModel<-test4
## feature select and build model

accu <- c()
for (i in 2:6) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1:ncol(feature2)) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)

trains <- data.frame(trainsModel[,result1])
# trains<-data.frame(t(apply(trains,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trains$label<-trainsModel$label

valids <- data.frame(validsModel[,result1])
# valids<-data.frame(t(apply(valids,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
valids$label <- validsModel$label


set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$AG))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
 predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$AG))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/27,auc, ROC_train_model_predict_auc))
         accu <- data.frame(rbind(accu,sum))
   
          }
}

names(accu)<-c("i","m","acc","test_auc","train_auc")
accu1 <- accu


##best feature i=5 m=1980
accu <- c()
for (i in 5) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1980) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))[-1]


set.seed(2020.3)

trains <- data.frame(trainsModel[,result1])
# trains<-data.frame(t(apply(trains,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trains$label<-trainsModel$label

valids <- data.frame(validsModel[,result1])
# valids<-data.frame(t(apply(valids,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
valids$label <- validsModel$label
set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$AG))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
 predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$AG))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/27,auc, ROC_train_model_predict_auc))
         accu <- data.frame(rbind(accu,sum))
   
          }
}

names(accu)<-c("i","m","acc","test_auc","train_auc")

# O60831_PRAF2_O95125_ZNF202_P08572_COL4A2



##Model ROC
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$AG))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
pdf("RandomForest/ROC_train_model_predict.pdf")
plot(ROC_train_model_predict,cor="blue",main= ROC_train_model_predict_auc)
dev.off()

##Confusion matrix
tmpRF_comfusion<-data.frame(tmpRF$confusion)
sensitivity_tmpRF<-tmpRF_comfusion[1,1]/(tmpRF_comfusion[1,2]+tmpRF_comfusion[1,1])
specificity_tmpRF<-tmpRF_comfusion[2,2]/(tmpRF_comfusion[2,2]+tmpRF_comfusion[2,1])
PPV_tmpRF<-tmpRF_comfusion[1,1]/(tmpRF_comfusion[1,1]+tmpRF_comfusion[2,1])
NPV_tmpRF<-tmpRF_comfusion[2,2]/(tmpRF_comfusion[1,2]+tmpRF_comfusion[2,2])
train_model_statistics<-data.frame(sensitivity_tmpRF,specificity_tmpRF,PPV_tmpRF,NPV_tmpRF,ROC_train_model_predict_auc)
names(train_model_statistics)<-c("sensitivity","specificity","PPV","NPV","AUC")
write.csv(train_model_statistics,"RandomForest/train_model_statistics.csv")

test_comfusion<-data.frame(c(8,1),c(1,17))
names(test_comfusion)<-c("AG","GG")
row.names(test_comfusion)<-c("AG","GG")
sensitivity_test<-test_comfusion[1,1]/(test_comfusion[1,2]+test_comfusion[1,1])
specificity_test<-test_comfusion[2,2]/(test_comfusion[2,2]+test_comfusion[2,1])
PPV_test<-test_comfusion[1,1]/(test_comfusion[1,1]+test_comfusion[2,1])
NPV_test<-test_comfusion[2,2]/(test_comfusion[1,2]+test_comfusion[2,2])
test_model_statistics<-data.frame(sensitivity_test,specificity_test,PPV_test,NPV_test,auc)
names(test_model_statistics)<-c("sensitivity","specificity","PPV","NPV","AUC")
write.csv(test_model_statistics,"RandomForest/test_model_statistics.csv")

###model visualization
set.seed(2021)
source("common_change_label.R")
color<-c("red","blue")
train<-drawPCA(trains,ptColors = color,F,F)
row.names(valids)<-gsub(".Total.Area.Fragment","",row.names(valids))
row.names(valids)<-gsub("H20210803yixiao_KRUK_MRM_60min_","",row.names(valids))
row.names(valids)<-gsub("_20210805133011","",row.names(valids))
row.names(valids)<-gsub("_20210805144702","",row.names(valids))
valid<-drawPCA(valids,ptColors = color,F,F)
ggsave("RandomForest/MRM_AG_GG_PCA_20211110_pointplot.pdf", plot = valid, device = NULL)

##roc
pdf("RandomForest/MRM_AG_GG_ROC_20211110.pdf")
plot(ROC,cor="blue",main= auc)
dev.off()

  ##point plot
  mean <- apply( valids[,-5],1,median)
  data <- data.frame(mean,predicts=predicts$GG,sample2=row.names(predicts),type2=predicts$observed )
  data$sample2<-gsub(".Total.Area.Fragment","",data$sample2)
  data$sample2<-gsub("H20210803yixiao_KRUK_MRM_60min_","",data$sample2)
  data$sample2<-gsub("_20210805133011","",data$sample2)
  data$sample2<-gsub("_20210805144702","",data$sample2)
  ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
    a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
      geom_point()+geom_vline(xintercept = 0.46 ,linetype="dotted")+
      ggtitle(paste0(title,"_pointplot"))+
      xlab(xlab)+
      ylab(ylab)+
      xlim(0,1)+
      theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
            legend.title = element_text(size=15,color="black") ,
            panel.grid.major =element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            axis.line = element_line(colour = "black"))+
      scale_color_manual(values=c("#FDB462","#BC80BD"))+
      theme(panel.grid =element_blank())+
      theme(axis.text = element_text(size = 10,color = "black"))+
      theme(axis.text.x = element_text( hjust = 0.5))+
      theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
      theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
      theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
    ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
  }
  
  ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/MRM_AG_GG_PointPlot_20211110","predict value","median")
```

```{r MRM validation for AG_GG  test20220324}
#select best 10 feature
set.seed(2020)
AG_GG10<-data.frame(apply(AG_GG9[,-1],2, function(v){min(v,na.rm=T)}))
AG_GG11<-data.frame(AG_GG9[,1])
AG_GG11<-AG_GG11[,-1]
for(i in 2:ncol(AG_GG9)){
AG_GG10<-data.frame(AG_GG9[,i])
 names(AG_GG10)<-names(AG_GG9)[i]
 AG_GG10[is.na(AG_GG10)]<-min(AG_GG10,na.rm = T)
 AG_GG11<-cbind(AG_GG11,AG_GG10)
}
row.names(AG_GG11)<-row.names(AG_GG9)
mrmAG<-read.csv("matrix/MRM_validation/KRUK_AG_GG_MRM_matrix.csv")
AG_GG12<-AG_GG11[,names(AG_GG11) %in% mrmAG$Protein ]
AG_GG12$label<-AG_GG9$label
feature<- data.frame(names(AG_GG12)[-ncol(AG_GG12)])


# set.seed(2020)
# tmpRF_AG_GG <- randomForest(as.factor(label) ~ . ,data=AG_GG11,importance=T,ntree=5000,nodesize=1)
# result_AG_GG <- data.frame(importance(tmpRF_AG_GG,type=1))
# # plot(tmpRF_AG_GG)
# pdf("RandomForest/varImpPlot_AG_GG_20220319.pdf")
# varImpPlot(tmpRF_AG_GG)
# dev.off()
# feature <- data.frame(row.names(result_AG_GG)[result_AG_GG$MeanDecreaseAccuracy> 8])
# 
# names(feature)<-"MeanDecreaseAccuracy"
# 
# ##prepare trains
# trainsModel0<- AG_GG11[,names(AG_GG11) %in% feature$MeanDecreaseAccuracy]
# trainsModel<-(trainsModel0)
# # trainsModel<-data.frame(t(apply(trainsModel,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
# trainsModel$label<-AG_GG9$label
trainsModel<-AG_GG12
##prepare valids
mrmAG<-read.csv("matrix/MRM_validation/KRUK_AG_GG_MRM_matrix.csv")
test<-mrmAG[mrmAG$Protein %in% names(trainsModel),]
# test<-test[-which(test$Peptide %in% c("WVEDIQMAIDLAEK")),]
test1<-aggregate(test[,-c(1:4)], by=list(test$Protein),mean)


row.names(test1)<-test1$Group.1

test2<-data.frame(t(test1[,-1]))
testAG<-test2[grep("AG", row.names(test2)),]
testAG$subtype<-"AG"
testGG<-test2[grep("GG", row.names(test2)),]
testGG$subtype<-"GG"
test3<-data.frame(rbind(testAG,testGG))
test4<-log2(test3[,-ncol(test3)])
# test4.5<-data.frame(t(apply(test4,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
test4$label<-test3$subtype

row.names(test4)<-data.frame(str_split_fixed(row.names(test4),"_",6))[,5]
row.names(test4)<-gsub(".Total.Area.Fragment","",row.names(test4))
validsModel<-test4
## feature select and build model

accu <- c()
for (i in 2:4) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1:ncol(feature2)) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)

trains <- data.frame(trainsModel[,result1])
# trains<-data.frame(t(apply(trains,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trains$label<-trainsModel$label

valids <- data.frame(validsModel[,result1])
# valids<-data.frame(t(apply(valids,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
valids$label <- validsModel$label


set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$AG))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
 predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$AG))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/26,auc, ROC_train_model_predict_auc))
         accu <- data.frame(rbind(accu,sum))
   
          }
}

names(accu)<-c("i","m","acc","test_auc","train_auc")
accu1 <- accu


##best feature i=5 m=1980
accu <- c()
for (nn in 1) {
for (i in 4) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1200) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))[-1]


set.seed(2020.3)

trains <- data.frame(trainsModel[,result1])
# trains<-data.frame(t(apply(trains,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trains$label<-trainsModel$label

valids <- data.frame(validsModel[,result1])
# valids<-data.frame(t(apply(valids,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
valids$label <- validsModel$label
set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$AG))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
 predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$AG))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/26,auc, ROC_train_model_predict_auc))
         accu <- data.frame(rbind(accu,sum))
   
          }
}

names(accu)<-c("i","m","acc","test_auc","train_auc")

# O60831_PRAF2_O95125_ZNF202_P08572_COL4A2



##Model ROC
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$AG))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
pdf("RandomForest/ROC_train_model_predict.pdf")
plot(ROC_train_model_predict,cor="blue",main= ROC_train_model_predict_auc)
dev.off()

##Confusion matrix
tmpRF_comfusion<-data.frame(tmpRF$confusion)
sensitivity_tmpRF<-tmpRF_comfusion[1,1]/(tmpRF_comfusion[1,2]+tmpRF_comfusion[1,1])
specificity_tmpRF<-tmpRF_comfusion[2,2]/(tmpRF_comfusion[2,2]+tmpRF_comfusion[2,1])
PPV_tmpRF<-tmpRF_comfusion[1,1]/(tmpRF_comfusion[1,1]+tmpRF_comfusion[2,1])
NPV_tmpRF<-tmpRF_comfusion[2,2]/(tmpRF_comfusion[1,2]+tmpRF_comfusion[2,2])
train_model_statistics<-data.frame(sensitivity_tmpRF,specificity_tmpRF,PPV_tmpRF,NPV_tmpRF,ROC_train_model_predict_auc)
names(train_model_statistics)<-c("sensitivity","specificity","PPV","NPV","AUC")
write.csv(train_model_statistics,"RandomForest/train_model_statistics.csv")

test_comfusion<-data.frame(c(8,1),c(1,17))
names(test_comfusion)<-c("AG","GG")
row.names(test_comfusion)<-c("AG","GG")
sensitivity_test<-test_comfusion[1,1]/(test_comfusion[1,2]+test_comfusion[1,1])
specificity_test<-test_comfusion[2,2]/(test_comfusion[2,2]+test_comfusion[2,1])
PPV_test<-test_comfusion[1,1]/(test_comfusion[1,1]+test_comfusion[2,1])
NPV_test<-test_comfusion[2,2]/(test_comfusion[1,2]+test_comfusion[2,2])
test_model_statistics<-data.frame(sensitivity_test,specificity_test,PPV_test,NPV_test,auc)
names(test_model_statistics)<-c("sensitivity","specificity","PPV","NPV","AUC")
write.csv(test_model_statistics,"RandomForest/test_model_statistics.csv")

###model visualization
set.seed(2021)
source("common_change_label.R")
color<-c("red","blue")
train<-drawPCA(trains,ptColors = color,F,F)
valid<-drawPCA(valids,ptColors = color,F,F)
ggsave("RandomForest/MRM_AG_GG_PCA_20220324.pdf", plot = valid, device = NULL)

##roc
pdf("RandomForest/MRM_AG_GG_ROC_20220324.pdf")
plot(ROC,cor="blue",main= auc)
dev.off()

  ##point plot
  mean <- apply( valids[,-ncol(valids)],1,median)
  data <- data.frame(mean,predicts=predicts$GG,sample2=row.names(predicts),type2=predicts$observed )
  
  ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
    a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
      geom_point()+geom_vline(xintercept = 0.46 ,linetype="dotted")+
      ggtitle(paste0(title,"_pointplot"))+
      xlab(xlab)+
      ylab(ylab)+
      xlim(0,1)+
      theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
            legend.title = element_text(size=15,color="black") ,
            panel.grid.major =element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            axis.line = element_line(colour = "black"))+
      scale_color_manual(values=c("#FDB462","#BC80BD"))+
      theme(panel.grid =element_blank())+
      theme(axis.text = element_text(size = 10,color = "black"))+
      theme(axis.text.x = element_text( hjust = 0.5))+
      theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
      theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
      theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
    ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
  }
  
  ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/MRM_AG_GG_PointPlot_20220324","predict value","median")
  
}
```


```{r DIA validation for BC_CC 20220406}
rm(list=ls())
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)
library(tidyverse)
library(stringr)
info<-read_excel("name.xlsx",sheet = 1)
info<-info[-grep("A20", info$sampleID),]
info$subtype<-paste0(info$PType,info$Location)
df<-read.table("matrix/diann_KRUK_protein_20200828.txt",sep = "\t",stringsAsFactors = F,header = T)
BC_CC_up<-read.csv("volcano/BC_CC_up.csv")
BC_CC_down<-read.csv("volcano/BC_CC_down.csv")
BC_CC<-rbind(BC_CC_up,BC_CC_down)
BC_CC2<-BC_CC[,-c(1,96:98)]
row.names(BC_CC2)<-BC_CC$X
BC_CC3<-data.frame(t(BC_CC2))
BC_CC3$batch<-row.names(BC_CC3)
BC_CC4<-merge(info,BC_CC3,by.x="batch",all=F)
BC_CC5<-BC_CC4[BC_CC4$subtype %in% c("BC","CC"),]
BC_CC6<-aggregate(BC_CC5[,-c(1:13)],  by=list(BC_CC5$pathology),  mean,na.rm=T)
names(BC_CC6)<-c("pathology",names(BC_CC6[,-1]))
BC_CC7<-merge(data.frame(unique(BC_CC5[,c("pathology","subtype")])),BC_CC6,by.x ="pathology",all.Y=F)
BC_CC8<-BC_CC7[,-1]
row.names(BC_CC8)<-BC_CC7$pathology
BC_CC9<-data.frame(BC_CC8[,1],(BC_CC8[,-1]))
names(BC_CC9)<-c("label",names(BC_CC9[,-1]))#####BC_CC9 is the training matrix

BCCC_valid<-read.table("matrix/DIA_validation/202101022KRUK_B_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
library(stringr)
BCCC_sampleName<-data.frame(str_split_fixed(c(names(BCCC_valid)),pattern = "_",10))
BCCC_portName<-data.frame(str_split_fixed(c(names(BC_CC9)),pattern = "_",2))
names(BCCC_portName)<-c("prot","gene")
BCCC_valid2<-BCCC_valid[which(BCCC_valid$prot %in% BCCC_portName$prot),]
BCCC_valid3<-merge(BCCC_portName,BCCC_valid2,by.x = "prot", all=F)
BCCC_valid4<-BCCC_valid3[,-c(1:2)]
row.names(BCCC_valid4)<-paste0(BCCC_valid3$prot,"_",BCCC_valid3$gene)
BCCC_valid5<-data.frame(t(BCCC_valid4))
BC_valid<-BCCC_valid5[grep("_BC",row.names(BCCC_valid5)),]
CC_valid<-BCCC_valid5[grep("_CC",row.names(BCCC_valid5)),]
BCCC_valid6<-data.frame(rbind(BC_valid, CC_valid))
BCCC_sampleName<-data.frame(str_split_fixed(c(row.names(BCCC_valid6)),pattern = "_",10))
BCCC_sampleName2<-gsub("_rep","",BCCC_sampleName[,10])
BCCC_valid7<-aggregate(BCCC_valid6, by=list(BCCC_sampleName2), mean, na.rm=T)
BCCC_valid8<-BCCC_valid7[,-1]
BCCC_valid9<-log2(BCCC_valid8)
BCCC_valid9[is.na(BCCC_valid9)]<-0
row.names(BCCC_valid9)<-BCCC_valid7$Group.1
BCCC_valid9$label<-gsub("[0-9]|.raw","",row.names(BCCC_valid9))
##BCCC_valid9 is test matrix


# write.csv(BC_CC9,"RandomForest/TMP_run/BC_CC9.csv",row.names = T)

# write.csv(BCCC_valid9,"RandomForest/TMP_run/BCCC_valid9.csv",row.names = T)


# ##over sample
# set.seed(2022)
# BC_CC9 <- ovun.sample(label ~ ., data = BC_CC9,method = "over",N = 100)$data

set.seed(2022)
tmpRF_BC_CC <- randomForest(as.factor(label) ~ . ,data=BC_CC9,importance=T,ntree=1000,nodesize=1)
result_BC_CC <- data.frame(importance(tmpRF_BC_CC,type=1))
feature<-result_BC_CC %>%  top_n(15, MeanDecreaseAccuracy)
feature$MeanDecreaseAccuracy<-row.names(feature)

# plot(tmpRF_BC_CC)
pdf("RandomForest/BC_CC/varImpPlot_BC_CC_20220724.pdf")
varImpPlot(tmpRF_BC_CC, n.var = 15)
dev.off()

##prepare trains
trainsModel0<- BC_CC9[,names(BC_CC9) %in% feature$MeanDecreaseAccuracy]
trainsModel<-(trainsModel0)
trainsModel$label<-BC_CC9$label
##prepare valid
BCCC_valid10<-BCCC_valid9[,names(BCCC_valid9) %in% names(trainsModel)]
validsModel<-BCCC_valid10

#####compare data
library(DMwR)
trainsModel1<-trainsModel
validsModel1<-validsModel
##RAW
library(reshape2)
validsRaw<-melt(validsModel1, id.vars = c("label"))
validsRaw$label<-paste0("valids_",validsRaw$label)
trainsRaw<-melt(trainsModel1, id.vars = c("label"))
trainsRaw$label<-paste0("trains_",trainsRaw$label)
compareRaw<-rbind(validsRaw,trainsRaw)
p1<-ggplot(compareRaw,aes(compareRaw$value,fill=compareRaw$label))+geom_density(alpha=0.3)


###Feature selection
set.seed(2022)
folds <- createFolds(trainsModel$label,5)

##randomforest
for (aa in 15:7) {
accu <- c()
for (i in aa) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1:ncol(feature2)) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
for (k in 1:5) {
fold= as.vector(unlist(folds[1]))
trains <- data.frame(trainsModel[,result1])
trains$label<-trainsModel$label
trains_cross <- data.frame(trains[setdiff(1:dim(trains)[1],fold),])
test_cross <- data.frame(trains[fold,])
valids <- data.frame(validsModel[,result1])
valids$label <- validsModel$label
tmpRF_cross <- randomForest(as.factor(label) ~ . ,data=trains_cross,importance=T,ntree=1000,nodesize=1,proximity=T)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
predicts<- data.frame(predict(tmpRF,valids,type='prob'))
predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
predicts$observed <- valids$label
 ROC <- roc(predicts$observed, as.numeric(predicts$BC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
  train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("BC", "CC","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$BC))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
train_model_predict_cross<-data.frame(tmpRF_cross$votes,tmpRF_cross$predicted, trains_cross$label)
names(train_model_predict_cross)<-c("BC", "CC","predicted", "observed" )

ROC_train_model_predict_cross <- roc(train_model_predict_cross$observed, as.numeric(train_model_predict_cross$BC))
ROC_train_model_predict_auc_cross <- as.numeric(ROC_train_model_predict_cross[["auc"]])
predicts_cross<- data.frame(predict(tmpRF_cross,test_cross,type='prob'))
predicts_cross$predicted <- apply(predicts_cross,1,function(v){names(v)[max(v)==v]})
predicts_cross$observed <- test_cross$label
 ROC_cross <- roc(predicts_cross$observed, as.numeric(predicts_cross$BC))
         auc_cross <- as.numeric(ROC_cross[["auc"]])
      	 acc_cross <- sum(predicts_cross$predicted==predicts_cross$observed)
	 
      	 sum<-c(i,m, k,acc/53,auc,ROC_train_model_predict_auc,acc_cross/nrow(test_cross),auc_cross,ROC_train_model_predict_auc_cross )
         accu <- data.frame(rbind(accu,sum))
         
}
}
}
names(accu)<-c("i","m","k","acc","test_auc","train_auc","acc_cross","test_auc_cross","train_auc_cross")
accu1 <- accu
accu2<-aggregate(accu1[,-3],by=list(accu1$m,accu1$i),mean)
write.csv(accu2,paste0("RandomForest/BC_CC/",i,"accu2.csv"))
write.csv(accu1,paste0("RandomForest/BC_CC/",i,"accu1.csv"))
save.image()
}








##randomforest


accu <- c()
for (i in 15:7) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))

for (m in 1:ncol(feature2)) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
trains <- data.frame(trainsModel[,result1])
trains$label<-trainsModel$label
valids <- data.frame(validsModel[,result1])
valids$label <- validsModel$label
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("BC", "CC","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$BC))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
for (t in seq(0,0.3,0.05)) {
   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
   predicts$CC<-  predicts$CC + t
   predicts$BC<-  predicts$BC - t
   predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         
 predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$BC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, t,c( acc/53,auc, ROC_train_model_predict_auc))
         accu <- data.frame(rbind(accu,sum))
}
}
}


names(accu)<-c("i","m","CC_threshold","acc","test_auc","train_auc")
accu1 <- accu

write.csv(accu1,"RandomForest/accu1.csv")

for (aa in 1) {
  


accu <- c()
for (i in 4) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 160) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
trains <- data.frame(trainsModel[,result1])
trains$label<-trainsModel$label
valids <- data.frame(validsModel[,result1])
valids$label <- validsModel$label
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("BC", "CC","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$BC))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
 predicts<- data.frame(predict(tmpRF,valids,type='prob'))
 
  for (t in c(0.15)) {
   
    predicts<- data.frame(predict(tmpRF,valids,type='prob'))
    predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
 predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$BC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, t,c( acc/53,auc, ROC_train_model_predict_auc))
         accu <- data.frame(rbind(accu,sum))
}
}
 }


# proteins  "P01011_SERPINA3" "P13995_MTHFD2"   "P29084_GTF2E2"   "Q9BRX2_PELO"    
##Model ROC
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("BC", "CC","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$BC))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
pdf("RandomForest/ROC_BC_CC_train_model_predict_20220406.pdf")
plot(ROC_train_model_predict,cor="blue",main= ROC_train_model_predict_auc)
dev.off()

##Confusion matrix
tmpRF_comfusion<-data.frame(tmpRF$confusion)
sensitivity_tmpRF<-tmpRF_comfusion[1,1]/(tmpRF_comfusion[1,2]+tmpRF_comfusion[1,1])
specificity_tmpRF<-tmpRF_comfusion[2,2]/(tmpRF_comfusion[2,2]+tmpRF_comfusion[2,1])
PPV_tmpRF<-tmpRF_comfusion[1,1]/(tmpRF_comfusion[1,1]+tmpRF_comfusion[2,1])
NPV_tmpRF<-tmpRF_comfusion[2,2]/(tmpRF_comfusion[1,2]+tmpRF_comfusion[2,2])
train_model_statistics<-data.frame(sensitivity_tmpRF,specificity_tmpRF,PPV_tmpRF,NPV_tmpRF,ROC_train_model_predict_auc)
names(train_model_statistics)<-c("sensitivity","specificity","PPV","NPV","AUC")
write.csv(train_model_statistics,"RandomForest/BC_CC_train_model_statistics20220323.csv")

test_comfusion<-data.frame(c(8,1),c(1,17))
names(test_comfusion)<-c("BC","CC")
row.names(test_comfusion)<-c("BC","CC")
sensitivity_test<-test_comfusion[1,1]/(test_comfusion[1,2]+test_comfusion[1,1])
specificity_test<-test_comfusion[2,2]/(test_comfusion[2,2]+test_comfusion[2,1])
PPV_test<-test_comfusion[1,1]/(test_comfusion[1,1]+test_comfusion[2,1])
NPV_test<-test_comfusion[2,2]/(test_comfusion[1,2]+test_comfusion[2,2])
test_model_statistics<-data.frame(sensitivity_test,specificity_test,PPV_test,NPV_test,auc)
names(test_model_statistics)<-c("sensitivity","specificity","PPV","NPV","AUC")
write.csv(test_model_statistics,"RandomForest/BC_CC_test_model_statistics20220406.csv")

###model visualization
set.seed(2021)
source("common_change_label.R")
color<-c("red","blue")
train<-drawPCA(trains,ptColors = color,F,F)
valid<-drawPCA(valids,ptColors = color,F,F)
ggsave("RandomForest/DIA_BC_CC_PCA_20220323.pdf", plot = valid, device = NULL)

##roc
pdf("RandomForest/test_DIA_BC_CC_ROC_20220406.pdf")
plot(ROC,cor="blue",main= auc)
dev.off()

##point plot
  mean <- apply( valids[,-ncol(valids)],1,median)
  data <- data.frame(mean,predicts=predicts$CC,sample2=row.names(predicts),type2=predicts$observed )
  ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
    a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
      geom_point()+geom_vline(xintercept = 0.5-t ,linetype="dotted")+
      ggtitle(paste0(title,"_pointplot"))+
      xlab(xlab)+
      ylab(ylab)+
      xlim(0,1)+
      theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
            legend.title = element_text(size=15,color="black") ,
            panel.grid.major =element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            axis.line = element_line(colour = "black"))+
      scale_color_manual(values=c("#FDB462","#BC80BD"))+
      theme(panel.grid =element_blank())+
      theme(axis.text = element_text(size = 10,color = "black"))+
      theme(axis.text.x = element_text( hjust = 0.5))+
      theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
      theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
      theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
    ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
  }
  
  ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/DIA_BC_CC_PointPlot_20220405","predict value","median")
  
write.csv(valids,"RandomForest/BC_CC_proteins_in_valids.csv")
}

```

```{r DIA validation for AG_GG 20220316}

rm(list=ls())
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)
library(tidyverse)
library(stringr)
info<-read_excel("name.xlsx",sheet = 1)
info<-info[-grep("A20", info$sampleID),]
info$subtype<-paste0(info$PType,info$Location)
AG_GG_up<-read.csv("volcano/AG_GG_up.csv")
AG_GG_down<-read.csv("volcano/AG_GG_down.csv")
AG_GG<-rbind(AG_GG_up,AG_GG_down)
AG_GG2<-AG_GG[,-c(1,93:95)]
row.names(AG_GG2)<-AG_GG$X
AG_GG3<-data.frame(t(AG_GG2))
AG_GG3$batch<-row.names(AG_GG3)
AG_GG4<-merge(info,AG_GG3,by.x="batch",all=F)
AG_GG5<-AG_GG4[AG_GG4$subtype %in% c("AG","GG"),]
AG_GG6<-aggregate(AG_GG5[,-c(1:13)],  by=list(AG_GG5$pathology),  mean,na.rm=T)
names(AG_GG6)<-c("pathology",names(AG_GG6[,-1]))
AG_GG7<-merge(data.frame(unique(AG_GG5[,c("pathology","subtype")])),AG_GG6,by.x ="pathology",all.Y=F)
AG_GG8<-AG_GG7[,-1]
row.names(AG_GG8)<-AG_GG7$pathology
AG_GG9<-data.frame(AG_GG8[,1],(AG_GG8[,-1]))
names(AG_GG9)<-c("label",names(AG_GG9[,-1]))#####AG_GG9 is the training matrix

##over sample
# set.seed(2022)
# AG_GG9 <- ovun.sample(label ~ ., data = AG_GG9,method = "over",N = 90)$data

# set.seed(2020)
# AG_GG10<-data.frame(apply(AG_GG9[,-1],2, function(v){min(v,na.rm=T)}))
# AG_GG11<-data.frame(AG_GG9[,1])
# AG_GG11<-AG_GG11[,-1]
# for(i in 2:ncol(AG_GG9)){
# AG_GG10<-data.frame(AG_GG9[,i])
#  names(AG_GG10)<-names(AG_GG9)[i]
#  AG_GG10[is.na(AG_GG10)]<-min(AG_GG10,na.rm = T)
#  AG_GG11<-cbind(AG_GG11,AG_GG10)
# }
# row.names(AG_GG11)<-row.names(AG_GG9)
# AG_GG11$label<-AG_GG9$label
AGGG_valid<-read.table("matrix/DIA_validation/20211019KRUK_A_protein_matrix_rename.txt",sep = "\t",stringsAsFactors = F,header = T)
AGGG_valid2<-AGGG_valid
AGGG_valid4<-AGGG_valid2[,-c(1)]
row.names(AGGG_valid4)<-paste0(AGGG_valid2$prot)
AGGG_valid5<-data.frame(t(AGGG_valid4))
AG_valid<-AGGG_valid5[grep("AG",row.names(AGGG_valid5)),]
GG_valid<-AGGG_valid5[grep("GG",row.names(AGGG_valid5)),]
AGGG_valid6<-data.frame(rbind(AG_valid, GG_valid))
AGGG_sampleName<-data.frame(str_split_fixed(c(row.names(AGGG_valid6)),pattern = "_",10))
AGGG_sampleName2<-gsub("_rep","",AGGG_sampleName[,10])
AGGG_valid7<-aggregate(AGGG_valid6, by=list(AGGG_sampleName2), mean, na.rm=T)
AGGG_valid8<-AGGG_valid7[,-1]
AGGG_valid9<-log2(AGGG_valid8)
AGGG_valid9[is.na(AGGG_valid9)]<-0
row.names(AGGG_valid9)<-AGGG_valid7$Group.1
#select name from MRM
mrm<-read.csv("matrix/MRM_validation/KRUK_AG_GG_MRM_matrix.csv")
patient_name<- data.frame(str_split_fixed(names(mrm),"_",6))
patient_name$X5<-gsub(".Total.Area.Fragment","",patient_name$X5)
row.names(AGGG_valid9)<-gsub(".raw","",row.names(AGGG_valid9))
AGGG_valid10<-AGGG_valid9[row.names(AGGG_valid9) %in% patient_name$X5 , ]
AGGG_valid10$label<-row.names(AGGG_valid10)
AGGG_valid10$label<-gsub("[0-9]","",AGGG_valid10$label)
#####AGGG_valid10 is the test matrix

##missing value was imput by KNN






write.csv(AG_GG9,"RandomForest/TMP_run_KRUK/AG_GG/AG_GG9.csv",row.names = T)
write.csv(AGGG_valid10,"RandomForest/TMP_run_KRUK/AG_GG/AGGG_valid10.csv",row.names = T)



set.seed(2020)
tmpRF_AG_GG <- randomForest(as.factor(label) ~ . ,data=AG_GG9,importance=T,ntree=1000,nodesize=1)
result_AG_GG <- data.frame(importance(tmpRF_AG_GG,type=1))
feature<-result_AG_GG %>%  top_n(16, MeanDecreaseAccuracy)
feature$MeanDecreaseAccuracy<-row.names(feature)

# plot(tmpRF_AG_GG)
pdf("RandomForest/AG_GG/varImpPlot_AG_GG_20220729.pdf")
varImpPlot(tmpRF_AG_GG)
dev.off()

#prepare DIA test
validsModel<-AGGG_valid10[,names(AGGG_valid10) %in% feature$MeanDecreaseAccuracy]
validsModel$label<-AGGG_valid10$label

##prepare trains
trainsModel<- AG_GG9[,names(AG_GG9) %in% names(validsModel)]

feature<- data.frame(feature[feature$MeanDecreaseAccuracy %in% names(validsModel),])



###Feature selection
set.seed(2022)
folds <- createFolds(trainsModel$label,5)

##randomforest
for (aa in 3) {
accu <- c()
for (i in aa) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
##for (m in 1:ncol(feature2))
for (m in 202) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
for (k in 1:5) {
fold= as.vector(unlist(folds[1]))
trains <- data.frame(trainsModel[,result1])
trains$label<-trainsModel$label
trains_cross <- data.frame(trains[setdiff(1:dim(trains)[1],fold),])
test_cross <- data.frame(trains[fold,])
valids <- data.frame(validsModel[,result1])
valids$label <- validsModel$label
tmpRF_cross <- randomForest(as.factor(label) ~ . ,data=trains_cross,importance=T,ntree=1000,nodesize=1,proximity=T)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
predicts<- data.frame(predict(tmpRF,valids,type='prob'))
predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
predicts$observed <- valids$label
 ROC <- roc(predicts$observed, as.numeric(predicts$AG))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
  train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$AG))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
train_model_predict_cross<-data.frame(tmpRF_cross$votes,tmpRF_cross$predicted, trains_cross$label)
names(train_model_predict_cross)<-c("AG", "GG","predicted", "observed" )

ROC_train_model_predict_cross <- roc(train_model_predict_cross$observed, as.numeric(train_model_predict_cross$AG))
ROC_train_model_predict_auc_cross <- as.numeric(ROC_train_model_predict_cross[["auc"]])
predicts_cross<- data.frame(predict(tmpRF_cross,test_cross,type='prob'))
predicts_cross$predicted <- apply(predicts_cross,1,function(v){names(v)[max(v)==v]})
predicts_cross$observed <- test_cross$label
 ROC_cross <- roc(predicts_cross$observed, as.numeric(predicts_cross$AG))
         auc_cross <- as.numeric(ROC_cross[["auc"]])
      	 acc_cross <- sum(predicts_cross$predicted==predicts_cross$observed)
	 
      	 sum<-c(i,m, k,acc/26,auc,ROC_train_model_predict_auc,acc_cross/nrow(test_cross),auc_cross,ROC_train_model_predict_auc_cross )
         accu <- data.frame(rbind(accu,sum))
         
}
}
}
names(accu)<-c("i","m","k","acc","test_auc","train_auc","acc_cross","test_auc_cross","train_auc_cross")
accu1 <- accu
accu2<-aggregate(accu1[,-3],by=list(accu1$m,accu1$i),mean)
write.csv(accu2,paste0("RandomForest/AG_GG/",i,"accu2.csv"))
write.csv(accu1,paste0("RandomForest/AG_GG/",i,"accu1.csv"))

}

##best feature i=3 m3116
accu <- c()
for ( aa in 1 ) {
for (i in 3 ) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 316) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)

trains <- data.frame(trainsModel[,result1])
# trains<-data.frame(t(apply(trains,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trains$label<-trainsModel$label

valids <- data.frame(validsModel[,result1])
# valids<-data.frame(t(apply(valids,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
valids$label <- validsModel$label


set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$AG))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
 predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$AG))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/26,auc, ROC_train_model_predict_auc))
         accu <- data.frame(rbind(accu,sum))
   
          }
}

# O60831_PRAF2_O95125_ZNF202_P08572_COL4A2
##Model ROC
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$AG))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
pdf("RandomForest/ROC_train_model_predict_20220323.pdf")
plot(ROC_train_model_predict,cor="blue",main= ROC_train_model_predict_auc)
dev.off()

##Confusion matrix
tmpRF_comfusion<-data.frame(tmpRF$confusion)
sensitivity_tmpRF<-tmpRF_comfusion[1,1]/(tmpRF_comfusion[1,2]+tmpRF_comfusion[1,1])
specificity_tmpRF<-tmpRF_comfusion[2,2]/(tmpRF_comfusion[2,2]+tmpRF_comfusion[2,1])
PPV_tmpRF<-tmpRF_comfusion[1,1]/(tmpRF_comfusion[1,1]+tmpRF_comfusion[2,1])
NPV_tmpRF<-tmpRF_comfusion[2,2]/(tmpRF_comfusion[1,2]+tmpRF_comfusion[2,2])
train_model_statistics<-data.frame(sensitivity_tmpRF,specificity_tmpRF,PPV_tmpRF,NPV_tmpRF,ROC_train_model_predict_auc)
names(train_model_statistics)<-c("sensitivity","specificity","PPV","NPV","AUC")
write.csv(train_model_statistics,"RandomForest/train_model_statistics20220323.csv")

test_comfusion<-data.frame(c(8,1),c(1,17))
names(test_comfusion)<-c("AG","GG")
row.names(test_comfusion)<-c("AG","GG")
sensitivity_test<-test_comfusion[1,1]/(test_comfusion[1,2]+test_comfusion[1,1])
specificity_test<-test_comfusion[2,2]/(test_comfusion[2,2]+test_comfusion[2,1])
PPV_test<-test_comfusion[1,1]/(test_comfusion[1,1]+test_comfusion[2,1])
NPV_test<-test_comfusion[2,2]/(test_comfusion[1,2]+test_comfusion[2,2])
test_model_statistics<-data.frame(sensitivity_test,specificity_test,PPV_test,NPV_test,auc)
names(test_model_statistics)<-c("sensitivity","specificity","PPV","NPV","AUC")
write.csv(test_model_statistics,"RandomForest/test_model_statistics20220323.csv")

###model visualization
set.seed(2021)
source("common_change_label.R")
color<-c("red","blue")
train<-drawPCA(trains,ptColors = color,F,F)
row.names(valids)<-gsub(".Total.Area.Fragment","",row.names(valids))
row.names(valids)<-gsub("H20210803yixiao_KRUK_MRM_60min_","",row.names(valids))
row.names(valids)<-gsub("_20210805133011","",row.names(valids))
row.names(valids)<-gsub("_20210805144702","",row.names(valids))
valid<-drawPCA(valids,ptColors = color,F,F)
ggsave("RandomForest/DIA_AG_GG_PCA_20220323.pdf", plot = valid, device = NULL)

##roc
pdf("RandomForest/test_DIA_AG_GG_ROC_20220322.pdf")
plot(ROC,cor="blue",main= auc)
dev.off()

  ##point plot
  mean <- apply( valids[,-ncol(valids)],1,median)
  data <- data.frame(mean,predicts=predicts$GG,sample2=row.names(predicts),type2=predicts$observed )
  # data$sample2<-gsub(".Total.Area.Fragment","",data$sample2)
  # data$sample2<-gsub("H20210803yixiao_KRUK_MRM_60min_","",data$sample2)
  # data$sample2<-gsub("_20210805133011","",data$sample2)
  # data$sample2<-gsub("_20210805144702","",data$sample2)
  ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
    a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
      geom_point()+geom_vline(xintercept = 0.4 ,linetype="dotted")+
      ggtitle(paste0(title,"_pointplot"))+
      xlab(xlab)+
      ylab(ylab)+
      xlim(0,1)+
      theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
            legend.title = element_text(size=15,color="black") ,
            panel.grid.major =element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            axis.line = element_line(colour = "black"))+
      scale_color_manual(values=c("#FDB462","#BC80BD"))+
      theme(panel.grid =element_blank())+
      theme(axis.text = element_text(size = 10,color = "black"))+
      theme(axis.text.x = element_text( hjust = 0.5))+
      theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
      theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
      theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
    ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
  }
  
  ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/DIA_AG_GG_PointPlot_20220322","predict value","median")
  
write.csv(valids,"RandomForest/4proteins_in_valids.csv")
  

}

```


```{r AG_GG model performence visualiztion}

set.seed(2020)
AG_GG10<-data.frame(apply(AG_GG9[,-1],2, function(v){min(v,na.rm=T)}))
AG_GG11<-data.frame(AG_GG9[,1])
AG_GG11<-AG_GG11[,-1]
for(i in 2:ncol(AG_GG9)){
AG_GG10<-data.frame(AG_GG9[,i])
 names(AG_GG10)<-names(AG_GG9)[i]
 AG_GG10[is.na(AG_GG10)]<-min(AG_GG10,na.rm = T)
 AG_GG11<-cbind(AG_GG11,AG_GG10)
}
row.names(AG_GG11)<-row.names(AG_GG9)
AG_GG11$label<-AG_GG9$label
tmpRF_AG_GG <- randomForest(as.factor(label) ~ . ,data=AG_GG11,importance=T,ntree=5000,nodesize=1)
result_AG_GG <- data.frame(importance(tmpRF_AG_GG,type=1))
plot(tmpRF_AG_GG)
pdf("RandomForest/varImpPlot_AG_GG_20210906.pdf")
varImpPlot(tmpRF_AG_GG)
dev.off()
feature <- data.frame(row.names(result_AG_GG)[result_AG_GG$MeanDecreaseAccuracy>9])
##prepare trains
trainsModel<- AG_GG11[,names(AG_GG11) %in% feature$row.names.result_AG_GG..result_AG_GG.MeanDecreaseAccuracy...9.]
trainsModel$label<-AG_GG9$label

df3<-AG_GG11
feature <- data.frame(row.names(result_AG_GG)[result_AG_GG$MeanDecreaseAccuracy>9])


##best feature_num=3 feature_pos=1

accu <- c()

for (i in c(3)) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
  
for (m in c(1)) {
    
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
folds <- createFolds(df3$label,4)
select<-data.frame(combn(c(1:4),2))


    for(k in c(1:6)){
    a<-as.numeric(select[,k])
    fold= unlist(folds[a])
    # valids <- df3[,result1]
    valids <- data.frame(df3[fold,result1])
    names(valids)<-result1
  	valids$label <- df3$label[fold]
    
  	   trains <- data.frame(df3[setdiff(1:dim(df3)[1],fold),result1])
  	   names(trains)<-result1
  	   trains$label <- df3$label[setdiff(1:dim(df3)[1],fold)]
  	   trains$label <- as.factor(trains$label)
   	   set.seed(2020)
  	   tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1)
  	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
       predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
       predicts$observed <- valids$label
       ROC<- roc(predicts$observed, as.numeric(predicts$AG))
       
       assign(paste0("AG_GG_ROC",k),roc(predicts$observed, as.numeric(predicts$AG)))
       
       auc <- as.numeric(ROC[["auc"]])
    	 acc <- sum(predicts$predicted==predicts$observed)
    	 sum<-c(i,m,k, c(acc/length(fold),auc))
    	 
    	 accu <- data.frame(rbind(accu,sum))
  }

  }
  
}

pdf("RandomForest/AG_GG_model_3proteins_2021.pdf")
plot(AG_GG_ROC1,cor="white",main= mean(accu$X5))
 
library(RColorBrewer)
 
for (a in (1:6)){
  
plot.roc(get(paste0("AG_GG_ROC",a)),add=TRUE,col = brewer.pal(11, "Set3")[a])
}
best_feature_AG_GG<-result1
###"O95125_ZNF202" "P08572_COL4A2" "P35573_AGL"    "Q8IYJ3_SYTL1"  "Q9UQ16_DNM3" 
best_feature_AG_GG_matirx<- AG_GG8[,c("subtype",best_feature_AG_GG)]


# write.csv(best_feature_AG_GG_matirx,"best_feature_AG_GG_matirx_AG_GG.csv")



###PCA

train<-AG_GG11[,best_feature_AG_GG]
train$label<-AG_GG11$label

set.seed(2021.1)
source("common_change_label.R")
color<-c("red","blue")
train_pca<-drawPCA(train,ptColors = color,T,F)




```


```{r feature selection_BC_CC}
set.seed(2020)
BC_CC9[is.na(BC_CC9)]<-0
tmpRF_BC_CC <- randomForest(as.factor(label) ~ . ,data=BC_CC9,importance=T,ntree=5000,nodesize=1)
result_BC_CC <- data.frame(importance(tmpRF_BC_CC,type=1))
plot(tmpRF_BC_CC)
pdf("varImpPlot_BC_CC_20210412.pdf")
varImpPlot(tmpRF_BC_CC)

df3<-BC_CC9
feature <- data.frame(row.names(result_BC_CC)[result_BC_CC$MeanDecreaseAccuracy>8.25])
accu <- c()
for (i in 1:nrow(feature)) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1:ncol(feature2)) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
folds <- createFolds(df3$label,4)
select<-data.frame(combn(c(1:4),2))
for(k in c(1:6)){
    a<-as.numeric(select[,k])
    fold= unlist(folds[a])
    # valids <- df3[,result1]
    valids <- data.frame(df3[fold,result1])
    names(valids)<-result1
  	valids$label <- df3$label[fold]
    trains <- data.frame(df3[setdiff(1:dim(df3)[1],fold),result1])
  	names(trains)<-result1
  	trains$label <- df3$label[setdiff(1:dim(df3)[1],fold)]
  	trains$label <- as.factor(trains$label)
    set.seed(2020)
    	   tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
    	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$BC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m,k, c(acc/length(fold),auc))
         accu <- data.frame(rbind(accu,sum))
 }
  }
}
names(accu)<-c("feature_num","feature_pos","fold","acc","auc")
accu_sum<-accu
accu_sum2<-aggregate(accu_sum,by=list(accu_sum$feature_num,accu_sum$feature_pos),mean, na.rm=T)

write.csv(accu_sum2,"all_acc_BC_CC_RF.csv")

##best feature_num=5 feature_pos=207

accu <- c()

for (i in c(5)) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
  
for (m in c(207)) {
    
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
folds <- createFolds(df3$label,4)
select<-data.frame(combn(c(1:4),2))


    for(k in c(1:6)){
    a<-as.numeric(select[,k])
    fold= unlist(folds[a])
    # valids <- df3[,result1]
    valids <- data.frame(df3[fold,result1])
    names(valids)<-result1
  	valids$label <- df3$label[fold]
    
  	   trains <- data.frame(df3[setdiff(1:dim(df3)[1],fold),result1])
  	   names(trains)<-result1
  	   trains$label <- df3$label[setdiff(1:dim(df3)[1],fold)]
  	   trains$label <- as.factor(trains$label)
   	   set.seed(2020)
  	   tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1)
  	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
       predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
       predicts$observed <- valids$label
       ROC<- roc(predicts$observed, as.numeric(predicts$BC))
       assign(paste0("BC_CC_ROC",k),roc(predicts$observed, as.numeric(predicts$BC)))
       auc <- as.numeric(ROC[["auc"]])
    	 acc <- sum(predicts$predicted==predicts$observed)
    	 sum<-c(i,m,k, c(acc/length(fold),auc))
    	 
    	 accu <- data.frame(rbind(accu,sum))
  }

  }
  
}


pdf("BC_CC_ROC_prot_20210412.pdf")
plot(BC_CC_ROC1,cor="white",main= mean(accu$X5))
 library(RColorBrewer) 
for (b in c(1:6)){
  plot.roc(get(paste0("BC_CC_ROC",b)),add=TRUE,col = brewer.pal(11, "Set3")[b])
  
}

best_feature_BC_CC<-result1
##"P49746_THBS3"  "P83110_HTRA3"  "Q5TGY3_AHDC1"  "Q92777_SYN2"   "Q9P2B2_PTGFRN"

best_feature_BC_CC_matirx<- BC_CC8[,c("subtype",best_feature_BC_CC)]

write.csv(best_feature_BC_CC_matirx,"best_feature_BC_CC_matirx_BC_CC.csv")

```


```{r MRM validation for BC_CC tuning model}
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)
library(bestNormalize)
#select best  feature
library(randomForest)
mrmBC<-read.csv("matrix/MRM_validation/KRUK_BC_CC_MRM_matrix.csv")
set.seed(2020.1)
BC_CC9.1<-BC_CC9[,-1]
BC_CC9.5<-data.frame(apply(BC_CC9.1,2, function(v){sum(is.nan(v)/72)}))
BC_CC9.6<-data.frame(BC_CC9.1[,which(BC_CC9.5$apply.BC_CC9.1..2..function.v...< 1)])
BC_CC10<-data.frame(apply(BC_CC9.6,2, function(v){min(v,na.rm=T)}))
BC_CC11<-data.frame(BC_CC9[,1])
BC_CC11<-BC_CC11[,-1]
for(i in 1:ncol(BC_CC9.6)){
BC_CC10<-data.frame(BC_CC9.6[,i])
 names(BC_CC10)<-names(BC_CC9.6)[i]
 BC_CC10[is.na(BC_CC10)]<-min(BC_CC10,na.rm = T)
 BC_CC11<-cbind(BC_CC11,BC_CC10)
}
row.names(BC_CC11)<-row.names(BC_CC9.6)
BC_CC12<-BC_CC11[,names(BC_CC11) %in% mrmBC$Protein]
BC_CC12$label<-BC_CC9$label
set.seed(2020.1)
tmpRF_BC_CC <- randomForest(as.factor(label) ~ . ,data=BC_CC12,importance=T,ntree=5000,nodesize=1)
result_BC_CC <- data.frame(importance(tmpRF_BC_CC,type=1))

plot(tmpRF_BC_CC)
pdf("RandomForest/varImpPlot_BC_CC_20211007.pdf")
varImpPlot(tmpRF_BC_CC)
feature <- data.frame(row.names(result_BC_CC)[result_BC_CC$MeanDecreaseAccuracy>10])

##prepare trains
trainsModel<-BC_CC9[,names(BC_CC9) %in% feature$row.names.result_BC_CC..result_BC_CC.MeanDecreaseAccuracy...10. ]
trainsModel[is.na(trainsModel)]<-0



##data normalization
# trainsModel<-data.frame((apply(trainsModel,2,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trainsModel<-data.frame (apply(trainsModel,2,function(v){predict(bestNormalize(v))}))
# trainsModel<-data.frame (apply(trainsModel,2,function(v){predict(bestNormalize(v))}))
# trainsModel<-data.frame (log2 (((apply(trainsModel,2,function(v){(v/mean(v,na.rm=T))})))))
trainsModel$label<-BC_CC12$label

##prepare valids
test<-mrmBC[mrmBC$Protein %in% names(trainsModel),]
# test<-test[-which(test$Peptide %in% c("TPALSPQRPLTTQQPQSGTLK","YQVLDGEMYPPSVEEAPVLMHYPR","IYMADLESALHYILR","WSTSVFQR","EYDQALADLK")),]
test1<-aggregate(test[,-c(1:4)],by=list(test$Protein),mean,na.rm=T)
row.names(test1)<-test1$Group.1
test2<-data.frame(t(test1[,-1]))
testBC<-test2[grep("BC", row.names(test2)),]
testBC$subtype<-"BC"
testCC<-test2[grep("CC", row.names(test2)),]
testCC$subtype<-"CC"
test3<-data.frame(rbind(testBC,testCC))
test4<-log2(test3[,-ncol(test3)])
test4[test4< 0]<-0

##data normalization
# test4<-data.frame((apply(test4,2,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
# test4<-data.frame (log2 (((apply(test4,2,function(v){(v/mean(v,na.rm=T))})))))
# test4<-data.frame((apply(test4,2,function(v){(v/mean(v,na.rm=T))})))
test4<-data.frame (apply(test4,2,function(v){predict(bestNormalize(v))}))
test4$label<-test3$subtype
validsModel<-test4
row.names(validsModel)<-row.names(test3)


## feature select and build model

accu <- c()
for (i in 5) {
feature2 <-data.frame(combn(c(1:nrow(feature)),i))
for (m in 1:ncol(feature2)) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)

trains <- data.frame(trainsModel[,result1])

# trains<-data.frame((apply(trains,2,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
# trains<-data.frame (log2 (((apply(trains,2,function(v){(v/mean(v,na.rm=T))})))))

# trains<-data.frame (apply(trains,2,function(v){predict(bestNormalize(v))}))
# trains<-trains/ mean(as.matrix(trains))
# trains<-data.frame(t(apply(trains,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trains$label<-trainsModel$label
valids <- data.frame(validsModel[,result1])


# valids<-data.frame((apply(valids,2,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
# valids<-data.frame (log2(((apply(valids,2,function(v){(v/mean(v,na.rm=T))})))))
# valids<-data.frame (apply(valids,2,function(v){predict(bestNormalize(v))}))
# valids<-valids/ mean(as.matrix(valids))
# valids<-data.frame(t(apply(valids,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
valids$label <- validsModel$label
set.seed(2020.3)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree= 1000, nodesize=1,proximity=T)
    	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$CC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/52,auc))
         accu <- data.frame(rbind(accu,sum))
 }
}


 ##best feature i=5 m=104  "O00391_QSOX1" "P09471_GNAO1" "P49746_THBS3" "Q92777_SYN2"  "P62826_RAN"  
accu <- c()
for (i in 5) {
feature2 <-data.frame(combn(c(1:nrow(feature)),i))
for (m in 127) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)

trains <- data.frame(trainsModel[,result1])
# trains<-data.frame((apply(trains,2,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
# trains<-data.frame (log2 (((apply(trains,2,function(v){(v/mean(v,na.rm=T))})))))

# trains<-data.frame (apply(trains,2,function(v){predict(bestNormalize(v))}))
# trains<-trains/ mean(as.matrix(trains))
# trains<-data.frame(t(apply(trains,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trains$label<-trainsModel$label
valids <- data.frame(validsModel[,result1])


# valids<-data.frame((apply(valids,2,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
# valids<-data.frame (log2(((apply(valids,2,function(v){(v/mean(v,na.rm=T))})))))
# valids<-data.frame (apply(valids,2,function(v){predict(bestNormalize(v))}))
# valids<-valids/ mean(as.matrix(valids))
# valids<-data.frame(t(apply(valids,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
valids$label <- validsModel$label
set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree= 1000, nodesize=1,proximity=T)
    	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$CC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/52,auc))
         accu <- data.frame(rbind(accu,sum))
 }
}



###model visualization
set.seed(2021)
source("common_change_label.R")
color<-c("red","blue")
train<-drawPCA(trains,ptColors = color,F,F)
row.names(valids)<-gsub(".Total.Area.Fragment","",row.names(valids))
row.names(valids)<-gsub("H20210803yixiao_KRUK_MRM_60min_","",row.names(valids))
row.names(valids)<-gsub("_20210805133011","",row.names(valids))
row.names(valids)<-gsub("_20210805144702","",row.names(valids))
valid<-drawPCA(valids,ptColors = color,F,F)

ggsave("RandomForest/MRM_BC_CC_PCA_pointplot.pdf", plot = valid, device = NULL)

##roc
pdf("RandomForest/MRM_BC_CC_ROC.pdf")
plot(ROC,cor="blue",main= auc)
dev.off()

##point plot
mean <- apply( valids[,-4],1,median)



data <- data.frame(mean,predicts=predicts$CC,sample2=row.names(predicts),type2=predicts$observed )
data$mean<-round(as.numeric(data$mean),1)
data$sample2<-gsub(".Total.Area.Fragment","",data$sample2)
data$sample2<-gsub("H20210803yixiao_KRUK_MRM_60min_","",data$sample2)
data$sample2<-gsub("_20210805133011","",data$sample2)
data$sample2<-gsub("_20210805144702","",data$sample2)
ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
  a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
    geom_point()+geom_vline(xintercept = 0.5 ,linetype="dotted")+
    ggtitle(paste0(title,"_pointplot"))+
    xlab(xlab)+
    ylab(ylab)+
    xlim(0,1)+
    theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
          legend.title = element_text(size=15,color="black") ,
          panel.grid.major =element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"))+
    scale_color_manual(values=c("#FDB462","#BC80BD"))+
    theme(panel.grid =element_blank())+
    theme(axis.text = element_text(size = 10,color = "black"))+
    theme(axis.text.x = element_text( hjust = 0.5))+
    theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
    theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
    theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
  ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
}

ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/MRM_BC_CC_PointPlot_2021007","predict value","median")


```

```{r MRM validation for BC_CC}
#select best 10 feature
library(randomForest)
library(readxl)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)
library(smotefamily)

set.seed(2020)
BC_CC10<-data.frame(apply(BC_CC9[,-1],2, function(v){min(v,na.rm=T)}))
BC_CC11<-data.frame(BC_CC9[,1])
BC_CC11<-BC_CC11[,-1]
for(i in 2:ncol(BC_CC9)){
BC_CC10<-data.frame(BC_CC9[,i])
 names(BC_CC10)<-names(BC_CC9)[i]
 BC_CC10[is.na(BC_CC10)]<-min(BC_CC10,na.rm = T)
 BC_CC11<-cbind(BC_CC11,BC_CC10)
}
row.names(BC_CC11)<-row.names(BC_CC9)
BC_CC11$label<-BC_CC9$label
tmpRF_BC_CC <- randomForest(as.factor(label) ~ . ,data=BC_CC11,importance=T,ntree=5000,nodesize=1)
result_BC_CC <- data.frame(importance(tmpRF_BC_CC,type=1))
plot(tmpRF_BC_CC)
pdf("varImpPlot_BC_CC_20210412.pdf")
varImpPlot(tmpRF_BC_CC)
feature <- data.frame(row.names(result_BC_CC)[result_BC_CC$MeanDecreaseAccuracy>8])

##prepare pool
raw<-read.table("diann_KRUK_protein_20200828.txt",sep = "\t",stringsAsFactors = F,header = T,row.names = 1)
raw2<-raw[,grep("pool",names(raw))]
name<-data.frame(str_split_fixed(names(raw2),"_",6))
names(raw2)<-c(as.matrix(name$X5))
pool <- raw2[which(apply(raw2,1,function(x){ sum(x,na.rm = T) })>0),]
pool<-log2(pool)
pool1<-data.frame(apply(pool,1, function(v){mean(v,na.rm=T)}))
pool1$prtotein<-row.names(pool1)
pool2<-data.frame(pool1[row.names(pool1) %in% feature$row.names.result_BC_CC..result_BC_CC.MeanDecreaseAccuracy...8.,])
pool3<-data.frame(t(pool2))
pool4<-pool3[-2,]
row.names(pool4)<-"pool"

##prepare trains
# trainsModel0<- BC_CC9[,names(BC_CC9) %in% mrmBC$Protein]
# trainsModel0$label<-BC_CC9$label
# NAcount<-data.frame(apply(trainsModel0,1, function(v){sum(is.na(v))}))
# trainsModel0.5<-trainsModel0[-which((NAcount$apply.trainsModel0..1..function.v... >5)),]
trainsModel<-BC_CC11[,names(BC_CC11) %in% feature$row.names.result_BC_CC..result_BC_CC.MeanDecreaseAccuracy...8. ]
trainsModel$label<-BC_CC11$label

##prepare valids
mrmBC<-read.csv("matrix/MRM_validation/KRUK_BC_CC_MRM_matrix.csv")
test<-mrmBC[mrmBC$Protein %in% names(trainsModel),]
test<-aggregate(test[,-c(1:4)], by=list(test$Protein),mean)
# test<-test[-which(test$Peptide %in% c("TPALSPQRPLTTQQPQSGTLK","YQVLDGEMYPPSVEEAPVLMHYPR","IYMADLESALHYILR","WSTSVFQR","EYDQALADLK")),]
test1<-test[,-c(1)]
row.names(test1)<-test$Group.1
test2<-data.frame(t(test1))
testBC<-test2[grep("BC", row.names(test2)),]
testBC$subtype<-"BC"
testCC<-test2[grep("CC", row.names(test2)),]
testCC$subtype<-"CC"
test3<-data.frame(rbind(testBC,testCC))


##prepare valids
test4<-log2(test3[,-11])
test4[test4< 0]<-0
test4$label<-test3$subtype
validsModel<-test4

## feature select and build model
accu <- c()
for (i in 3:10) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1:ncol(feature2)) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
trains0 <- data.frame(trainsModel[,result1])

trains1<-SMOTE(trains0,trainsModel$label)$data

trains<-trains1[,-(i+1)]
# trains<-data.frame(t(apply(trains,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
# trains<-data.frame (t((apply(trains1[,-(i+1)],1,function(v){predict(bestNormalize(v,loo = TRUE))}))))
# names(trains)<-names(trains0)
trains<-data.frame((apply(trains,2,function(v){(v/mean(v,na.rm=T))})))
# names(trains)<-
trains<-trains/ mean(as.matrix(trains))
# trains<-data.frame(t(apply(trains,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trains$label<-trains1$class

valids <- data.frame(validsModel[,result1])
# valids<-data.frame(t(apply(valids,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
valids<-data.frame((apply(valids,2,function(v){(v/mean(v,na.rm=T))})))
# valids<-data.frame (t((apply(valids0,1,function(v){predict(bestNormalize(v,loo = TRUE))}))))

# names(valids)<-names(valids0)
# valids<-valids/ mean(as.matrix(valids))
# valids<-data.frame(t(apply(valids,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
valids$label <- validsModel$label
set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T,classwt=c(BC= 1, CC=0.5))
    	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$CC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/52,auc))
         accu <- data.frame(rbind(accu,sum))
 }
  }
accu1<-accu


##best feature i=5 m=6076
accu <- c()

for (i in 3) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 67) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
trains0 <- data.frame(trainsModel[,result1])

trains1<-SMOTE(trains0,trainsModel$label)$data

trains<-trains1[,-(i+1)]
# trains<-data.frame(t(apply(trains,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
# trains<-data.frame (t((apply(trains1[,-(i+1)],1,function(v){predict(bestNormalize(v,loo = TRUE))}))))
# names(trains)<-names(trains0)
trains<-data.frame((apply(trains,2,function(v){(v/mean(v,na.rm=T))})))
# names(trains)<-
trains<-trains/ mean(as.matrix(trains))
# trains<-data.frame(t(apply(trains,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trains$label<-trains1$class

valids <- data.frame(validsModel[,result1])
# valids<-data.frame(t(apply(valids,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
valids<-data.frame((apply(valids,2,function(v){(v/mean(v,na.rm=T))})))
# valids<-data.frame (t((apply(valids0,1,function(v){predict(bestNormalize(v,loo = TRUE))}))))

# names(valids)<-names(valids0)
# valids<-valids/ mean(as.matrix(valids))
# valids<-data.frame(t(apply(valids,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
valids$label <- validsModel$label
set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
    	   predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$CC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/52,auc))
         accu <- data.frame(rbind(accu,sum))
 }
  }

###model visualization
set.seed(2021)
source("common_change_label.R")
color<-c("red","blue")
train<-drawPCA(trains,ptColors = color,F,F)
row.names(valids)<-gsub(".Total.Area.Fragment","",row.names(valids))
row.names(valids)<-gsub("H20210803yixiao_KRUK_MRM_60min_","",row.names(valids))
row.names(valids)<-gsub("_20210805133011","",row.names(valids))
row.names(valids)<-gsub("_20210805144702","",row.names(valids))
valid<-drawPCA(valids,ptColors = color,F,F)

ggsave("RandomForest/MRM_BC_CC_PCA_20210823_pointplot.pdf", plot = valid, device = NULL)

##roc
pdf("RandomForest/MRM_BC_CC_ROC_20210823.pdf")
plot(ROC,cor="blue",main= auc)
dev.off()

##point ploy
mean <- apply( valids[,-4],1,median)
data <- data.frame(mean,predicts=predicts$CC,sample2=row.names(predicts),type2=predicts$observed )
data$sample2<-gsub(".Total.Area.Fragment","",data$sample2)
data$sample2<-gsub("H20210803yixiao_KRUK_MRM_60min_","",data$sample2)
data$sample2<-gsub("_20210805133011","",data$sample2)
data$sample2<-gsub("_20210805144702","",data$sample2)
ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
  a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
    geom_point()+geom_vline(xintercept = 0.5 ,linetype="dotted")+
    ggtitle(paste0(title,"_pointplot"))+
    xlab(xlab)+
    ylab(ylab)+
    xlim(0,1)+
    theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
          legend.title = element_text(size=15,color="black") ,
          panel.grid.major =element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"))+
    scale_color_manual(values=c("#FDB462","#BC80BD"))+
    theme(panel.grid =element_blank())+
    theme(axis.text = element_text(size = 10,color = "black"))+
    theme(axis.text.x = element_text( hjust = 0.5))+
    theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
    theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
    theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
  ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
}

ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/MRM_BC_CC_PointPlot_20210823","predict value","median")


```


```{r split BC_CC for validation for BC_CC}
rm(list=ls())
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)
library(clusterProfiler)
library(org.Hs.eg.db)
info<-read_excel("name.xlsx",sheet = 1)
info<-info[-grep("A20", info$sampleID),]
info$subtype<-paste0(info$PType,info$Location)
BC_CC<-read.csv("volcano/BC_CC_all2021111.csv")
proteinID<-bitr(BC_CC$X, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db")
names(proteinID)<-c("X","gene")
BC_CC1<-merge(proteinID,BC_CC,by.x="X", all.x=F,all.y=T)
BC_CC2<-BC_CC1[,-c(1:2,97:99)]
row.names(BC_CC2)<-paste0(BC_CC1$X,"_",BC_CC1$gene)
BC_CC3<-data.frame(t(BC_CC2))
BC_CC3.5<-data.frame(2^BC_CC3)
BC_CC3.5$batch<-row.names(BC_CC3)
BC_CC4<-merge(info,BC_CC3.5,by.x="batch",all=F)
BC_CC5<-BC_CC4[BC_CC4$subtype %in% c("BC","CC"),]
BC_CC6<-aggregate(BC_CC5[-c(1:13)], by=list(BC_CC5$pathology,BC_CC5$subtype),mean,na.rm=T)
BC_CC7<-log2(BC_CC6[,-c(1:2)])
row.names(BC_CC7)<-BC_CC6$Group.1
BC_CC7$label<-BC_CC6$Group.2
set.seed(2021)
fold<-createFolds(BC_CC7$label,3,list = T)
BC_CC_trian_model<-BC_CC7[c(fold$Fold1,fold$Fold2),]
BC_CC_test_model<-BC_CC7[c(fold$Fold3),]


# BC_CC5_train<-BC_CC5[grep(c("b1_|b2_|b3_|b4_|b5_|b6_|b7_|b8_|b9_|b10_|b11_|b12_|b13_|b14_"),BC_CC5$batch ),]
# BC_CC5_test<-BC_CC5[grep(c("b15_|b16_|b17_|b18_|b19_|b20_|b21_|b22_|b23_"),BC_CC5$batch ),]
# BC_CC6<-aggregate(BC_CC5_train[,-c(1:13)],  by=list(BC_CC5_train$pathology),  mean,na.rm=T)
# names(BC_CC6)<-c("pathology",names(BC_CC6[,-1]))
# BC_CC7<-merge(data.frame(unique(BC_CC5_train[,c("pathology","subtype")])),BC_CC6,by.x ="pathology",all.Y=F)
# BC_CC8<-BC_CC7[,-1]
# row.names(BC_CC8)<-BC_CC7$pathology
# BC_CC9<-data.frame(BC_CC8[,1],(BC_CC8[,-1]))
# names(BC_CC9)<-c("label",names(BC_CC9[,-1]))#####BC_CC9 is the training matrix
# BC_CC_trian_model<-BC_CC9

# BC_CC6<-aggregate(BC_CC5_test[,-c(1:13)],  by=list(BC_CC5_test$pathology),  mean,na.rm=T)
# names(BC_CC6)<-c("pathology",names(BC_CC6[,-1]))
# BC_CC7<-merge(data.frame(unique(BC_CC5_test[,c("pathology","subtype")])),BC_CC6,by.x ="pathology",all.Y=F)
# BC_CC8<-BC_CC7[,-1]
# row.names(BC_CC8)<-BC_CC7$pathology
# BC_CC9<-data.frame(BC_CC8[,1],(BC_CC8[,-1]))
# names(BC_CC9)<-c("label",names(BC_CC9[,-1]))#####BC_CC9 is the training matrix
# BC_CC_test_model<-BC_CC9


library(randomForest)
library(readxl)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)
library(smotefamily)

set.seed(2020)
tmpRF_BC_CC <- randomForest(as.factor(label) ~ . ,data=BC_CC_trian_model,importance=T,ntree=5000,nodesize=1)
result_BC_CC <- data.frame(importance(tmpRF_BC_CC,type=1))
plot(tmpRF_BC_CC)
pdf("RandomForest/varImpPlot_BC_CC_split_genename_20211116.pdf")
varImpPlot(tmpRF_BC_CC)
feature <- data.frame(row.names(result_BC_CC)[result_BC_CC$MeanDecreaseAccuracy>4.7])
dev.off()
trainsModel<-BC_CC_trian_model
validsModel<-BC_CC_test_model

accu <- c()
for (i in 2:6) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1:ncol(feature2)) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)

trains <- data.frame(trainsModel[,result1])
# trains<-data.frame(t(apply(trains,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trains$label<-trainsModel$label

valids <- data.frame(validsModel[,result1])
# valids<-data.frame(t(apply(valids,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
valids$label <- validsModel$label
set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("BC", "CC","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$BC))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
 predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$BC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/25,auc, ROC_train_model_predict_auc))
         accu <- data.frame(rbind(accu,sum))
   
          }
}

names(accu)<-c("i","m","acc","test_auc","train_auc")
accu1 <- accu


##best feature i=3 m=83
accu <- c()
for (i in 3) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 83) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)

trains <- data.frame(trainsModel[,result1])
# trains<-data.frame(t(apply(trains,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
trains$label<-trainsModel$label

valids <- data.frame(validsModel[,result1])
# valids<-data.frame(t(apply(valids,1,function(v){(v-mean(v,na.rm=T))/sd(v,na.rm=T)})))
valids$label <- validsModel$label
set.seed(2020)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("BC", "CC","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$BC))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
 predicts<- data.frame(predict(tmpRF,valids,type='prob'))
         predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
         predicts$observed <- valids$label
         ROC <- roc(predicts$observed, as.numeric(predicts$BC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
      	 sum<-c(i,m, c(acc/25,auc, ROC_train_model_predict_auc))
         accu <- data.frame(rbind(accu,sum))
   
          }
}




names(accu)<-c("i","m","acc","test_auc","train_auc")

# "P55209" "Q08752" "Q14694"

##Model ROC
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("BC", "CC","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$BC))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
pdf("RandomForest/BC_CC_ROC_train_model_predict20211116.pdf")
plot(ROC_train_model_predict,cor="blue",main= ROC_train_model_predict_auc)
dev.off()

##Confusion matrix
tmpRF_comfusion<-data.frame(tmpRF$confusion)
sensitivity_tmpRF<-tmpRF_comfusion[1,1]/(tmpRF_comfusion[1,2]+tmpRF_comfusion[1,1])
specificity_tmpRF<-tmpRF_comfusion[2,2]/(tmpRF_comfusion[2,2]+tmpRF_comfusion[2,1])
PPV_tmpRF<-tmpRF_comfusion[1,1]/(tmpRF_comfusion[1,1]+tmpRF_comfusion[2,1])
NPV_tmpRF<-tmpRF_comfusion[2,2]/(tmpRF_comfusion[1,2]+tmpRF_comfusion[2,2])
train_model_statistics<-data.frame(sensitivity_tmpRF,specificity_tmpRF,PPV_tmpRF,NPV_tmpRF,ROC_train_model_predict_auc)
names(train_model_statistics)<-c("sensitivity","specificity","PPV","NPV","AUC")
write.csv(train_model_statistics,"RandomForest/train_model_statistics.csv")

test_comfusion<-data.frame(c(8,1),c(1,17))
names(test_comfusion)<-c("AG","GG")
row.names(test_comfusion)<-c("AG","GG")
sensitivity_test<-test_comfusion[1,1]/(test_comfusion[1,2]+test_comfusion[1,1])
specificity_test<-test_comfusion[2,2]/(test_comfusion[2,2]+test_comfusion[2,1])
PPV_test<-test_comfusion[1,1]/(test_comfusion[1,1]+test_comfusion[2,1])
NPV_test<-test_comfusion[2,2]/(test_comfusion[1,2]+test_comfusion[2,2])
test_model_statistics<-data.frame(sensitivity_test,specificity_test,PPV_test,NPV_test,auc)
names(test_model_statistics)<-c("sensitivity","specificity","PPV","NPV","AUC")
write.csv(test_model_statistics,"RandomForest/test_model_statistics.csv")

###model visualization
set.seed(2021)
source("common_change_label.R")
color<-c("red","blue")
train<-drawPCA(trains,ptColors = color,F,F)
row.names(valids)<-gsub(".Total.Area.Fragment","",row.names(valids))
row.names(valids)<-gsub("H20210803yixiao_KRUK_MRM_60min_","",row.names(valids))
row.names(valids)<-gsub("_20210805133011","",row.names(valids))
row.names(valids)<-gsub("_20210805144702","",row.names(valids))
valid<-drawPCA(valids,ptColors = color,F,F)

ggsave("RandomForest/BC_CC_split_20211112_pca.pdf", plot = valid, device = NULL)

##roc
pdf("RandomForest/BC_CC_test_ROC_split20211116.pdf")
plot(ROC,cor="blue",main= auc)
dev.off()

##point ploy

valids2<-scale(valids[,-4])
mean <- apply( valids2,1,mean)
data <- data.frame(mean,predicts=predicts$CC,sample2=row.names(predicts),type2=predicts$observed )
data$sample2<-gsub(".Total.Area.Fragment","",data$sample2)
data$sample2<-gsub("H20210803yixiao_KRUK_MRM_60min_","",data$sample2)
data$sample2<-gsub("_20210805133011","",data$sample2)
data$sample2<-gsub("_20210805144702","",data$sample2)
ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
  a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
    geom_point()+geom_vline(xintercept = 0.43 ,linetype="dotted")+
    ggtitle(paste0(title,"_pointplot"))+
    xlab(xlab)+
    ylab(ylab)+
    xlim(0,1)+
    theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
          legend.title = element_text(size=15,color="black") ,
          panel.grid.major =element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"))+
    scale_color_manual(values=c("#FDB462","#BC80BD"))+
    theme(panel.grid =element_blank())+
    theme(axis.text = element_text(size = 10,color = "black"))+
    theme(axis.text.x = element_text( hjust = 0.5))+
    theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
    theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
    theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
  ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
}

ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/BC_CC_test_split_PointPlot_20211116","predict value","mean")

```

```{r build model_BC_CC}
set.seed(2021)
BC_CC_model<-BC_CC9[,c("label",best_feature_BC_CC)]
BC_CC_model$label<-as.factor(BC_CC_model$label)
library(varSelRF)
library(e1071)
aa<-tune.randomForest(as.factor(label) ~.,data =BC_CC_model,nodesize =seq(1,10,1),mtry = 1, ntree   = seq(100,2000,100))
                      
BC_CC_RF<- randomForest(as.factor(label) ~ . ,data=BC_CC_model,importance=T,ntree=100,nodesize=3,proximity= TRUE,mtry=1)
pdf("BC_CC_RF_visual_20210412.pdf")
MDSplot(BC_CC_RF,BC_CC_model$label,palette = c(brewer.pal(9, "YlOrRd")[6],brewer.pal(11, "RdBu")[9]))


predicts<- data.frame(predict(BC_CC_RF,BC_CC_model,type='prob'))
predicts$observed <- BC_CC_model$label
ROC<- roc(predicts$observed, as.numeric(predicts$BC)) 
auc <- as.numeric(ROC[["auc"]]) 
pdf("BC_CC_RF_auc.pdf")
BC_CC_RF_auc<-plot(ROC,main = paste0("auc=",auc))
varImpPlot(BC_CC_RF)

```

```{r heatmap for 6 proteins}
rm(list = ls())

library(ggplot2)
library(RColorBrewer)
library(pheatmap)
library(readxl)
BC_CC<-read.csv("RandomForest/3_proteins_RF_BC_CC.csv")
name<-read_xlsx("name.xlsx",sheet = 1)
names(BC_CC)<-c("batch",names(BC_CC[,-1]))
label2<-merge(BC_CC,name,by.x="batch",all=F)
BC_CC2<-label2[,c(3,4,5,7)]
BC_CC3<-aggregate(BC_CC2[,-4],by=list(BC_CC2$pathology),mean,na.rm=T)
BC_CC3[is.na(BC_CC3)]<-NA
names(BC_CC3)<-c("pathology",names(BC_CC3[,-1]))
BC_CC4<-merge(BC_CC3,data.frame(unique(name[,c(2,4,7)])),by.x="pathology",all = F)
BC_CC4$subtype<-paste0(BC_CC4$PType,BC_CC4$Location)
BC_CC5<-BC_CC4[order(BC_CC4$subtype),]
row.names(BC_CC5)<-BC_CC5$pathology
annotation_col<- data.frame(type = factor(BC_CC5$subtype,levels = c("BC","CC")),row.names = BC_CC5$pathology)
type_color <- c("#80AA31","#D9942C") 
# type_color <- c("#80AA31","#5B7BAA","#D9942C","#8C2826")
names(type_color) <- c("BC","CC")
ann_colors <- list(type=type_color)
colors = c( brewer.pal(11,"RdYlGn")[9:2])
df2<-data.frame(t(BC_CC5[,c(2,3,4)]),check.names = F)
df2[is.na(df2)]<-NA



pheatmap(df2,scale="row",color = colors, annotation_col = annotation_col,
         annotation_colors = ann_colors, fontsize_col = 10, cluster_rows = F, cluster_cols = F,show_rownames =T, show_colnames =F ,fontsize = 10,cellwidth=10,cellheight=10,filename = "heatmap/BC_CC_3prot_heatmap.pdf",main = paste0("BC_CC"))

AG_GG<-read.csv("RandomForest/3_proteins_RF_AG_GG.csv")
name<-read_xlsx("name.xlsx",sheet = 1)
names(AG_GG)<-c("batch",names(AG_GG[,-1]))
label2<-merge(AG_GG,name,by.x="batch",all=F)
AG_GG2<-label2[,c(3,4,5,7)]
AG_GG3<-aggregate(AG_GG2[,-4],by=list(AG_GG2$pathology),mean,na.rm=T)
AG_GG3[is.na(AG_GG3)]<-NA
names(AG_GG3)<-c("pathology",names(AG_GG3[,-1]))
AG_GG4<-merge(AG_GG3,data.frame(unique(name[,c(2,4,7)])),by.x="pathology",all = F)
AG_GG4$subtype<-paste0(AG_GG4$PType,AG_GG4$Location)
AG_GG5<-AG_GG4[order(AG_GG4$subtype),]
row.names(AG_GG5)<-AG_GG5$pathology
annotation_col<- data.frame(type = factor(AG_GG5$subtype,levels = c("AG","GG")),row.names = AG_GG5$pathology)
type_color <- c("#D9942C","#8C2826") 
# type_color <- c("#80AA31","#5B7BAA","#D9942C","#8C2826")
names(type_color) <- c("AG","GG")
ann_colors <- list(type=type_color)
colors = c( brewer.pal(11,"RdYlGn")[9:2])
df2<-data.frame(t(AG_GG5[,c(2,3,4)]),check.names = F)
df2[is.na(df2)]<-NA


pheatmap(df2,scale="row",color = colors, annotation_col = annotation_col,
         annotation_colors = ann_colors, fontsize_col = 10, cluster_rows = F, cluster_cols = F,show_rownames =T, show_colnames =F ,fontsize = 10,cellwidth=10,cellheight=10,filename = "heatmap/AG_GG_3prot_heatmap.pdf",main = paste0("AG_GG"))


```


```{r heatmap for volcanoplot proteins in AG_GG and BC_CC}
rm(list = ls())
library(ggplot2)
library(RColorBrewer)
library(pheatmap)
library(readxl)
source("datamining_library_ge20200902.R")
##AG_GG 
AG_GG_down<-read.csv("volcano/AG_GG_down.csv")
AG_GG_up<-read.csv("volcano/AG_GG_up.csv")
AG_GG<-rbind(AG_GG_down,AG_GG_up)
AG_GG0<-AG_GG[,-1]
row.names(AG_GG0)<-AG_GG$X
AG_GG<-data.frame(t(AG_GG0))
AG_GG$batch<-row.names(AG_GG)
name<-read_xlsx("name.xlsx",sheet = 1)
name<-name[-grep("A20",name$sampleID),]
label2<-merge(AG_GG,name,by.x="batch",all=F)
AG_GG2<-label2[,names(label2) %in% c("pathology",names(AG_GG[,-ncol(AG_GG)]))]
AG_GG3<-aggregate(AG_GG2[,-ncol(AG_GG2)],by=list(AG_GG2$pathology),mean,na.rm=T)
AG_GG3[is.na(AG_GG3)]<-NA
names(AG_GG3)<-c("pathology",names(AG_GG3[,-1]))
AG_GG4<-merge(AG_GG3,data.frame(unique(name[,c(2,3,4,7)])),by.x="pathology",all = F)
AG_GG4$subtype<-paste0(AG_GG4$PType,AG_GG4$Location)
AG_GG5<-AG_GG4[order(AG_GG4$subtype),]
row.names(AG_GG5)<-AG_GG5$pathology
annotation_col<- data.frame(type = factor(AG_GG5$subtype,levels = c("AG","GG")),age=AG_GG5$Age, row.names = AG_GG5$pathology)
type_color <- c("#80AA31","#5B7BAA")
names(type_color) <- c("AG","GG")
ann_colors <- list(type=type_color)
colors0 = c( brewer.pal(11,"Blues")[9:4], brewer.pal(11,"Blues")[1],brewer.pal(11,"Reds")[2], brewer.pal(11,"Reds")[4:9])
colors<-colorRampPalette(colors0)(10000)
df2<-data.frame(t(AG_GG5[,-which(names(AG_GG5) %in% c("pathology","Age","PType","Location","subtype"))]),check.names = F)
df2[is.na(df2)]<-min(df2,na.rm = T)

df3<-df2


pheatmap(df3,scale="row",color = colors, annotation_col = annotation_col,
         annotation_colors = ann_colors, fontsize_col = 10, cluster_rows = T, cluster_cols = F,show_rownames =F, show_colnames =F ,fontsize = 10,cellwidth=1,cellheight=1,filename = "heatmap/AG_GG_volcano_prot_heatmap_20200316.pdf",main = paste0("AG_GG"))

# BC_CC
BC_CC_down<-read.csv("volcano/BC_CC_down.csv")
BC_CC_up<-read.csv("volcano/BC_CC_up.csv")
BC_CC<-rbind(BC_CC_down,BC_CC_up)
BC_CC0<-BC_CC[,-1]
row.names(BC_CC0)<-BC_CC$X
BC_CC<-data.frame(t(BC_CC0))
BC_CC$batch<-row.names(BC_CC)
name<-read_xlsx("name.xlsx",sheet = 1)
label2<-merge(BC_CC,name,by.x="batch",all=F)
BC_CC2<-label2[,names(label2) %in% c("pathology",names(BC_CC[,-ncol(BC_CC)]))]
BC_CC3<-aggregate(BC_CC2[,-ncol(BC_CC2)],by=list(BC_CC2$pathology),mean,na.rm=T)
BC_CC3[is.na(BC_CC3)]<-NA
names(BC_CC3)<-c("pathology",names(BC_CC3[,-1]))
BC_CC4<-merge(BC_CC3,data.frame(unique(name[,c(2,3,4,7)])),by.x="pathology",all = F)
BC_CC4$subtype<-paste0(BC_CC4$PType,BC_CC4$Location)
BC_CC5<-BC_CC4[order(BC_CC4$subtype),]

row.names(BC_CC5)<-BC_CC5$pathology
annotation_col<- data.frame(type = factor(BC_CC5$subtype,levels = c("BC","CC")),age=BC_CC5$Age, row.names = BC_CC5$pathology)
type_color <- c("#D9942C","#8C2826")

names(type_color) <- c("BC","CC")
ann_colors <- list(type=type_color)
colors0 = c( brewer.pal(11,"Blues")[9:4], brewer.pal(11,"Blues")[1],brewer.pal(11,"Reds")[1], brewer.pal(11,"Reds")[4:9])
colors<-colorRampPalette(colors0)(10000)

df2<-data.frame(t(BC_CC5[,-which(names(BC_CC5) %in% c("pathology","Age","PType","Location","subtype"))]),check.names = F)
df2[is.na(df2)]<-min(df2,na.rm = T)
df3<-df2
pheatmap(df3,scale="row",color = colors, annotation_col = annotation_col,
         annotation_colors = ann_colors, fontsize_col = 10, cluster_rows = T, cluster_cols = F,show_rownames =F, show_colnames =F ,fontsize = 10,cellwidth=1,cellheight=0.18,filename = "heatmap/BC_CC_volcano_prot_heatmap_20200316.pdf",main = paste0("BC_CC"))
```

```{r heatmap for overlappped proteins in AG_GG and BC_CC}
##overlapped 23prot
df1<-AG_GG
df2<-BC_CC
df3<-df1[, which(names(df1)%in% names(df2))]
prot<-c(as.matrix(names(df3)))

##AG_GG 
AG_GG_down<-read.csv("volcano/AG_GG_down.csv")
AG_GG_up<-read.csv("volcano/AG_GG_up.csv")
AG_GG<-rbind(AG_GG_down,AG_GG_up)
AG_GG0<-AG_GG[,-1]
row.names(AG_GG0)<-AG_GG$X
AG_GG<-data.frame(t(AG_GG0))
AG_GG$batch<-row.names(AG_GG)
name<-read_xlsx("name.xlsx",sheet = 1)
name<-name[-grep("A20",name$sampleID),]
label2<-merge(AG_GG,name,by.x="batch",all=F)
AG_GG2<-label2[,names(label2) %in% c("pathology",prot)]
AG_GG3<-aggregate(AG_GG2[,-c(ncol(AG_GG2))],by=list(AG_GG2$pathology),mean,na.rm=T)
AG_GG3[is.na(AG_GG3)]<-NA
names(AG_GG3)<-c("pathology",names(AG_GG3[,-1]))
AG_GG4<-merge(AG_GG3,data.frame(unique(name[,c(2,3,4,7)])),by.x="pathology",all = F)
AG_GG4$subtype<-paste0(AG_GG4$PType,AG_GG4$Location)
AG_GG5<-AG_GG4[order(AG_GG4$subtype),]
all<-rbind(AG_GG5)
row.names(all)<-all$pathology
annotation_col<- data.frame(type = factor(all$subtype,levels = c("AG","GG")),age=all$Age, row.names = all$pathology)
type_color <- c("#80AA31","#5B7BAA")
names(type_color) <- c("AG","GG")
ann_colors <- list(type=type_color)
df2<-data.frame(t(all[,c(3:48)]),check.names = F)
df3<-df2
df3[is.na(df3)]<-min(df3,na.rm = T)
colors0 = c( brewer.pal(11,"Blues")[9:4], brewer.pal(11,"Blues")[1],brewer.pal(11,"Reds")[2], brewer.pal(11,"Reds")[4:9])
colors<-colorRampPalette(colors0)(10000)
a<-pheatmap(df3,scale = "row",color = colors, annotation_col = annotation_col,
           annotation_colors = ann_colors, fontsize_col = 10, cluster_rows = T, cluster_cols = F,show_rownames =T, show_colnames =F ,fontsize = 10,cellwidth=2,cellheight=10,filename = "heatmap/AG_GG_overlapped_46prot_heatmap_20220316.pdf",main = paste0(""))
AG_GG_overlap<-df3
AG_GG_overlap_annotation_col<-annotation_col
AG_GG_order<-df3[a$tree_row$order,]



##AG_GG BC_CC
BC_CC_down<-read.csv("volcano/BC_CC_down.csv")
BC_CC_up<-read.csv("volcano/BC_CC_up.csv")
BC_CC<-rbind(BC_CC_down,BC_CC_up)
BC_CC0<-BC_CC[,-1]
row.names(BC_CC0)<-BC_CC$X
BC_CC<-data.frame(t(BC_CC0))
BC_CC$batch<-row.names(BC_CC)
name<-read_xlsx("name.xlsx",sheet = 1)
label2<-merge(BC_CC,name,by.x="batch",all=F)
BC_CC2<-label2[,names(label2) %in% c("pathology",prot)]
BC_CC3<-aggregate(BC_CC2[,-ncol(BC_CC2)],by=list(BC_CC2$pathology),mean,na.rm=T)
BC_CC3[is.na(BC_CC3)]<-NA
names(BC_CC3)<-c("pathology",names(BC_CC3[,-1]))
BC_CC4<-merge(BC_CC3,data.frame(unique(name[,c(2,3,4,7)])),by.x="pathology",all = F)
BC_CC4$subtype<-paste0(BC_CC4$PType,BC_CC4$Location)
BC_CC5<-BC_CC4[order(BC_CC4$subtype),]

all<-rbind(BC_CC5)

row.names(all)<-all$pathology
annotation_col<- data.frame(type = factor(all$subtype,levels = c("BC","CC")),age=all$Age, row.names = all$pathology)
type_color <- c("#D9942C","#8C2826")

names(type_color) <- c("BC","CC")
ann_colors <- list(type=type_color)
df2<-data.frame(t(all[,c(3:48)]),check.names = F)
df2[is.na(df2)]<-min(df2,na.rm=T)
AG_GG_order2<-as.character(c(row.names(AG_GG_order)))
df3<-df2[AG_GG_order2,]
# colors<-colorRampPalette(c("dodgerblue4","dodgerblue3","white","firebrick3", "firebrick4"))(10000)
colors0 = c( brewer.pal(11,"Blues")[9:4], brewer.pal(11,"Blues")[1],brewer.pal(11,"Reds")[2], brewer.pal(11,"Reds")[4:9])
colors<-colorRampPalette(colors0)(10000)
pheatmap(df3,scale="row",color = colors, annotation_col = annotation_col,
         annotation_colors = ann_colors, fontsize_col = 10, cluster_rows = T, cluster_cols = F,show_rownames =T, show_colnames =F ,fontsize = 10,cellwidth=2,cellheight=10,filename = "heatmap/BC_CC_overlapped_46prot_heatmap_cluster20220316.pdf",main = paste0(""))

BC_CC_overlap<-df2
BC_CC_overlap_annotation_col<-annotation_col


### AG_GG_BC_CC
annotation_col<-rbind(AG_GG_overlap_annotation_col,BC_CC_overlap_annotation_col)
annotation_col2<- data.frame(type = factor(annotation_col$type,levels = c("AG","GG","BC","CC")),age=annotation_col$age, row.names = row.names(annotation_col))
type_color <- c("#D9942C","#8C2826","red","skyblue")
names(type_color) <-c("AG","GG","BC","CC")
ann_colors <- list(type=type_color)
colors0 = c( brewer.pal(11,"Blues")[9:4], brewer.pal(11,"Blues")[1],brewer.pal(11,"Reds")[2], brewer.pal(11,"Reds")[4:9])
colors<-colorRampPalette(colors0)(10000)

AG_GG_BC_CC<-cbind(AG_GG_overlap,BC_CC_overlap)
AG_GG_BC_CC2<-data.frame(t(AG_GG_BC_CC),check.names = F)
AG_GG_BC_CC3<-cbind(annotation_col2,AG_GG_BC_CC2)
AG_GG_BC_CC4<-AG_GG_BC_CC3[order(AG_GG_BC_CC3$type),]
AG_GG_BC_CC5<-data.frame(t(AG_GG_BC_CC4[,-c(1:2)]),check.names = F)
AG_GG_BC_CC6<-AG_GG_BC_CC5
AG_GG_BC_CC6[AG_GG_BC_CC6<0.1]<-NA

pheatmap(AG_GG_BC_CC6,scale= "row",color = colors, annotation_col = annotation_col2,
         annotation_colors = ann_colors, fontsize_col = 10, cluster_rows = T, cluster_cols = F,show_rownames =T, show_colnames =F ,fontsize = 10,cellwidth=2,cellheight=10,filename = "heatmap/AG_GG_BC_CC_overlapped_46prot_heatmap_20220316_normalziation.pdf",main = paste0("AG_GG_BC_CC"))



```

```{r AG_GG/ BC_CC overlapped 23 proteins GO enrichment}

library(DOSE)
data(geneList)
library(clusterProfiler)
library("org.Hs.eg.db")
library(enrichplot)
library(RColorBrewer)
library(pheatmap)
library(readxl)
library(stringr)

AG_GG3<-rbind(AG_GG_up,AG_GG_down)
AG_GG4<-AG_GG3[AG_GG3$X %in% prot,c("X","fd","P_value","P_value_adjust")]
names(AG_GG4)<-c("X","fd_AG_GG","P_value_AG_GG","P_value_adjust_AG_GG")
BC_CC3<-rbind(BC_CC_up,BC_CC_down)
BC_CC4<-BC_CC3[BC_CC3$X %in% prot,c("X","fd","P_value","P_value_adjust")]
names(BC_CC4)<-c("X","fd_BC_CC","P_value_BC_CC","P_value_adjust_BC_CC")

GO_overlapped<-cbind(AG_GG4,BC_CC4)
GO_overlapped$Filter<-GO_overlapped$fd_AG_GG * GO_overlapped$fd_BC_CC
overlapped<-GO_overlapped[,c(1:2)]
overlapped2<-overlapped[,-1]
names(overlapped2)<-data.frame(str_split_fixed(overlapped$X,"_",2))[,2]
overlapped3<-overlapped2
overlapped3[overlapped3>0]<-1
overlapped3[overlapped3<0]<- -1
# ENTREZID = bitr(prot_enrichment, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
# enrichment<- enrichGO(ENTREZID$ENTREZID, OrgDb = "org.Hs.eg.db",ont = "BP",qvalueCutoff = 0.05,pvalueCutoff = 1)
# down <- setReadable(enrichment, 'org.Hs.eg.db', 'ENTREZID')
# all<-data.frame(rbind(data.frame(up),data.frame(down)))

temp<-read.csv("GO/volcano_overlap_metascape_data.csv")
Metascape_up<-read_excel("GO/up_metascape/metascape_result.xlsx",sheet = 2)
Metascape_up<-Metascape_up[grep("Summary",Metascape_up$GroupID),]
Metascape_up2<-Metascape_up[,c(3,4)]
names(Metascape_up2)<-c("ID","Description")
Metascape_up2$pvalue<-10^Metascape_up$LogP
Metascape_up2$geneID<-Metascape_up$Symbols
Metascape_up5<-Metascape_up2[c(1:5),]
Metascape_up5$geneID<-gsub(",","/",Metascape_up5$geneID)

Metascape_down<-read_excel("GO/down_metascape/metascape_result.xlsx",sheet = 2)
Metascape_down<-Metascape_down[grep("Summary",Metascape_down$GroupID),]
Metascape_down2<-Metascape_down[,c(3,4)]
names(Metascape_down2)<-c("ID","Description")
Metascape_down2$pvalue<-10^Metascape_down$LogP
Metascape_down2$geneID<-Metascape_down$Symbols
Metascape_down5<-Metascape_down2[c(1:5),]
Metascape_down5$geneID<-gsub(",","/",Metascape_down5$geneID)


Metascape<-rbind(Metascape_down5,Metascape_up5)
row.names(Metascape)<-Metascape$ID

enrichment3<-new("enrichResult",result=Metascape)
b<-cnetplot(enrichment3,foldChange = overlapped3,  circular = TRUE, colorEdge = TRUE,  showCategory = 10)
ggsave(plot = b,"GO/volcano_overlap_metascape.pdf",width = 10,height = 6)


```

```{r heatmap for volcanoplot proteins in AOV_AG and BOV_BC}
rm(list = ls())
library(ggplot2)
library(RColorBrewer)
library(pheatmap)
library(readxl)
source("datamining_library_ge20200902.R")
##AOV_AG 
AOV_AG_down<-read.csv("volcano/AG_AOV_down.csv")
AOV_AG_up<-read.csv("volcano/AG_AOV_up.csv")
AOV_AG<-rbind(AOV_AG_down,AOV_AG_up)
AOV_AG0<-AOV_AG[,-1]
row.names(AOV_AG0)<-AOV_AG$X
AOV_AG<-data.frame(t(AOV_AG0))
AOV_AG$batch<-row.names(AOV_AG)
name<-read_xlsx("name.xlsx",sheet = 1)
name<-name[-grep("A20",name$sampleID),]
name$batch<-paste0(name$...12,name$patientId)
name$batch<-gsub("L|R","OV",name$batch)
label2<-merge(AOV_AG,name,by.x="batch",all=F)
AOV_AG2<-label2[,names(label2) %in% c("pathology",names(AOV_AG[,-ncol(AOV_AG)]))]
AOV_AG3<-aggregate(AOV_AG2[,-ncol(AOV_AG2)],by=list(AOV_AG2$pathology),mean,na.rm=T)
AOV_AG3[is.na(AOV_AG3)]<-NA
names(AOV_AG3)<-c("pathology",names(AOV_AG3[,-1]))
AOV_AG4<-merge(AOV_AG3,data.frame(unique(name[,c(2,3,4,7)])),by.x="pathology",all = F)
AOV_AG4$subtype<-paste0(AOV_AG4$PType,AOV_AG4$Location)
AOV_AG4$subtype<-gsub("L|R","OV",AOV_AG4$subtype)
AOV_AG5<-AOV_AG4[order(AOV_AG4$subtype),]
row.names(AOV_AG5)<-AOV_AG5$pathology
annotation_col<- data.frame(type = factor(AOV_AG5$subtype,levels = c("AOV","AG")),age=AOV_AG5$Age, row.names = AOV_AG5$pathology)
type_color <- c("#80AA31","#5B7BAA")
names(type_color) <- c("AOV","AG")
ann_colors <- list(type=type_color)
colors0 = c( brewer.pal(11,"Blues")[9:1],brewer.pal(11,"Reds")[1:9])
colors<-colorRampPalette(colors0)(10000)
df2<-data.frame(t(AOV_AG5[,-which(names(AOV_AG5) %in% c("pathology","Age","PType","Location","subtype"))]),check.names = F)
df2[is.na(df2)]<-min(df2,na.rm = T)

df3<-df2


pheatmap(df3,scale="row",color = colors, annotation_col = annotation_col,
         annotation_colors = ann_colors, fontsize_col = 10, cluster_rows = T, cluster_cols = F,show_rownames =T, show_colnames =F ,fontsize = 10,cellwidth=10,cellheight=10,filename = "heatmap/AOV_AG_volcano_prot_heatmap_20211024.pdf",main = paste0("AOV_AG"))

# BOV_BC
BOV_BC_down<-read.csv("volcano/BC_BOV_down.csv")
BOV_BC_up<-read.csv("volcano/BC_BOV_up.csv")
BOV_BC<-rbind(BOV_BC_down,BOV_BC_up)
BOV_BC0<-BOV_BC[,-1]
row.names(BOV_BC0)<-BOV_BC$X
BOV_BC<-data.frame(t(BOV_BC0))
BOV_BC$batch<-row.names(BOV_BC)
name<-read_xlsx("name.xlsx",sheet = 1)
name<-name[-grep("A20",name$sampleID),]
name$batch<-paste0(name$...12,name$patientId)
name$batch<-gsub("L|R","OV",name$batch)
label2<-merge(BOV_BC,name,by.x="batch",all=F)
BOV_BC2<-label2[,names(label2) %in% c("pathology",names(BOV_BC[,-ncol(BOV_BC)]))]
BOV_BC3<-aggregate(BOV_BC2[,-ncol(BOV_BC2)],by=list(BOV_BC2$pathology),mean,na.rm=T)
BOV_BC3[is.na(BOV_BC3)]<-NA
names(BOV_BC3)<-c("pathology",names(BOV_BC3[,-1]))
BOV_BC4<-merge(BOV_BC3,data.frame(unique(name[,c(2,3,4,7)])),by.x="pathology",all = F)
BOV_BC4$subtype<-paste0(BOV_BC4$PType,BOV_BC4$Location)
BOV_BC4$subtype<-gsub("L|R","OV",BOV_BC4$subtype)
BOV_BC5<-BOV_BC4[order(BOV_BC4$subtype),]
row.names(BOV_BC5)<-BOV_BC5$pathology
annotation_col<- data.frame(type = factor(BOV_BC5$subtype,levels = c("BOV","BC")),age=BOV_BC5$Age, row.names = BOV_BC5$pathology)
type_color <- c("#80AA31","#5B7BAA")
names(type_color) <- c("BOV","BC")
ann_colors <- list(type=type_color)
colors0 = c( brewer.pal(11,"Blues")[9:1],brewer.pal(11,"Reds")[1:9])
colors<-colorRampPalette(colors0)(10000)
df2<-data.frame(t(BOV_BC5[,-which(names(BOV_BC5) %in% c("pathology","Age","PType","Location","subtype"))]),check.names = F)
df2[is.na(df2)]<-min(df2,na.rm = T)

df3<-df2


pheatmap(df3,scale="row",color = colors, annotation_col = annotation_col,
         annotation_colors = ann_colors, fontsize_col = 10, cluster_rows = T, cluster_cols = F,show_rownames =T, show_colnames =F ,fontsize = 10,cellwidth=10,cellheight=10,filename = "heatmap/BOV_BC_volcano_prot_heatmap_20211024.pdf",main = paste0("BOV_BC"))


```


```{r heatmap for overlappped proteins in BOV-BC and AOV_AG}


###overlapped 23prot
df1<-AOV_AG
df2<-BOV_BC
df3<-df1[, which(names(df1)%in% names(df2))]
prot<-c(as.matrix(names(df3)))

##AOV_AG 
AOV_AG_down<-read.csv("volcano/AG_AOV_down.csv")
AOV_AG_up<-read.csv("volcano/AG_AOV_up.csv")
AOV_AG<-rbind(AOV_AG_down,AOV_AG_up)
AOV_AG0<-AOV_AG[,-1]
row.names(AOV_AG0)<-AOV_AG$X
AOV_AG<-data.frame(t(AOV_AG0))
AOV_AG$batch<-row.names(AOV_AG)
name<-read_xlsx("name.xlsx",sheet = 1)
name<-name[-grep("A20",name$sampleID),]
name$batch<-paste0(name$...12,name$patientId)
name$batch<-gsub("L|R","OV",name$batch)
label2<-merge(AOV_AG,name,by.x="batch",all=F)
AOV_AG2<-label2[,names(label2) %in% c("pathology",prot)]
AOV_AG3<-aggregate(AOV_AG2[,-c(ncol(AOV_AG2))],by=list(AOV_AG2$pathology),mean,na.rm=T)
AOV_AG3[is.na(AOV_AG3)]<-NA
names(AOV_AG3)<-c("pathology",names(AOV_AG3[,-1]))
AOV_AG4<-merge(AOV_AG3,data.frame(unique(name[,c(2,3,4,7)])),by.x="pathology",all = F)
AOV_AG4$subtype<-paste0(AOV_AG4$PType,AOV_AG4$Location)
AOV_AG4$subtype<-gsub("L|R","OV",AOV_AG4$subtype)
AOV_AG5<-AOV_AG4[order(AOV_AG4$subtype),]
all<-rbind(AOV_AG5)
row.names(all)<-all$pathology
annotation_col<- data.frame(type = factor(all$subtype,levels = c("AOV","AG")),age=all$Age, row.names = all$pathology)
type_color <- c("#80AA31","#5B7BAA")
names(type_color) <- c("AOV","AG")
ann_colors <- list(type=type_color)
df2<-data.frame(t(all[,c(3:60)]),check.names = F)
df3<-df2
df3[is.na(df3)]<-min(df3,na.rm = T)
colors0 = c( brewer.pal(11,"Blues")[9:1],brewer.pal(11,"Reds")[1:9])
colors<-colorRampPalette(colors0)(10000)
pheatmap(df3,scale = "row",color = colors, annotation_col = annotation_col,
         annotation_colors = ann_colors, fontsize_col = 10, cluster_rows = T, cluster_cols = F,show_rownames =T, show_colnames =F ,fontsize = 10,cellwidth=2,cellheight=10,filename = "heatmap/AOV_AG_overlapped_58prot_heatmap_20211024.pdf",main = paste0("AOV_AG overlapped"))

##AOV_AG BOV_BC
BOV_BC_down<-read.csv("volcano/BC_BOV_down.csv")
BOV_BC_up<-read.csv("volcano/BC_BOV_up.csv")
BOV_BC<-rbind(BOV_BC_down,BOV_BC_up)
BOV_BC0<-BOV_BC[,-1]
row.names(BOV_BC0)<-BOV_BC$X
BOV_BC<-data.frame(t(BOV_BC0))
BOV_BC$batch<-row.names(BOV_BC)
name<-read_xlsx("name.xlsx",sheet = 1)
name<-name[-grep("A20",name$sampleID),]
name$batch<-paste0(name$...12,name$patientId)
name$batch<-gsub("L|R","OV",name$batch)
label2<-merge(BOV_BC,name,by.x="batch",all=F)
BOV_BC2<-label2[,names(label2) %in% c("pathology",prot)]
BOV_BC3<-aggregate(BOV_BC2[,-c(ncol(BOV_BC2))],by=list(BOV_BC2$pathology),mean,na.rm=T)
BOV_BC3[is.na(BOV_BC3)]<-NA
names(BOV_BC3)<-c("pathology",names(BOV_BC3[,-1]))
BOV_BC4<-merge(BOV_BC3,data.frame(unique(name[,c(2,3,4,7)])),by.x="pathology",all = F)
BOV_BC4$subtype<-paste0(BOV_BC4$PType,BOV_BC4$Location)
BOV_BC4$subtype<-gsub("L|R","OV",BOV_BC4$subtype)
BOV_BC5<-BOV_BC4[order(BOV_BC4$subtype),]
all<-rbind(BOV_BC5)
row.names(all)<-all$pathology
annotation_col<- data.frame(type = factor(all$subtype,levels = c("BOV","BC")),age=all$Age, row.names = all$pathology)
type_color <- c("#80AA31","#5B7BAA")
names(type_color) <- c("BOV","BC")
ann_colors <- list(type=type_color)
df2<-data.frame(t(all[,c(3:60)]),check.names = F)
df3<-df2
df3[is.na(df3)]<-min(df3,na.rm = T)
colors0 = c( brewer.pal(11,"Blues")[9:1],brewer.pal(11,"Reds")[1:9])
colors<-colorRampPalette(colors0)(10000)
pheatmap(df3,scale = "row",color = colors, annotation_col = annotation_col,
         annotation_colors = ann_colors, fontsize_col = 10, cluster_rows = T, cluster_cols = F,show_rownames =T, show_colnames =F ,fontsize = 10,cellwidth=2,cellheight=10,filename = "heatmap/BOV_BC_overlapped_58prot_heatmap_20211024.pdf",main = paste0("BOV_BC overlapped"))


```


```{r heatmap for GSEA 5pathways proteins in AG_GG and BC_CC}
rm(list = ls())
library(ggplot2)
library(RColorBrewer)
library(pheatmap)
library(readxl)
library(readr)
source("datamining_library_ge20200902.R")
BC<-read_delim("GSEA/BC_CC_results/gsea_report_for_BC_1611041549512.tsv", "\t", escape_double = FALSE, trim_ws = TRUE)
CC<-read_delim("GSEA/BC_CC_results/gsea_report_for_CC_1611041549512.tsv", "\t", escape_double = FALSE, trim_ws = TRUE)
BC$label<-"BC"
CC$label<-"CC"
BC_CC<-data.frame(rbind(BC,CC))
BC_CC$rank<-rank(BC_CC$NES)
BC_CC2<-BC_CC[which(BC_CC$rank<11|BC_CC$rank > 1721),]
BC_CC2<- BC_CC2[order(BC_CC2$FDR.q.val),]
top3<-as.matrix(BC_CC2[c(1:3),1])
pathway<-c()
for (i in top3) {

  df<-read_delim(paste0("GSEA/BC_CC_results/",i,".tsv"), "\t", escape_double = FALSE, trim_ws = TRUE)
  df1<-df[which(df$`CORE ENRICHMENT`=="Yes"),c(2,6)]
  names(df1)<-c("prot","ES")
  df1$pathway=paste0(i)
  pathway<-rbind(pathway,df1)
}
library(clusterProfiler)
library(org.Hs.eg.db)
keytypes(org.Hs.eg.db)  
protID = bitr(pathway$prot, fromType="SYMBOL", toType=c("UNIPROT"), OrgDb="org.Hs.eg.db")
BC_CC_prot<-read.csv("old/BC_CC_all.csv")
protID$prot<-paste(protID$UNIPROT,protID$SYMBOL,sep = "_")
library(stringr)
BC_CC_prot2<-BC_CC_prot[which(BC_CC_prot$X %in% protID$prot),]

write.csv(BC_CC_prot2,"RandomForest/BC_CC_pathwayprot.csv")



BC_CC0<-BC_CC_prot2[,-1]
row.names(BC_CC0)<-BC_CC_prot2$X
BC_CC<-data.frame(t(BC_CC0))
BC_CC$batch<-row.names(BC_CC)
name<-read_xlsx("name.xlsx",sheet = 1)
label2<-merge(BC_CC,name,by.x="batch",all=F)
BC_CC2<-label2[,names(label2) %in% c("pathology",row.names(BC_CC0))]
BC_CC3<-aggregate(BC_CC2[,-ncol(BC_CC2)],by=list(BC_CC2$pathology),mean,na.rm=T)
# BC_CC3[is.na(BC_CC3)]<-min(BC_CC3[,-1],na.rm = T)
BC_CC3[is.na(BC_CC3)]<-NA
names(BC_CC3)<-c("pathology",names(BC_CC3[,-1]))
BC_CC4<-merge(BC_CC3,data.frame(unique(name[,c(2,3,4,7)])),by.x="pathology",all = F)
BC_CC4$subtype<-paste0(BC_CC4$PType,BC_CC4$Location)
BC_CC5<-BC_CC4[order(BC_CC4$subtype),]

row.names(BC_CC5)<-BC_CC5$pathology
annotation_col<- data.frame(type = factor(BC_CC5$subtype,levels = c("BC","CC")),age=BC_CC5$Age, row.names = BC_CC5$pathology)
# type_color <- c("#80AA31","#5B7BAA","#D9942C","#8C2826")
type_color <- c("#D9942C","#8C2826")
names(type_color) <- c("BC","CC")
ann_colors <- list(type=type_color)

colors0 = c( brewer.pal(11,"Blues")[9:4], brewer.pal(11,"Blues")[1],brewer.pal(11,"Reds")[1], brewer.pal(11,"Reds")[4:9])
colors<-colorRampPalette(colors0)(10000)

df2<-data.frame(t(BC_CC5[,-which(names(BC_CC5) %in% c("pathology","Age","PType","Location","subtype"))]),check.names = F)

df3<-log2(df2)
df4<-apply(df3,1, function (X) { sum(is.na(X))/ncol(df3)})
df5<-df3[which(df4 < 0.7), ]
df5[is.na(df5)]<-0


# df2$UNIPROT<-row.names(df2)
# df3<-merge(protID,df2, by.x="UNIPROT",all.y=T)

# pathway$label<-pathway$pathway
# pathway$label<-gsub("BIOCARTA_INTRINSIC_PATHWAY",1,pathway$label)
# pathway$label<-gsub("REACTOME_NON_INTEGRIN_MEMBRANE_ECM_INTERACTIONS",2,pathway$label)
# pathway$label<-gsub("PID_INTEGRIN1_PATHWAY",4,pathway$label)
# pathway$label<-as.numeric(pathway$label)
# pathway2<-aggregate(pathway[,c("label")],by=list(pathway$prot),FUN = sum,na.rm=T)

# names(pathway2)<-c("SYMBOL","label")
# df4<-merge(pathway2,df3, by.x="SYMBOL",all=F)
# df5<-df4[,-c(1:3)]
# row.names(df5)<-paste(df4$SYMBOL,"_", df4$label)

pheatmap(df5,scale="row",color = colors, annotation_col = annotation_col,
         annotation_colors = ann_colors, fontsize_col = 10, cluster_rows = T, cluster_cols = F,show_rownames =T, show_colnames =F ,fontsize = 10,cellwidth=10,cellheight=10,filename = "heatmap/BC_CC_heatmap_5GSEA_pathway_20211102_na0.7.pdf")



##AG_GG 
AG<-read_delim("GSEA/AG_GG_results/gsea_report_for_AG_1647526573013.tsv", "\t", escape_double = FALSE, trim_ws = TRUE)
GG<-read_delim("GSEA/AG_GG_results/gsea_report_for_GG_1647526573013.tsv", "\t", escape_double = FALSE, trim_ws = TRUE)

AG$label<-"AG"
GG$label<-"GG"
AG_GG<-data.frame(rbind(AG,GG))
AG_GG$rank<-rank(AG_GG$NES)
AG_GG2<-AG_GG[which(AG_GG$rank<11|AG_GG$rank > 1721),]
AG_GG2<- AG_GG2[order(AG_GG2$FDR.q.val),]
top3<-as.matrix(AG_GG2[c(1:3),1])
top3<-as.matrix(AG_GG2[c(1:5),1])
pathway<-c()
for (i in top3) {

  df<-read_delim(paste0("GSEA/AG_GG_results/",i,".tsv"), "\t", escape_double = FALSE, trim_ws = TRUE)
  df1<-df[which(df$`CORE ENRICHMENT`=="Yes"),c(2,6)]
  names(df1)<-c("prot","ES")
  df1$pathway=paste0(i)
  pathway<-rbind(pathway,df1)

}
library(clusterProfiler)
library(org.Hs.eg.db)
keytypes(org.Hs.eg.db)  
protID = bitr(pathway$prot, fromType="SYMBOL", toType=c("UNIPROT"), OrgDb="org.Hs.eg.db")
protID$prot<-paste(protID$UNIPROT,protID$SYMBOL,sep = "_")
AG_GG_prot<-read.csv("volcano/AG_GG_all_protein_20220318.csv")
AG_GG_prot2<-AG_GG_prot[which(AG_GG_prot$X %in% protID$prot),]

write.csv(AG_GG_prot2,"RandomForest/AG_GG_pathwayprot.csv")
  
AG_GG0<-AG_GG_prot2[,-1]
row.names(AG_GG0)<-AG_GG_prot2$X
AG_GG<-data.frame(t(AG_GG0))
AG_GG$batch<-row.names(AG_GG)
name<-read_xlsx("name.xlsx",sheet = 1)
label2<-merge(AG_GG,name,by.x="batch",all=F)
AG_GG2<-label2[,names(label2) %in% c("pathology",row.names(AG_GG0))]
AG_GG3<-aggregate(AG_GG2[,-ncol(AG_GG2)],by=list(AG_GG2$pathology),mean,na.rm=T)
AG_GG3[is.na(AG_GG3)]<-NA
names(AG_GG3)<-c("pathology",names(AG_GG3[,-1]))
AG_GG4<-merge(AG_GG3,data.frame(unique(name[,c(2,3,4,7)])),by.x="pathology",all = F)
AG_GG4$subtype<-paste0(AG_GG4$PType,AG_GG4$Location)
AG_GG5<-AG_GG4[order(AG_GG4$subtype),]

row.names(AG_GG5)<-AG_GG5$pathology
annotation_col<- data.frame(type = factor(AG_GG5$subtype,levels = c("AG","GG")),age=AG_GG5$Age, row.names = AG_GG5$pathology)
# type_color <- c("#80AA31","#5B7BAA","#D9942C","#8C2826")
type_color <- c("#80AA31","#5B7BAA")
names(type_color) <- c("AG","GG")
ann_colors <- list(type=type_color)
colors0 = c( brewer.pal(11,"Blues")[9:4], brewer.pal(11,"Blues")[1],brewer.pal(11,"Reds")[1], brewer.pal(11,"Reds")[4:9])
colors<-colorRampPalette(colors0)(10000)
df2<-data.frame(t(AG_GG5[,-which(names(AG_GG5) %in% c("pathology","Age","PType","Location","subtype"))]),check.names = F)
df2[df2==0]<-NA
df4<-apply(df2,1, function (X) { sum(is.na(X))/ncol(df3)})
df5<-df2[which(df4 < 0.7), ]
df5[is.na(df5)]<-0
df5$UNIPROT<-row.names(df5)
df6<-merge(protID[,2:3],df5, by.x="UNIPROT", all=F)
df7<-df6[,-c(1:2)]
row.names(df7)<-df6$prot


pheatmap(df7,scale="row",color = colors, annotation_col = annotation_col,
         annotation_colors = ann_colors, fontsize_col = 10, cluster_rows = T, cluster_cols = F,show_rownames =T, show_colnames =F ,fontsize = 10,cellwidth=10,cellheight=10,filename = "heatmap/AG_GG_heatmap_5GSEA_pathway20220318.pdf")


```


```{r QC_for_pool_correlation}
rm(list=ls())
library(stringr)
library(GGally)
library(corrplot)
library(PerformanceAnalytics)
raw<-read.table("diann_KRUK_protein_20200828.txt",sep = "\t",stringsAsFactors = F,header = T,row.names = 1)
raw2<-raw[,grep("pool",names(raw))]
name<-data.frame(str_split_fixed(names(raw2),"_",6))
names(raw2)<-c(as.matrix(name$X5))
pool <- raw2[which(apply(raw2,1,function(x){ sum(x,na.rm = T) })>0),]
pool<-log2(pool)

my<-function (R, histogram = TRUE, method = c("pearson", "kendall", 
    "spearman"), ...) 
{
    x = checkData(R, method = "matrix")
    if (missing(method)) 
        method = method[1]
    cormeth <- method
    
    textPanel2 <- function(x,y , txt, cex, font) text(x=0.5, 
      y=0.3, txt, cex = 0.6, font = font)
    
    panel.cor <- function(x, y, digits = 2, prefix = "", 
        use = "pairwise.complete.obs", method = cormeth, 
        cex.cor, ...) {
        usr <- par("usr")
        on.exit(par(usr))
        par(usr = c(0, 1, 0, 1))
        r <- cor(x, y, use = use, method = method)
        txt <- format(c(r, 0.123456789), digits = digits)[1]
        txt <- paste(prefix, txt, sep = "")
        if (missing(cex.cor)) 
            cex <- 0.5/strwidth(txt)
        test <- cor.test(as.numeric(x), as.numeric(y), method = method)
        Signif <- symnum(test$p.value, corr = FALSE, na = FALSE, 
            cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1), symbols = c("***", 
                "**", "*", ".", " "))
        text(0.5, 0.5, txt, cex = cex * (abs(r) + 0.3)/1.3)
        text(0.8, 0.8, Signif, cex = cex, col = 2)
    }
    f <- function(t) {
        dnorm(t, mean = mean(x), sd = sd.xts(x))
    }
    dotargs <- list(...)
    dotargs$method <- NULL
    rm(method)
    
    #####
    hist.panel = function(x, ... = NULL) {
        par(new = TRUE)
        hist(x, col = "white", probability =TRUE, border = NA,
        axes = FALSE, main = "", breaks = "FD")
        lines(density(x, na.rm = TRUE), col = "red", lwd = 1)
        rug(x)
    }
    #######
    

   panel.smooth2<- function (x, y, col=alpha("#4C7BB2",alpha = 0.6), bg = NA, pch = par("pch"), 
    cex = 0.25, col.smooth = "black", span = 2/3, iter = 3,
    ...) 
{
    points(x, y, pch = pch, col = col, bg = bg, cex = cex)
    ok <- is.finite(x) & is.finite(y)
    if (any(ok)) 
        lines(stats::lowess(x[ok], y[ok], f = span, iter = iter), 
            col = col.smooth, ...)
}
    
    if (histogram) 
        pairs(x,  gap = 0, lower.panel = panel.smooth2, upper.panel = panel.cor, 
            diag.panel = hist.panel,text.panel= textPanel2 )
    else pairs(x, gap = 0, lower.panel = panel.smooth2, upper.panel = panel.cor)
}
###############################33

pdf("QC/pool_corr.pdf")
my(pool,histogram = TRUE,pch=20)

```




```{r QC_for_mousseliver_pool_CV}

rm(list=ls())
library(stringr)
library(GGally)
library(corrplot)
library(PerformanceAnalytics)
library(vioplot)
raw<-read.table("KURK_ML_prot20210130.txt",sep = "\t",stringsAsFactors = F,header = T,row.names = 1)
raw2<-raw[,grep("_16",names(raw))]
name<-data.frame(str_split_fixed(names(raw2),"_",5))
names(raw2)<-c(as.matrix(name$X4))
mouseliver <- raw2[which(apply(raw2,1,function(x){ sum(x,na.rm = T) })>0),]
mouseliver<-log2(mouseliver)

raw<-read.table("diann_KRUK_protein_20200828.txt",sep = "\t",stringsAsFactors = F,header = T,row.names = 1)
raw2<-raw[,grep("pool",names(raw))]
name<-data.frame(str_split_fixed(names(raw2),"_",6))
names(raw2)<-c(as.matrix(name$X5))
pool <- raw2[which(apply(raw2,1,function(x){ sum(x,na.rm = T) })>0),]
pool<-log2(pool)



mouseliver_cv<-c(apply(mouseliver,1,function(x){sd(x,na.rm = T)/mean(x,na.rm=T)}))
pool_cv<-    c(apply(pool,1,function(x){sd(x,na.rm = T)/mean(x,na.rm=T)}))


library(vioplot)
pdf("QC/pool_MouseLiver_CV2.pdf")

a<-vioplot(mouseliver_cv,pool_cv,
        areaEqual=FALSE, col=c("seagreen4", "seagreen4"),
      rectCol=c("seagreen4","seagreen4"),
     lineCol=c("black", "black"),
    border=c("black","black"),
 names=c( "Mouse Liver"  ,"Pool"),
      main="", xlab=, ylab="Coefficient of variation",plotCentre = "point")
fivenum(mouseliver_cv)
fivenum(pool_cv)
```


```{r QC_for_bioRep_tech_rep_CV}

rm(list=ls())

library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)
library(magrittr)

source("datamining_library_ge20200902.R")
info<-read_excel("name.xlsx",sheet = 1)
info$subtype<-paste0(info$PType,info$Location)
df<-read.table("diann_KRUK_protein_20200828.txt",sep = "\t",stringsAsFactors = F,header = T)
names(df) <- ge.split(names(df),"\\.mzML",1,"DIA_")
df1<-df[,-1]
df1<-log2(df1)
row.names(df1)<-df[,1]

##delete protein group
df2<-df1[-grep(";",row.names(df1)),]

## average tech rep
df3<-data.frame(t(df2))
df3$batch<-row.names(df3)
df4<-df3[-grep("pool",df3$batch),]
df4$batch<-gsub("b","",df4$batch)
df4$batch<-paste0("b",df4$batch)
df5<-merge(info,df4, by.x="batch", all=F)
df6<-df5[which(df5$subtype %in% c("BC","CC","AG","GG")),]
df7<-df6[duplicated(df6$batch),1]
TecRep<-df6[df6$batch %in% df7,-c(2:12)]
TecRep_cv<-c()
for (i in 1:(nrow(TecRep)/2)){
  cv1<-TecRep[2*i-1,-1]
  cv2<-TecRep[2*i,-1]
  cv<-rbind(cv1,cv2)
  TecRep_cv1<-c(apply(cv,2,function(x){sd(x,na.rm = T)/mean(x,na.rm=T)}))
  TecRep_cv<-c(TecRep_cv,  TecRep_cv1)
}

df8<-df6[duplicated(df6$pathology),3]
BioRep<-df6[df6$pathology %in% df8,-c(1:2,4:12)]

BioRep_cv<-c()
for (i in unique(BioRep$pathology)){
BioRep_cv1<-BioRep[BioRep$pathology == i, -1]
  
  
  BioRep_cv2<-c(apply(BioRep_cv1,2,function(x){sd(x,na.rm = T)/mean(x,na.rm=T)}))
  BioRep_cv<-c(  BioRep_cv,  BioRep_cv2)
}


library(vioplot)
pdf("QC/BioRep_TecRep_cv.pdf")

a<-vioplot(BioRep_cv,TecRep_cv,
        areaEqual=FALSE, col=c("seagreen4", "seagreen4"),
      rectCol=c("seagreen4","seagreen4"),
     lineCol=c("black", "black"),
    border=c("black","black"),
 names=c( "Biological replicates "  ,"Technical replicates"),
      main="", xlab=, ylab="Coefficient of variation",plotCentre = "point")
fivenum(BioRep_cv)
fivenum(TecRep_cv)
```


```{r QC_for_tech_rep_Correlation}

rm(list=ls())
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)
library(magrittr)

source("datamining_library_ge20200902.R")
info<-read_excel("name.xlsx",sheet = 1)
info$subtype<-paste0(info$PType,info$Location)
df<-read.table("diann_KRUK_protein_20200828.txt",sep = "\t",stringsAsFactors = F,header = T)
names(df) <- ge.split(names(df),"\\.mzML",1,"DIA_")
df1<-df[,-1]
df1<-log2(df1)
row.names(df1)<-df[,1]

##delete protein group
df2<-df1[-grep(";",row.names(df1)),]

## average tech rep
df3<-data.frame(t(df2))
df3$batch<-row.names(df3)
df4<-df3[-grep("pool",df3$batch),]
df4$batch<-gsub("b","",df4$batch)
df4$batch<-paste0("b",df4$batch)
df5<-merge(info,df4, by.x="batch", all=F)
df6<-df5[which(df5$subtype %in% c("BC","CC","AG","GG")),]
df7<-df6[duplicated(df6$batch),1]
TecRep<-df6[df6$batch %in% df7,-c(2:12)]

TecRep2<-data.frame(t(TecRep[,-1]))

names(TecRep2)<-TecRep$batch

TecRep3<-data.frame(t(TecRep2))

row.names(TecRep3)<-gsub("[.]1","_rep",row.names(TecRep3))


TecRep3$batch<-TecRep$batch

my<-function (R, histogram = TRUE, method = c("pearson", "kendall", 
    "spearman"), ...) 
{
    x = checkData(R, method = "matrix")
    if (missing(method)) 
        method = method[1]
    cormeth <- method
    
    textPanel2 <- function(x,y , txt, cex, font) text(x=0.5, 
      y=0.3, txt, cex = 0.6, font = font)
    
    panel.cor <- function(x, y, digits = 2, prefix = "", 
        use = "pairwise.complete.obs", method = cormeth, 
        cex.cor, ...) {
        usr <- par("usr")
        on.exit(par(usr))
        par(usr = c(0, 1, 0, 1))
        r <- cor(x, y, use = use, method = method)
        txt <- format(c(r, 0.123456789), digits = digits)[1]
        txt <- paste(prefix, txt, sep = "")
        if (missing(cex.cor)) 
            cex <- 0.5/strwidth(txt)
        test <- cor.test(as.numeric(x), as.numeric(y), method = method)
        Signif <- symnum(test$p.value, corr = FALSE, na = FALSE, 
            cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1), symbols = c("***", 
                "**", "*", ".", " "))
        text(0.5, 0.5, txt, cex = cex * (abs(r) + 0.3)/1.3)
        text(0.8, 0.8, Signif, cex = cex, col = 2)
    }
    f <- function(t) {
        dnorm(t, mean = mean(x), sd = sd.xts(x))
    }
    dotargs <- list(...)
    dotargs$method <- NULL
    rm(method)
    
    #####
    hist.panel = function(x, ... = NULL) {
        par(new = TRUE)
        hist(x, col = "white", probability =TRUE, border = NA,
        axes = FALSE, main = "", breaks = "FD")
        lines(density(x, na.rm = TRUE), col = "red", lwd = 1)
        rug(x)
    }
    #######
    

   panel.smooth2<- function (x, y, col=alpha("#4C7BB2",alpha = 0.6), bg = NA, pch = par("pch"), 
    cex = 0.25, col.smooth = "black", span = 2/3, iter = 3,
    ...) 
{
    points(x, y, pch = pch, col = col, bg = bg, cex = cex)
    ok <- is.finite(x) & is.finite(y)
    if (any(ok)) 
        lines(stats::lowess(x[ok], y[ok], f = span, iter = iter), 
            col = col.smooth, ...)
}
    
    if (histogram) 
        pairs(x,  gap = 0, lower.panel = panel.smooth2, upper.panel = panel.cor, 
            diag.panel = hist.panel,text.panel= textPanel2 )
    else pairs(x, gap = 0, lower.panel = panel.smooth2, upper.panel = panel.cor)
}
###############################33

for (i in unique(TecRep3$batch)){
  
TecRep_corr<- data.frame(t(TecRep3[which(TecRep3$batch==i),-(ncol(TecRep3))]))
  
  pdf(paste0("QC/",i,"_Tech_rep_corr.pdf"))
  my(TecRep_corr,histogram = TRUE,pch=20)
dev.off()
}
```

```{r GSEA TOP5 pathwat barplot}
rm(list = ls())
library(datasets)
library(ggplot2)
library(reshape2)
library(readr)
library(dplyr)
library(forcats)
BC<-read_delim("GSEA/BC_CC_results/gsea_report_for_BC_1611041549512.tsv", "\t", escape_double = FALSE, trim_ws = TRUE)
CC<-read_delim("GSEA/BC_CC_results/gsea_report_for_CC_1611041549512.tsv", "\t", escape_double = FALSE, trim_ws = TRUE)
BC$label<-"BC"
CC$label<-"CC"
BC_CC<-data.frame(rbind(BC,CC))
BC_CC$rank<-rank(BC_CC$NES)

BC_CC_p_select<-BC_CC %>% dplyr::filter(NOM.p.val<0.01)

BC_CC2<-BC_CC[which(BC_CC$rank<11|BC_CC$rank > 1721),]
BC_CC2.1 <-data.frame(BC_CC2$NES)
BC_CC2.1[BC_CC2.1 > 1.7]<-NA
BC_CC2$NES<-BC_CC2.1$BC_CC2.NES
BC_CC2$NAME<-tolower(BC_CC2$NAME)
BC_CC2$GS.br..follow.link.to.MSigDB<-tolower(BC_CC2$GS.br..follow.link.to.MSigDB)
BC_CC2<- BC_CC2[order(BC_CC2$FDR.q.val),]
BC_CC2$NAME <-factor(BC_CC2$NAME,levels=c((BC_CC2$GS.br..follow.link.to.MSigDB)))
# colors0 = c("#ffe1e1","#ffd2d2","#ffc3c3","#ffb7b7","#ff9d9d") # pink
colors0 = c("#274B9F","#4662AC","#5D7AB9","#7694CB","#A3C0E4") #blue
colors<-colorRampPalette(colors0)(10000)

BC_CC3<-ggplot(BC_CC2,aes(x=NAME, y= -log10(FDR.q.val),fill= NES)) +
geom_bar(stat="identity") +
scale_fill_gradientn(colours = colors, guide = "colourbar",aesthetics = "fill")+
coord_flip()
ggsave("GSEA/BC_CC_GSEA_NEG.pdf",plot = BC_CC3,device = NULL,width = 12,height = 5)




AG<-read_delim("GSEA/AG_GG_results/gsea_report_for_AG_1647526573013.tsv", "\t", escape_double = FALSE, trim_ws = TRUE)
GG<-read_delim("GSEA/AG_GG_results/gsea_report_for_GG_1647526573013.tsv", "\t", escape_double = FALSE, trim_ws = TRUE)
AG$label<-"AG"
GG$label<-"GG"
AG_GG<-data.frame(rbind(AG,GG))
AG_GG$rank<-rank(AG_GG$NES)
AG_GG_p_select<-AG_GG %>% dplyr::filter(NOM.p.val<0.01)


AG_GG2<-AG_GG[which(AG_GG$rank<11|AG_GG$rank >1721 ),]
AG_GG2.1 <-data.frame(AG_GG2$NES)
# AG_GG2.1[AG_GG2.1 > 0]<-NA
AG_GG2.1[AG_GG2.1 < 0]<-NA
AG_GG2$NES<-AG_GG2.1$AG_GG2.NES
AG_GG2$NAME<-tolower(AG_GG2$NAME)

AG_GG2$GS.br..follow.link.to.MSigDB<-tolower(AG_GG2$GS.br..follow.link.to.MSigDB)
AG_GG2<- AG_GG2[order(AG_GG2$NOM.p.val),]
AG_GG2$NAME <-factor(AG_GG2$NAME,levels=c((AG_GG2$GS.br..follow.link.to.MSigDB)))

colors0 = c("#ffe1e1","#ffd2d2","#ffc3c3","#ffb7b7","#ff9d9d") # pink
# colors0 = c("#274B9F","#4662AC","#5D7AB9","#7694CB","#A3C0E4") #blue
colors<-colorRampPalette(colors0)(10000)
AG_GG3<-ggplot(AG_GG2,aes(x=NAME, y= -log10(NOM.p.val),fill= NES)) +
geom_bar(stat="identity") +
scale_fill_gradientn(colours = colors, guide = "colourbar",aesthetics = "fill")+
coord_flip()
ggsave("GSEA/AG_GG_GSEA_POS20220317.pdf",plot = AG_GG3,device = NULL,width = 12,height = 5)








# top3<-as.matrix(AG_GG2[c(1:5),1])
# 
# for (i in top3) {
#   
#   
#  df<-read_delim(paste0("GSEA/AG_GG_results/",i,".tsv"), "\t", escape_double = FALSE, trim_ws = TRUE)
#   df1<-df[which(df$`CORE ENRICHMENT`=="Yes"),c(2,6)]
#   names(df1)<-c("To","ES")
#   AG_GG_prot<-read.csv("AG_GG_all.csv")
#   names(AG_GG_prot)<-c("From",names(AG_GG_prot[,-1]))
#   AG_GG_name<-read.table("AG_GG.txt",sep = "\t",header = T)
#   AG_GG_table<-merge(AG_GG_name,AG_GG_prot,by.x="From",all=F)
#   AG_GG_table2<-merge(df1,AG_GG_table,by.x="To", all.x =T)
#   AG_GG_tale3<-AG_GG_table2[,c("To","ES" , "fd","P_value"    ,    "P_value_adjust")]
#   df2<-read_delim(paste0("GSEA/Top3pathway/AG_GG",i,".tsv"), "\t", escape_double = TRUE, trim_ws = TRUE)
#   df4<-data.frame(df2[,c(1,2)])
# 
# 
#   
#   write.csv(df4,paste0("GSEA/Top3pathway/ppi_AG_GG",i,".csv"),row.names = F)
#   write.csv(AG_GG_tale3,paste0("GSEA/Top3pathway/table_AG_GG",i,".csv"),row.names = F)
#   
#   
# }
# 
# AG_GG2$NAME <-factor(AG_GG2$NAME,levels=c((AG_GG2$GS.br..follow.link.to.MSigDB)))
# 
# # colors0 = c(brewer.pal(11,"BrBG")[4:2])
#    # colors0 = c("#ffe1e1","#ffd2d2","#ffc3c3","#ffb7b7","#ff9d9d") # pink
#    
#       colors0 = c("#274B9F","#4662AC","#5D7AB9","#7694CB","#A3C0E4") #blue
#     # colors0 = c( brewer.pal(11,"Blues")[9:1],brewer.pal(11,"Reds")[1:9])
# 
#   
# colors<-colorRampPalette(colors0)(10000)
# AG_GG3<-ggplot(AG_GG2,aes(x=NAME, y= -log10(NOM.p.val),fill= NES)) +
#     geom_bar(stat="identity") +
#   scale_fill_gradientn(colours = colors, guide = "colourbar",aesthetics = "fill")+
#   coord_flip()
# ggsave("GSEA/AG_GG_GSEA_NEG.pdf",plot = AG_GG3,device = NULL,width = 12,height = 5)

```

```{r GSEA top5 pathway for cytoscape}

library(clusterProfiler)
library(datasets)
library(ggplot2)
library(reshape2)
library(readr)
library(dplyr)
library(stringr)
library(forcats)
library(org.Hs.eg.db)
##prepare AG_GG DEPS
library(RColorBrewer)
AG_GG1<-df7[which(df7$subtype %in% c("AG","GG")),-c(2:12)]
AG_GG2<-AG_GG1[,-1]
row.names(AG_GG2)<-AG_GG1$batch
AG_GG2[is.na(AG_GG2)]<-NA
write.csv(AG_GG2,"all_AG_GG_gsea.csv")

####NA 小于70%
AG_GG3<-AG_GG2[, apply(AG_GG2,2,function(x) {sum(is.na(x))/nrow(AG_GG2)}) < 1]
### volcano
AG_GG4<-log2(AG_GG3[,-1])
AG_GG4$subtype<-AG_GG3$subtype
AG_GG4[is.na(AG_GG4)]<-0
fd <- data.frame(apply(2^AG_GG4[,-ncol(AG_GG4)],2, function(x) log2((mean(na.omit(x[which(AG_GG3$subtype=="AG")]))/mean(na.omit(x[which(AG_GG3$subtype=="GG")]))))))

pvalue<- data.frame(apply(AG_GG4[,-ncol(AG_GG4)],2, function(x)  t.test(x[which(AG_GG4$subtype=="AG")],x[which(AG_GG3$subtype=="GG")], paired = F, var.equal = F)$p.value ))

vol<-cbind(fd,pvalue)
names(vol)<-c("fd","P_value")

AG_GG<-data.frame(t(rbind(AG_GG4[,-ncol(AG_GG4)],t(vol))))
AG_GG$P_value_adjust<-p.adjust(AG_GG$P_value, method="BH")
write.csv(AG_GG,"volcano/AG_GG_all_protein_20220318.csv")

###Prepare cytoscape data
AG<-read_delim("GSEA/AG_GG_results/gsea_report_for_AG_1647526573013.tsv", "\t", escape_double = FALSE, trim_ws = TRUE)
GG<-read_delim("GSEA/AG_GG_results/gsea_report_for_GG_1647526573013.tsv", "\t", escape_double = FALSE, trim_ws = TRUE)
AG$label<-"AG"
GG$label<-"GG"
AG_GG<-data.frame(rbind(AG,GG))
AG_GG$rank<-rank(AG_GG$NES)
AG_GG2<-AG_GG[which(AG_GG$rank<11|AG_GG$rank > 1721),]
AG_GG2<- AG_GG2[order(AG_GG2$NOM.p.val),]
AG_GG2$NAME <-factor(AG_GG2$NAME,levels=c((AG_GG2$GS.br..follow.link.to.MSigDB)))
top3<-as.matrix(AG_GG2[c(1:3),1])
 
for (i in top3) {
  df<-read_delim(paste0("GSEA/AG_GG_results/",i,".tsv"), "\t", escape_double = FALSE, trim_ws = TRUE)
  df1<-df[which(df$`CORE ENRICHMENT`=="Yes"),c(2,6)]
 names(df1)<-c("To","ES")
   AG_GG_prot<-read.csv("volcano/AG_GG_all_protein_20220318.csv")
#转换ID
AG_GG_prot_name<-bitr(AG_GG_prot$X, fromType='UNIPROT', toType='SYMBOL', OrgDb='org.Hs.eg.db', drop = TRUE)
names(AG_GG_prot_name)<-c("X","To")
AG_GG_prot2<-merge(AG_GG_prot_name,AG_GG_prot, by="X", all.y=T,all.x=F)
AG_GG_table2<-merge(df1,AG_GG_prot2,by.x="To", all.x =F)
AG_GG_tale3<-AG_GG_table2[,c("To","ES" , "fd","P_value"    ,    "P_value_adjust")]
   
write.csv(AG_GG_tale3,paste0("GSEA/Top3pathway/AG_GG/20220318table_AG_GG",i,".csv"),row.names = F)
}


BC<-read_delim("GSEA/BC_CC_results/gsea_report_for_BC_1611041549512.tsv", "\t", escape_double = FALSE, trim_ws = TRUE)
CC<-read_delim("GSEA/BC_CC_results/gsea_report_for_CC_1611041549512.tsv", "\t", escape_double = FALSE, trim_ws = TRUE)
BC$label<-"BC"
CC$label<-"CC"
BC_CC<-data.frame(rbind(BC,CC))
BC_CC$rank<-rank(BC_CC$NES)
BC_CC2<-BC_CC[which(BC_CC$rank<11|BC_CC$rank > 1721),]
BC_CC2<- BC_CC2[order(BC_CC2$NOM.p.val),]
BC_CC2$NAME <-factor(BC_CC2$NAME,levels=c((BC_CC2$GS.br..follow.link.to.MSigDB)))
top5<-as.matrix(BC_CC2[c(1:3),1])
 
for (i in top5) {
df<-read_delim(paste0("GSEA/BC_CC_results/",i,".tsv"), "\t", escape_double = FALSE, trim_ws = TRUE)
df1<-df[which(df$`CORE ENRICHMENT`=="Yes"),c(2,6)]
#  write.csv(df1, paste0("GSEA/Top3pathway/BC_CC",i,".csv"),row.names = F)
# }
names(df1)<-c("To","ES")
BC_CC_prot<-read.csv("volcano/BC_CC_all2021111.csv")
#change ID
BC_CC_prot_name<-bitr(BC_CC_prot$X, fromType='UNIPROT', toType='SYMBOL', OrgDb='org.Hs.eg.db', drop = TRUE)
names(BC_CC_prot_name)<-c("X","To")
BC_CC_prot2<-merge(BC_CC_prot_name,BC_CC_prot, by="X", all.y=T,all.x=F)
BC_CC_table2<-merge(df1,BC_CC_prot2,by.x="To", all.x =F)
BC_CC_tale3<-BC_CC_table2[,c("To","ES" , "fd","P_value"    ,    "P_value_adjust")]
 df2<-read_delim(paste0("GSEA/Top3pathway/BC_CC/BC_CC",i,".tsv"), "\t", escape_double = TRUE, trim_ws = TRUE)
  df4<-data.frame(df2[,c(1,2)])
   # write.csv(df4,paste0("GSEA/Top3pathway/BC_CC/ppi_BC_CC",i,".csv"),row.names = F)
 write.csv(BC_CC_tale3,paste0("GSEA/Top3pathway/BC_CC/20211111table_BC_CC",i,".csv"),row.names = F)
}


```

```{r IPA}
rm(list = ls())
library(ggplot2)
BC_CC<-read.table("IPA/BC_CC_pathway.txt",sep = "\t",stringsAsFactors = F,header = T)
row.names(BC_CC)<-BC_CC$Ingenuity.Canonical.Pathways

BC_CC2<-BC_CC[which(BC_CC$X.log.p.value.>1.3 & BC_CC$z.score>0),]

BC_CC3<-ggplot(BC_CC2,aes(x=Ingenuity.Canonical.Pathways, y= X.log.p.value.,fill= z.score)) +
    geom_bar(stat="identity") +
  scale_fill_gradient2(low = "cyan4",
  high = "coral1", guide = "colourbar",aesthetics = "fill")+
  coord_flip()

p6 <- ggplot(BC_CC, aes(x = z.score, y = X.log.p.value.)) +
         geom_bar(stat="identity") +
        ggtitle("urine_immune_cell") +
  # geom_text(label=BC_CC$Ingenuity.Canonical.Pathways,color="blue")+
theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 5,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())+
            theme(axis.text = element_text(size = 30,color = "black"))+
  
            theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
            theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+
            theme(axis.title.y=element_text(size=30, hjust=0.5, color="black"))
```

```{r log2}
rm(list=ls())

df<-read.csv("volcano/AG_GG_all_boxplot.csv",check.names = F)


df2<-log2(df[,-c(1:2)])


df3<-data.frame(df[,c(1:2)],df2,check.names = F)
 
write.csv(df3,"volcano/AG_GG_all_boxplot_log2.csv",row.names = F)

df<-read.csv("volcano/BC_CC_all_boxplot.csv",check.names = F)


df2<-log2(df[,-c(1:2)])


df3<-data.frame(df[,c(1:2)],df2,check.names = F)
 
write.csv(df3,"volcano/BC_CC_all_boxplot_log2.csv",row.names = F)


```


```{r AG_GG/ BC_CC overlapped  proteins metascape enrichment}
rm(list = ls())
# library(DOSE)
data(geneList)
library(clusterProfiler)
library("org.Hs.eg.db")
library(enrichplot)
library(RColorBrewer)
library(pheatmap)
library(readxl)
library(stringr)
library(ggplot2)
library(ggnewscale)

overlappep_metascape<-read.csv("metascape/AGGGBCCC_overlap_metascape/AGGGBCCC_overlap_metascape.csv",check.names = F,row.names = 1)
fd<-read.csv("metascape/AGGGBCCC_overlap_metascape/AGGGBCCC_overlap_metascape_ip_dowm.csv",check.names = F)
fd2<-(unique(fd[,c(1,12)]))
fd3<-(fd2[,-1])
names(fd3)<-fd[,1]
enrichment3<-new("enrichResult",result=overlappep_metascape)
b<-cnetplot(enrichment3, foldChange=fd3, circular = TRUE, colorEdge = TRUE,  showCategory = 20, )
ggsave(plot = b,"metascape/metascape_overlapped.pdf",width = 10,height = 6)

```

```{r boxplot for MRM}

rm(list = ls())
library(ggplot2)
library(readxl)
library(ggpubr)
raw2<-read.csv("matrix/MRM_validation/KRUK_AG_GG_MRM_matrix.csv")
raw3<-aggregate(raw2[,-c(1:4)],by=list(raw2$Protein),mean)
raw4<-data.frame(t(raw3[,-1]))
raw4<-log2(raw4)
names(raw4)<-raw3$Group.1

AG<-raw4[grep("AG", row.names(raw4)),]
AG$DiseaseType<-"AG"
GG<-raw4[grep("GG", row.names(raw4)),]
GG$DiseaseType<-"GG"
data<-data.frame(rbind(AG,GG))

for (i in 1:c(ncol(data)-1)) {
 p <- ggplot(data, aes(x=DiseaseType, y=data[,i],color=DiseaseType)) +ylab("Log2(protein abundance)")+ ggtitle(paste0(names(data)[i]))+
  geom_boxplot( na.rm = T,outlier.shape = NA)+geom_jitter(shape=16, position=position_jitter(0.2))+
   scale_color_manual(values=c("#80AA31","#D9942C"))

  my_comparisons <- list(c("AG", "GG"))
  
  
  q <- p+stat_compare_means(method = "t.test",comparisons = my_comparisons)+
   
theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 15,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())+
            theme(axis.text = element_text(size = 30,color = "black"))+
  
            theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
            theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+
            theme(axis.title.y=element_text(size=30, hjust=0.5, color="black"))
  
  
  
  ggsave(filename  = paste0("MRM_boxplot/AG_GG/AG_GG_",names(data)[i],".pdf"),plot=q,device = NULL,width = 6,height = 6)
  
}


rm(list = ls())
library(ggplot2)
library(readxl)
library(ggpubr)
raw2<-read.csv("matrix/MRM_validation/KRUK_BC_CC_MRM_matrix.csv")
raw3<-aggregate(raw2[,-c(1:4)],by=list(raw2$Protein),mean)
raw4<-data.frame(t(raw3[,-1]))
raw4<-log2(raw4)
names(raw4)<-raw3$Group.1

BC<-raw4[grep("BC", row.names(raw4)),]
BC$DiseaseType<-"BC"
CC<-raw4[grep("CC", row.names(raw4)),]
CC$DiseaseType<-"CC"
data<-data.frame(rbind(BC,CC))

for (i in 1:c(ncol(data)-1)) {
 p <- ggplot(data, aes(x=DiseaseType, y=data[,i],color=DiseaseType)) +ylab("Log2(protein abundance)")+ ggtitle(paste0(names(data)[i]))+
  geom_boxplot( na.rm = T,outlier.shape = NA)+geom_jitter(shape=16, position=position_jitter(0.2))+
   scale_color_manual(values=c("#80AA31","#D9942C"))

  my_comparisons <- list(c("BC", "CC"))
  
  
  q <- p+stat_compare_means(method = "t.test",comparisons = my_comparisons)+
   
theme(legend.direction = 'horizontal',legend.position = 'top',legend.text = element_text(size = 15,color = "black"), legend.title = element_text(size=15,color="black") ,panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"))+ theme(panel.grid =element_blank())+
            theme(axis.text = element_text(size = 30,color = "black"))+
  
            theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
            theme(axis.title.x=element_text(size=30, hjust=0.5, color="black"))+
            theme(axis.title.y=element_text(size=30, hjust=0.5, color="black"))
  
  
  
  ggsave(filename  = paste0("MRM_boxplot/BC_CC/BC_CC_",names(data)[i],".pdf"),plot=q,device = NULL,width = 6,height = 6)
  
}

```

```{r  pathway visualization circle heatmap}

rm(list=ls())
library(readxl)
library(ComplexHeatmap)
library(circlize)
library(stringr)
AG_GG_UP <- read_excel("pathway_visualization/ag_up_top20220321.xlsx")
AG_GG_UP_vol<-read.csv("volcano/AG_GG_up.csv")
AG_GG_UP_vol$X<-gsub("P00403_MT.CO2","P00403_COX2",AG_GG_UP_vol$X)
AG_GG_UP_vol$X<-gsub("P79483_HLA.DRB3","P79483_HLA-DRB3",AG_GG_UP_vol$X)
AG_GG_UP_vol$"Gene Symbol"<-data.frame(str_split_fixed(AG_GG_UP_vol$X,"_",2))[,2]
AG_GG_UP2<-merge(AG_GG_UP,AG_GG_UP_vol, by="Gene Symbol", all.x = T, all.y=F)
AG_GG_UP3<-AG_GG_UP2[,c(2:6,99)]
row.names(AG_GG_UP3)<-AG_GG_UP2$`Gene Symbol`
AG_GG_UP4<-as.matrix((apply(AG_GG_UP3[,1:5], 2,  function (x){x* AG_GG_UP3[,6] })))
  col_fun1 = colorRamp2(c(-4, 0, 4), c("blue", "white", "red"))
  pdf("pathway_visualization/AG_GG_UP_20220321.pdf",
      height = 6,
      width = 6)
  set.seed(2020)
  circos.par(cell.padding = c(0, 0, 0, 0), 
             start.degree = 90,
             gap.degree = 60,
             gap.after = 60)
  circos.heatmap(AG_GG_UP4, col = col_fun1,rownames.cex = 0.5, # na.col = "grey",
                 bg.border = "grey", dend.side = "inside",rownames.side = "outside",
                 # show.sector.labels = T,
                 track.height = 0.3
                 # annotationTrack = "grid",
                 # preAllocateTracks = list(track.height = 0.1)
                 )
  circos.track(track.index = 1,
               panel.fun = function(x, y) {
                 cn =colnames(AG_GG_UP4)
                 n = length(cn)
                 circos.text(rep(CELL_META$cell.xlim[2],n) + convert_x(1, "mm"),seq(-1.9,-0.2,length.out = 5),cn, 
  cex = 0.8, adj = c(0, 0.5),facing = "inside")
                 },bg.border = NA)
  circos.clear()
  library(ComplexHeatmap)
  lgd = Legend(title = "mat1", col_fun = col_fun1)
  grid.draw(lgd)
dev.off()

AG_GG_DOWN <- read_excel("pathway_visualization/ag_down_top520220321.xlsx")
AG_GG_DOWN_vol<-read.csv("volcano/AG_GG_down.csv")
AG_GG_DOWN_vol$"Gene Symbol"<-data.frame(str_split_fixed(AG_GG_DOWN_vol$X,"_",2))[,2]
AG_GG_DOWN2<-merge(AG_GG_DOWN,AG_GG_DOWN_vol, by="Gene Symbol", all.x = T, all.y=F)
AG_GG_DOWN3<-AG_GG_DOWN2[,c(2:6,99)]
row.names(AG_GG_DOWN3)<-AG_GG_DOWN2$`Gene Symbol`
AG_GG_DOWN4<-as.matrix((apply(AG_GG_DOWN3[,1:5], 2,  function (x){x* AG_GG_DOWN3[,6] })))

col_fun1 = colorRamp2(c(-4, 0, 4), c("blue", "white", "red"))
  pdf("pathway_visualization/AG_GG_DOWN_20220321.pdf",
      height = 6,
      width = 6)
  set.seed(2020)
  circos.par(cell.padding = c(0, 0, 0, 0), 
             start.degree = 90,
             gap.degree = 60,
             gap.after = 60)
  circos.heatmap(AG_GG_DOWN4, col = col_fun1,rownames.cex = 0.5, # na.col = "grey",
                 bg.border = "grey", dend.side = "inside",rownames.side = "outside",
                 # show.sector.labels = T,
                 track.height = 0.3
                 # annotationTrack = "grid",
                 # preAllocateTracks = list(track.height = 0.1)
                 )
  circos.track(track.index = 1,
               panel.fun = function(x, y) {
                 cn =colnames(AG_GG_UP4)
                 n = length(cn)
                 circos.text(rep(CELL_META$cell.xlim[2],n) + convert_x(1, "mm"),seq(-1.9,-0.2,length.out = 5),cn, 
  cex = 0.8, adj = c(0, 0.5),facing = "inside")
                 },bg.border = NA)
  circos.clear()
  library(ComplexHeatmap)
  lgd = Legend(title = "mat1", col_fun = col_fun1)
  grid.draw(lgd)
dev.off()



BC_CC_UP <- read_excel("pathway_visualization/BC_CC_UP.xlsx")
BC_CC_UP_vol<-read.csv("volcano/BC_CC_up.csv")
BC_CC_UP_vol$X<-gsub("P00403_MT.CO2","P00403_COX2",BC_CC_UP_vol$X)
BC_CC_UP_vol$X<-gsub("P79483_HLA.DRB3","P79483_HLA-DRB3",BC_CC_UP_vol$X)
BC_CC_UP$X<-paste0(BC_CC_UP$MyList,"_",BC_CC_UP$`Gene Symbol`)
BC_CC_UP2<-merge(BC_CC_UP,BC_CC_UP_vol, by="X", all = F)

BC_CC_UP3<-BC_CC_UP2[,c(4,5,6,7,8,103)]
row.names(BC_CC_UP3)<-BC_CC_UP2$`Gene Symbol`
BC_CC_UP4<-data.frame(t(apply(BC_CC_UP3[,1:5], 2,  function (x){x* BC_CC_UP3[,6] })))

ann_BC_CC_UP<-data.frame(c(1,2,3,4,5))
row.names(ann_BC_CC_UP)<-c(row.names(BC_CC_UP4))
names(ann_BC_CC_UP)<-c("Ring")
library(canvasXpress)

BC_CC_UP5<- canvasXpress(
    data=BC_CC_UP4,
    #smpAnnot=x,
    varAnnot=ann_BC_CC_UP,
    colorSmpDendrogramBy="Species",
    #connections=list(list("rgb(120,0,255)", "s71", "s107"), list("rgb(120,0,255)", "s73", "s107"), list("rgb(120,0,255)", "s84", "s107")),
    graphType="Circular",
    ringGraphType=list("heatmap"),
    colorSpectrum=list("blue", "white", "red"),
    colorSpectrumBreaks=list(-0.5, 0, 3),
    samplesClustered=TRUE,
    smpDendrogramPosition="inside",       
    smpLabelOrientation="perpendicular",  
    circularLabelsAlign="inside",         
    smpOverlays=list("Species"),
    ringsOrder = list("labels","data","dendrogram"),    
    title="BC_CC_UP"
  )
BC_CC_DOWN <- read_excel("pathway_visualization/BC_CC_DOWN.xlsx")
BC_CC_DOWN_vol<-read.csv("volcano/BC_CC_down.csv")
BC_CC_DOWN_vol$X<-gsub("P00403_MT.CO2","P00403_COX2",BC_CC_DOWN_vol$X)
BC_CC_DOWN_vol$X<-gsub("P79483_HLA.DRB3","P79483_HLA-DRB3",BC_CC_DOWN_vol$X)
BC_CC_DOWN$X<-paste0(BC_CC_DOWN$MyList,"_",BC_CC_DOWN$`Gene Symbol`)
BC_CC_DOWN2<-merge(BC_CC_DOWN,BC_CC_DOWN_vol, by="X", all = F)

BC_CC_DOWN3<-BC_CC_DOWN2[,c(4,5,6,7,8,103)]
row.names(BC_CC_DOWN3)<-BC_CC_DOWN2$`Gene Symbol`
BC_CC_DOWN4<-data.frame(t(apply(BC_CC_DOWN3[,1:5], 2,  function (x){x* BC_CC_DOWN3[,6] })))

ann_BC_CC_DOWN<-data.frame(c(1,2,3,4,5))
row.names(ann_BC_CC_DOWN)<-c(row.names(BC_CC_DOWN4))
names(ann_BC_CC_DOWN)<-c("Ring")
library(canvasXpress)

BC_CC_DOWN5<- canvasXpress(
    data=BC_CC_DOWN4,
    #smpAnnot=x,
    varAnnot=ann_BC_CC_DOWN,
    colorSmpDendrogramBy="Species",
    #connections=list(list("rgb(120,0,255)", "s71", "s107"), list("rgb(120,0,255)", "s73", "s107"), list("rgb(120,0,255)", "s84", "s107")),
    graphType="Circular",
    ringGraphType=list("heatmap"),
    colorSpectrum=list("blue", "white", "red"),
    colorSpectrumBreaks=list(-0.5, 0, 3),
    samplesClustered=TRUE,
    smpDendrogramPosition="inside",       
    smpLabelOrientation="perpendicular",  
    circularLabelsAlign="inside",         
    smpOverlays=list("Species"),
    ringsOrder = list("labels","data","dendrogram"),    
    title="BC_CC_DOWN"
    )
```

```{r  pathway visualziation by chord plot}
rm(list=ls())
library(readxl)
library(GOplot)
library(RColorBrewer)
AG_GG_UP <- read_excel("pathway_visualization/AG_GG_UP.xlsx")
AG_GG_UP_vol<-read.csv("volcano/AG_GG_up.csv")
AG_GG_UP_vol$X<-gsub("P00403_MT.CO2","P00403_COX2",AG_GG_UP_vol$X)
AG_GG_UP_vol$X<-gsub("P79483_HLA.DRB3","P79483_HLA-DRB3",AG_GG_UP_vol$X)
AG_GG_UP$X<-paste0(AG_GG_UP$UniprotID,"_",AG_GG_UP$`Gene Symbol`)
AG_GG_UP2<-merge(AG_GG_UP,AG_GG_UP_vol, by="X", all = F)
AG_GG_UP3<-AG_GG_UP2[,c(4,5,6,7,8,105)]
row.names(AG_GG_UP3)<-AG_GG_UP2$`Gene Symbol`

names(AG_GG_UP3)<-gsub("fd","logFC",names(AG_GG_UP3))
color<-c(brewer.pal(11, "Pastel1")[1:5])
P<-GOChord(AG_GG_UP3,gene.order='logFC',gene.size = 10,space = 0.05,ribbon.col = color,gene.space = 0.22)+scale_fill_gradient2(low = "green",mid = "white",high = "red",midpoint =0,guide = "legend")
ggsave(P,file="pathway_visualization/AG_GG_UP_chord.pdf",device = NULL,width = 30,height=30)
```


```{r heatmap for pathway proteins}
rm(list = ls())
library(ggplot2)
library(RColorBrewer)
library(pheatmap)
library(readxl)
library(org.Hs.eg.db)
library(clusterProfiler)
df<-read.csv("matrix/AG_GG_BC_CC_matrix0.531_10840Protein_20220317.csv")
prot<-read_excel("Heatmap_for_pathwaty/proteins20220321.xlsx")
df1<-df[df$subtype %in% c("AG","GG","BC","CC"),-c(1:11)]
df2<-df1[,names(df1) %in% prot$uniprot]
df2$subtype<-df1$subtype
df2[is.na(df2)]<-0

df3<-aggregate(df2[,-ncol(df2)], by=list(df2$subtype),mean, na.rm=T)
df4<-df3[,-1]
row.names(df4)<-df3$Group.1
df5<-data.frame(t(df4))

gene<-data.frame(bitr(prot$uniprot, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db"))
names(gene)<-c("uniprot","gene")
prot2<-merge(prot,gene,by="uniprot")
df5$uniprot<-row.names(df5)
df6<-merge(prot2,df5,by="uniprot", all.x=T, all.y=F)
df7<-df6[order(df6$pathway),]
df8<-df7[,c(4,5,8,6,7)]
df9<-df8[,-1]
row.names(df9)<-df8$gene

colors0 = c( brewer.pal(11,"Blues")[9:4], brewer.pal(11,"Blues")[1],brewer.pal(11,"Reds")[2], brewer.pal(11,"Reds")[4:9])
colors<-colorRampPalette(colors0)(10000)



a<-pheatmap(df9[,1:4],scale="row",color = colors, fontsize_col = 10, cluster_rows = F, cluster_cols = F,show_rownames =T, show_colnames =T ,fontsize = 10,cellwidth=10,cellheight=10, filename = "Heatmap_for_pathwaty/Heatmap_20220321.pdf", main="AG_GG_BC_CC")
ggsave(plot=a, "Heatmap_for_pathwaty/Heatmap_20220321.pdf", device = NULL)


pheatmap(df9[,3:4],scale="row",color = colors, fontsize_col = 10, cluster_rows = F, cluster_cols = F,show_rownames =T, show_colnames =T ,fontsize = 10,cellwidth=10,cellheight=10,filename = "Heatmap_for_pathwaty/BC_CC_Heatmap_22prot_NA0_20220321.pdf",main="BC_CC")
```



```{r Randomforest for BC_CC AG_GG}
####using whole matrix(delete proteins with missing value > 0.7)
####the missing value was input by KNN

rm(list=ls())
library(readxl)
library(magrittr)
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)
library(tidyverse)
library(stringr)
library(DMwR)
source("datamining_library_ge20200902.R")
info<-read_excel("name.xlsx",sheet = 1)
info$subtype<-paste0(info$PType,info$Location)
df<-read.table("matrix/diann_KRUK_protein_20200828_REnames.txt",sep = "\t",stringsAsFactors = F,header = T)
names(df) <- ge.split(names(df),"\\.mzML",1,"DIA_")
df1<-df[,-1]
row.names(df1)<-df[,1]

##delete protein group
df2<-df1[-grep(";",row.names(df1)),]

## average tech rep
df3<-data.frame(t(df2))
df3$label<-row.names(df3)
df4<-df3[-grep("pool",df3$label),]
df4$label<-gsub("b","",df4$label)
df5<-aggregate(x = df4[,-which(names(df4)=="label")], by = list(df4$label), FUN = "mean",na.rm=T)
df5$batch<-paste0("b",df5$Group.1)
df6<-df5[,-1]
df7<-merge(info,df6,by.x="batch",all=F)
df7<-df7[-grep("A20",df7$sampleID),]
##  delete G18Ga,G20Ga,G29Ga,G37Ga,G40Ga,
df7<-df7[-grep("G18Ga|G20Ga|G29Ga|G37Ga|G40Ga", df7$sampleID),]

###FOr AG_GG

library(RColorBrewer)
AG_GG1<-df7[which(df7$subtype %in% c("AG","GG")),-c(2:12)]
AG_GG2<-AG_GG1[,-1]
row.names(AG_GG2)<-AG_GG1$batch
AG_GG2[is.na(AG_GG2)]<-NA

###Delete NA 小于70%
AG_GG3<-AG_GG2[, apply(AG_GG2,2,function(x) {sum(is.na(x))/nrow(AG_GG2)}) < 0.7]
info<-read_excel("name.xlsx",sheet = 1)
info<-info[-grep("A20", info$sampleID),]
info$subtype<-paste0(info$PType,info$Location)
AG_GG3$batch<-row.names(AG_GG3)
AG_GG4<-merge(info,AG_GG3,by="batch",all=F)
AG_GG5<-AG_GG4[AG_GG4$subtype.x %in% c("AG","GG"),]
AG_GG6<-aggregate(AG_GG5[,-c(1:14)],  by=list(AG_GG5$pathology),  mean,na.rm=T)
names(AG_GG6)<-c("pathology",names(AG_GG6[,-1]))
AG_GG7<-merge(data.frame(unique(AG_GG5[,c("pathology","subtype.x")])),AG_GG6,by.x ="pathology",all.Y=F)
AG_GG8<-AG_GG7[,-1]
row.names(AG_GG8)<-AG_GG7$pathology
AG_GG9<-data.frame(AG_GG8[,1],(AG_GG8[,-1]))
names(AG_GG9)<-c("label",names(AG_GG9[,-1]))
AG_GG9.1<-log2(AG_GG9[,-1])
AG_GG9.1$label<-AG_GG9$label
AG_GG9<-AG_GG9.1
AG_GG9[is.na(AG_GG9)]<-0
#####AG_GG9 is the training matrix


AGGG_valid<-read.table("matrix/DIA_validation/20211019KRUK_A_protein_matrix_rename.txt",sep = "\t",stringsAsFactors = F,header = T)
AGGG_valid2<-AGGG_valid
AGGG_valid4<-AGGG_valid2[,-c(1)]
row.names(AGGG_valid4)<-paste0(AGGG_valid2$prot)
AGGG_valid5<-data.frame(t(AGGG_valid4))
AG_valid<-AGGG_valid5[grep("AG",row.names(AGGG_valid5)),]
GG_valid<-AGGG_valid5[grep("GG",row.names(AGGG_valid5)),]
AGGG_valid6<-data.frame(rbind(AG_valid, GG_valid))
AGGG_sampleName<-data.frame(str_split_fixed(c(row.names(AGGG_valid6)),pattern = "_",10))
AGGG_sampleName2<-gsub("_rep","",AGGG_sampleName[,10])
AGGG_valid7<-aggregate(AGGG_valid6, by=list(AGGG_sampleName2), mean, na.rm=T)
AGGG_valid8<-AGGG_valid7[,-1]
AGGG_valid9<-log2(AGGG_valid8)
AGGG_valid9[is.na(AGGG_valid9)]<-0
row.names(AGGG_valid9)<-AGGG_valid7$Group.1
#select name from MRM
mrm<-read.csv("matrix/MRM_validation/KRUK_AG_GG_MRM_matrix.csv")
patient_name<- data.frame(str_split_fixed(names(mrm),"_",6))
patient_name$X5<-gsub(".Total.Area.Fragment","",patient_name$X5)
row.names(AGGG_valid9)<-gsub(".raw","",row.names(AGGG_valid9))
AGGG_valid10<-AGGG_valid9[row.names(AGGG_valid9) %in% patient_name$X5 , ]
AGGG_valid10$label<-row.names(AGGG_valid10)
AGGG_valid10$label<-gsub("[0-9]","",AGGG_valid10$label)
# AGGG_valid10[AGGG_valid10==0]<-NA

###delete GG4   too much NA 
AGGG_valid10<-AGGG_valid10[!row.names(AGGG_valid10)=="GG4",]
#####AGGG_valid10 is the test matrix
set.seed(2020)
#KNN imput missing value
# AG_GG9.2<-knnImputation(t(AG_GG9[,!names(AG_GG9)== "label"]), k = 10, scale = T, meth = "weighAvg", distData = NULL)
# AG_GG9.3<-data.frame(t(AG_GG9.2))
# AG_GG9.3$label<-AG_GG9$label
# AG_GG9<-AG_GG9.3
# AGGG_valid10.1<-AGGG_valid10[, apply(AGGG_valid10,2,function(x) {sum(is.na(x))/nrow(AGGG_valid10)}) < 0.7]
# AGGG_valid10.2<-knnImputation(t(AGGG_valid10.1[,!names(AGGG_valid10.1)== "label"]), k = 1, scale = T, meth = "weighAvg", distData = NULL)
# AGGG_valid10.3<-data.frame(t(AGGG_valid10.2))
# AGGG_valid10.3$label<-AGGG_valid10$label
# AGGG_valid10<-AGGG_valid10.3




write.csv(AG_GG9,"RandomForest/TMP_run_KRUK/AG_GG/AG_GG9_NA0.csv",row.names = T)
write.csv(AGGG_valid10,"RandomForest/TMP_run_KRUK/AG_GG/AGGG_valid10_NA0.csv",row.names = T)




```


```{r Randomforest for BCAG_CCGG}
####using whole matrix(delete proteins with missing value > 0.7)
####the missing value was input by KNN

rm(list=ls())
library(readxl)
library(magrittr)
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)
library(tidyverse)
library(stringr)
library(DMwR)
library(clusterProfiler)
library(org.Hs.eg.db)
source("datamining_library_ge20200902.R")
info<-read_excel("name.xlsx",sheet = 1)
info$subtype<-paste0(info$PType,info$Location)
df<-read.table("matrix/diann_KRUK_protein_20200828_REnames.txt",sep = "\t",stringsAsFactors = F,header = T)
names(df) <- ge.split(names(df),"\\.mzML",1,"DIA_")
df1<-df[,-1]
row.names(df1)<-df[,1]

##delete protein group
df2<-df1[-grep(";",row.names(df1)),]

## average tech rep
df3<-data.frame(t(df2))
df3$label<-row.names(df3)
df4<-df3[-grep("pool",df3$label),]
df4$label<-gsub("b","",df4$label)
df5<-aggregate(x = df4[,-which(names(df4)=="label")], by = list(df4$label), FUN = "mean",na.rm=T)
df5$batch<-paste0("b",df5$Group.1)
df6<-df5[,-1]
df7<-merge(info,df6,by.x="batch",all=F)
df7<-df7[-grep("A20",df7$sampleID),]
##  delete G18Ga,G20Ga,G29Ga,G37Ga,G40Ga,
df7<-df7[-grep("G18Ga|G20Ga|G29Ga|G37Ga|G40Ga", df7$sampleID),]

###FOr AGBC_GGCC

library(RColorBrewer)
AGBC_GGCC1<-df7[which(df7$subtype %in% c("AG","GG","BC","CC")),-c(2:12)]
AGBC_GGCC2<-AGBC_GGCC1[,-1]
row.names(AGBC_GGCC2)<-AGBC_GGCC1$batch
AGBC_GGCC2[is.na(AGBC_GGCC2)]<-NA

###Delete NA 小于70%
AGBC_GGCC3<-AGBC_GGCC2[, apply(AGBC_GGCC2,2,function(x) {sum(is.na(x))/nrow(AGBC_GGCC2)}) < 0.7]
info<-read_excel("name.xlsx",sheet = 1)
info<-info[-grep("A20", info$sampleID),]
info$subtype<-paste0(info$PType,info$Location)
AGBC_GGCC3$batch<-row.names(AGBC_GGCC3)
AGBC_GGCC4<-merge(info,AGBC_GGCC3,by="batch",all=F)
AGBC_GGCC5<-AGBC_GGCC4[AGBC_GGCC4$subtype.x %in% c("AG","GG","BC","CC"),]
AGBC_GGCC6<-aggregate(AGBC_GGCC5[,-c(1:14)],  by=list(AGBC_GGCC5$pathology),  mean,na.rm=T)


names(AGBC_GGCC6)<-c("pathology",names(AGBC_GGCC6[,-1]))
AGBC_GGCC7<-merge(data.frame(unique(AGBC_GGCC5[,c("pathology","subtype.x")])),AGBC_GGCC6,by.x ="pathology",all.Y=F)

AGBC_GGCC8<-AGBC_GGCC7[,-1]
row.names(AGBC_GGCC8)<-AGBC_GGCC7$pathology
AGBC_GGCC9<-data.frame(AGBC_GGCC8[,1],(AGBC_GGCC8[,-1]))
names(AGBC_GGCC9)<-c("label",names(AGBC_GGCC9[,-1]))
AGBC_GGCC9.1<-log2(AGBC_GGCC9[,-1])
AGBC_GGCC9.1$label<-AGBC_GGCC9$label
AGBC_GGCC9<-AGBC_GGCC9.1
AGBC_GGCC9[is.na(AGBC_GGCC9)]<-0
#####AGBC_GGCC9 is the training matrix

AGGG_valid<-read.table("matrix/DIA_validation/20211019KRUK_A_protein_matrix_rename.txt",sep = "\t",stringsAsFactors = F,header = T)
AGGG_valid2<-AGGG_valid
AGGG_valid4<-AGGG_valid2[,-c(1)]
row.names(AGGG_valid4)<-paste0(AGGG_valid2$prot)
AGGG_valid5<-data.frame(t(AGGG_valid4))
AG_valid<-AGGG_valid5[grep("AG",row.names(AGGG_valid5)),]
GG_valid<-AGGG_valid5[grep("GG",row.names(AGGG_valid5)),]
AGGG_valid6<-data.frame(rbind(AG_valid, GG_valid))
AGGG_sampleName<-data.frame(str_split_fixed(c(row.names(AGGG_valid6)),pattern = "_",10))
AGGG_sampleName2<-gsub("_rep","",AGGG_sampleName[,10])
AGGG_valid7<-aggregate(AGGG_valid6, by=list(AGGG_sampleName2), mean, na.rm=T)
AGGG_valid8<-AGGG_valid7[,-1]
AGGG_valid9<-log2(AGGG_valid8)
AGGG_valid9[is.na(AGGG_valid9)]<-0
row.names(AGGG_valid9)<-AGGG_valid7$Group.1
#select name from MRM
mrm<-read.csv("matrix/MRM_validation/KRUK_AG_GG_MRM_matrix.csv")
patient_name<- data.frame(str_split_fixed(names(mrm),"_",6))
patient_name$X5<-gsub(".Total.Area.Fragment","",patient_name$X5)
row.names(AGGG_valid9)<-gsub(".raw","",row.names(AGGG_valid9))
AGGG_valid10<-AGGG_valid9[row.names(AGGG_valid9) %in% patient_name$X5 , ]
AGGG_valid10$label<-row.names(AGGG_valid10)
AGGG_valid10$label<-gsub("[0-9]","",AGGG_valid10$label)
# AGGG_valid10[AGGG_valid10==0]<-NA
###delete GG4   too much NA 
AGGG_valid10<-AGGG_valid10[!row.names(AGGG_valid10)=="GG4",]
#####AGGG_valid10 is the test matrix

BCCC_valid<-read.table("matrix/DIA_validation/202101022KRUK_B_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
BCCC_sampleName<-data.frame(str_split_fixed(c(names(BCCC_valid)),pattern = "_",10))
names(BCCC_valid)<-BCCC_sampleName$X10
row.names(BCCC_valid)<-BCCC_valid[,1]
BCCC_valid2<-BCCC_valid[,grep("BC|CC",names(BCCC_valid))]
names(BCCC_valid2)<-gsub(".raw","",names(BCCC_valid2))
BCCC_valid3<-data.frame(t(BCCC_valid2))
BCCC_valid3$sample<-row.names(BCCC_valid3)
BCCC_valid3$sample<-gsub("_rep","",BCCC_valid3$sample)
BCCC_valid4<-aggregate(BCCC_valid3[,-ncol(BCCC_valid3)],by=list(BCCC_valid3$sample),mean,na.rm=T)
BCCC_valid5<-BCCC_valid4[,-1]
row.names(BCCC_valid5)<-BCCC_valid4$Group.1
BCCC_valid6<-data.frame(t(BCCC_valid5))
BCCC_valid6$prot<-row.names(BCCC_valid6)
BCCC_protname<-data.frame(bitr(BCCC_valid6$prot, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db"))
BCCC_protname$prot<-paste0(BCCC_protname$UNIPROT,"_",BCCC_protname$SYMBOL)
names(BCCC_protname)<-c("prot","gene","name")
BCCC_valid7<-merge(BCCC_protname,BCCC_valid6,by="prot",all=T)
BCCC_valid8<-log2(BCCC_valid7[,-c(1:3)])
BCCC_valid7<-cbind(BCCC_valid7[,c(1:3)],BCCC_valid8)

AGGG_valid11<-data.frame(t(AGGG_valid10))
AGGG_valid11$name<-row.names(AGGG_valid11)
valid<-merge(BCCC_valid7[,-c(1:2)],AGGG_valid11,by="name",all=T)
valid1<-data.frame(apply(valid[,-1],2, function(x) {as.numeric(x)}))
valid1[is.na(valid1)]<-0
valid1[valid1==0]<-NA
valid1$prot<-valid$name
valid2<-valid1[apply(valid1[,-ncol(valid1)],1,function(x) {sum(is.na(x))/ncol(valid1[,-ncol(valid1)])})<0.7,]
valid3<-valid2[valid2$prot %in% names(AGBC_GGCC9), ]
valid4<-valid3[,-ncol(valid3)]
row.names(valid4)<-valid3$prot
valid5<-data.frame(t(valid4))
valid5$label<-row.names(valid5)
valid5$label<-gsub("[0-9]","",valid5$label)
valid5[is.na(valid5)]<-0
###valid5 is valid matrix

AG_GG_pathway_prot<-read.csv("RandomForest/AG_GG_pathwayprot.csv")
AG_GG_train<-AGBC_GGCC9[,names(AGBC_GGCC9) %in% AG_GG_pathway_prot$X]
AG_GG_train$label<-AGBC_GGCC9$label
AG_GG_train<-AG_GG_train[AG_GG_train$label %in% c("AG","GG"),]
AG_GG_valid<-valid5[valid5$label %in% c("AG","GG"),]

write.csv(AG_GG_valid,"RandomForest/TMP_run_KRUK/AG_GG_valid.csv")
write.csv(AG_GG_train,"RandomForest/TMP_run_KRUK/AG_GG_train.csv")




set.seed(2020)
tmpRF_AG_GG <- randomForest(as.factor(label) ~ . ,data=AGBC_GGCC9[AGBC_GGCC9$label %in% c("AG","GG"),],importance=T,ntree=3000,nodesize=1)
result_AG_GG <- data.frame(importance(tmpRF_AG_GG,type=1))
AG_GG_Feature<-result_AG_GG %>%  top_n(200, MeanDecreaseAccuracy)

set.seed(2020)
tmpRF_AG_GG_valid <- randomForest(as.factor(label) ~ . ,data=valid5[valid5$label %in% c("AG","GG"),],importance=T,ntree=3000,nodesize=1)
result_AG_GG_valid <- data.frame(importance(tmpRF_AG_GG_valid,type=1))
AG_GG_valid_Feature<-result_AG_GG_valid %>%  top_n(200, MeanDecreaseAccuracy)
AG_GG_valid_Feature$MeanDecreaseAccuracy<-row.names(AG_GG_valid_Feature)
AG_GG_Feature$MeanDecreaseAccuracy<-row.names(AG_GG_Feature)
overlap<-AG_GG_valid_Feature[row.names(AG_GG_valid_Feature) %in% row.names(AG_GG_Feature),]









source("common_change_label.R")
color<-c("red","blue","black","green")
plotTrain<-drawUMAP(AGBC_GGCC9,color,colNormalization = T,rowNormalization = T)

plotValid_AGGG<-drawUMAP(valid5[valid5$label %in% c("AG","GG"),],color,T,T)
plotValid_BCCC<-drawUMAP(valid5[valid5$label %in% c("BC","CC"),],color,T,T)



prot_select<-c("LAMA2|LAMA3|LAMA4|LAMA5|LAMB1|LAMB2|LAMC1|COL1A1|COL1A2|COL3A1|COL4A1|COL4A2|COL5A1|COL5A2|COL6A1|COL6A2|COL6A3|COL18A1|ITGA3|ITGA5|ITGA7|ITGAV|ITGB1|NID1|NID2")
AG_GG_down<-read.csv("volcano/AG_GG_down.csv")
AG_GG_up<-read.csv("volcano/AG_GG_up.csv")
AG_GG<-rbind(AG_GG_down,AG_GG_up)
BC_CC_down<-read.csv("volcano/BC_CC_down.csv")
BC_CC_up<-read.csv("volcano/BC_CC_up.csv")
BC_CC<-rbind(BC_CC_down,BC_CC_up)
df1<-AG_GG
df2<-BC_CC
df3<-df1[df1$X %in% df2$X,]
protOverlap<-c(as.matrix(df3$X))

#### write.csv
train0<-AGBC_GGCC9[,!names(AGBC_GGCC9) %in% protOverlap ]
train0.5<-train0[,-grep(prot_select,names(train0))]
train<-AGBC_GGCC9[,!names(AGBC_GGCC9) %in% names(train0.5) ]
train$label<-AGBC_GGCC9$label
write.csv(train,"RandomForest/TMP_run_KRUK/AGBC_GGCC_train.csv",row.names = T)
write.csv(valid5,"RandomForest/TMP_run_KRUK/AGBC_GGCC_valid5.csv",row.names = T)
```




```{r Randomforest for BCAG_CCGG_final 20220815}
####using whole matrix(delete proteins with missing value > 0.7)

rm(list=ls())
library(readxl)
library(magrittr)
library(readxl)
library(randomForest)
library(umap)
library(ROSE)
library(caret)
library(pROC)
library(magrittr)
library(tidyverse)
library(stringr)
library(DMwR)
library(clusterProfiler)
library(org.Hs.eg.db)
source("datamining_library_ge20200902.R")
info<-read_excel("name.xlsx",sheet = 1)
info$subtype<-paste0(info$PType,info$Location)
df<-read.table("matrix/diann_KRUK_protein_20200828_REnames.txt",sep = "\t",stringsAsFactors = F,header = T)
names(df) <- ge.split(names(df),"\\.mzML",1,"DIA_")
df1<-df[,-1]
row.names(df1)<-df[,1]

##delete protein group
df2<-df1[-grep(";",row.names(df1)),]

## average tech rep
df3<-data.frame(t(df2))
df3$label<-row.names(df3)
df4<-df3[-grep("pool",df3$label),]
df4$label<-gsub("b","",df4$label)
df5<-aggregate(x = df4[,-which(names(df4)=="label")], by = list(df4$label), FUN = "mean",na.rm=T)
df5$batch<-paste0("b",df5$Group.1)
df6<-df5[,-1]
df7<-merge(info,df6,by.x="batch",all=F)
df7<-df7[-grep("A20",df7$sampleID),]
##  delete G18Ga,G20Ga,G29Ga,G37Ga,G40Ga,
df7<-df7[-grep("G18Ga|G20Ga|G29Ga|G37Ga|G40Ga", df7$sampleID),]

###FOr AGBC_GGCC

library(RColorBrewer)
AGBC_GGCC1<-df7[which(df7$subtype %in% c("AG","GG","BC","CC")),-c(2:12)]
AGBC_GGCC2<-AGBC_GGCC1[,-1]
row.names(AGBC_GGCC2)<-AGBC_GGCC1$batch
AGBC_GGCC2[is.na(AGBC_GGCC2)]<-NA

###Delete NA 小于70%
AGBC_GGCC3<-AGBC_GGCC2[, apply(AGBC_GGCC2,2,function(x) {sum(is.na(x))/nrow(AGBC_GGCC2)}) < 0.7]
info<-read_excel("name.xlsx",sheet = 1)
info<-info[-grep("A20", info$sampleID),]
info$subtype<-paste0(info$PType,info$Location)
AGBC_GGCC3$batch<-row.names(AGBC_GGCC3)
AGBC_GGCC4<-merge(info,AGBC_GGCC3,by="batch",all=F)
AGBC_GGCC5<-AGBC_GGCC4[AGBC_GGCC4$subtype.x %in% c("AG","GG","BC","CC"),]
AGBC_GGCC6<-aggregate(AGBC_GGCC5[,-c(1:14)],  by=list(AGBC_GGCC5$pathology),  mean,na.rm=T)


names(AGBC_GGCC6)<-c("pathology",names(AGBC_GGCC6[,-1]))
AGBC_GGCC7<-merge(data.frame(unique(AGBC_GGCC5[,c("pathology","subtype.x")])),AGBC_GGCC6,by.x ="pathology",all.Y=F)

AGBC_GGCC8<-AGBC_GGCC7[,-1]
row.names(AGBC_GGCC8)<-AGBC_GGCC7$pathology
AGBC_GGCC9<-data.frame(AGBC_GGCC8[,1],(AGBC_GGCC8[,-1]))
names(AGBC_GGCC9)<-c("label",names(AGBC_GGCC9[,-1]))
AGBC_GGCC9.1<-log2(AGBC_GGCC9[,-1])
AGBC_GGCC9.1$label<-AGBC_GGCC9$label
AGBC_GGCC9<-AGBC_GGCC9.1
AGBC_GGCC9[is.na(AGBC_GGCC9)]<-0
#####AGBC_GGCC9 is the training matrix



AGGG_valid<-read.table("matrix/DIA_validation/20211019KRUK_A_protein_matrix_rename.txt",sep = "\t",stringsAsFactors = F,header = T)
AGGG_valid2<-AGGG_valid
AGGG_valid4<-AGGG_valid2[,-c(1)]
row.names(AGGG_valid4)<-paste0(AGGG_valid2$prot)
AGGG_valid5<-data.frame(t(AGGG_valid4))
AG_valid<-AGGG_valid5[grep("AG",row.names(AGGG_valid5)),]
GG_valid<-AGGG_valid5[grep("GG",row.names(AGGG_valid5)),]
AGGG_valid6<-data.frame(rbind(AG_valid, GG_valid))
AGGG_sampleName<-data.frame(str_split_fixed(c(row.names(AGGG_valid6)),pattern = "_",10))
AGGG_sampleName2<-gsub("_rep","",AGGG_sampleName[,10])
AGGG_valid7<-aggregate(AGGG_valid6, by=list(AGGG_sampleName2), mean, na.rm=T)
AGGG_valid8<-AGGG_valid7[,-1]
AGGG_valid9<-log2(AGGG_valid8)
AGGG_valid9[is.na(AGGG_valid9)]<-0
row.names(AGGG_valid9)<-AGGG_valid7$Group.1
#select name from MRM
mrm<-read.csv("matrix/MRM_validation/KRUK_AG_GG_MRM_matrix.csv")
patient_name<- data.frame(str_split_fixed(names(mrm),"_",6))
patient_name$X5<-gsub(".Total.Area.Fragment","",patient_name$X5)
row.names(AGGG_valid9)<-gsub(".raw","",row.names(AGGG_valid9))
AGGG_valid10<-AGGG_valid9[row.names(AGGG_valid9) %in% patient_name$X5 , ]
AGGG_valid10$label<-row.names(AGGG_valid10)
AGGG_valid10$label<-gsub("[0-9]","",AGGG_valid10$label)
# AGGG_valid10[AGGG_valid10==0]<-NA
###delete GG4   too much NA 
AGGG_valid10<-AGGG_valid10[!row.names(AGGG_valid10)=="GG4",]
#####AGGG_valid10 is the test matrix
BCCC_valid<-read.table("matrix/DIA_validation/202101022KRUK_B_protein_matrix.txt",sep = "\t",stringsAsFactors = F,header = T)
BCCC_sampleName<-data.frame(str_split_fixed(c(names(BCCC_valid)),pattern = "_",10))
names(BCCC_valid)<-BCCC_sampleName$X10
row.names(BCCC_valid)<-BCCC_valid[,1]
BCCC_valid2<-BCCC_valid[,grep("BC|CC",names(BCCC_valid))]
names(BCCC_valid2)<-gsub(".raw","",names(BCCC_valid2))
BCCC_valid3<-data.frame(t(BCCC_valid2))
BCCC_valid3$sample<-row.names(BCCC_valid3)
BCCC_valid3$sample<-gsub("_rep","",BCCC_valid3$sample)
BCCC_valid4<-aggregate(BCCC_valid3[,-ncol(BCCC_valid3)],by=list(BCCC_valid3$sample),mean,na.rm=T)
BCCC_valid5<-BCCC_valid4[,-1]
row.names(BCCC_valid5)<-BCCC_valid4$Group.1
BCCC_valid6<-data.frame(t(BCCC_valid5))
BCCC_valid6$prot<-row.names(BCCC_valid6)
BCCC_protname<-data.frame(bitr(BCCC_valid6$prot, fromType = "UNIPROT",toType = "SYMBOL",OrgDb = "org.Hs.eg.db"))
BCCC_protname$prot<-paste0(BCCC_protname$UNIPROT,"_",BCCC_protname$SYMBOL)
names(BCCC_protname)<-c("prot","gene","name")
BCCC_valid7<-merge(BCCC_protname,BCCC_valid6,by="prot",all=T)
BCCC_valid8<-log2(BCCC_valid7[,-c(1:3)])
BCCC_valid7<-cbind(BCCC_valid7[,c(1:3)],BCCC_valid8)


AGGG_valid11<-data.frame(t(AGGG_valid10))
AGGG_valid11$name<-row.names(AGGG_valid11)
valid<-merge(BCCC_valid7[,-c(1:2)],AGGG_valid11,by="name",all=T)
valid1<-data.frame(apply(valid[,-1],2, function(x) {as.numeric(x)}))
valid1[is.na(valid1)]<-0
valid1[valid1==0]<-NA
valid1$prot<-valid$name
valid2<-valid1[apply(valid1[,-ncol(valid1)],1,function(x) {sum(is.na(x))/ncol(valid1[,-ncol(valid1)])})<0.7,]
valid3<-valid2[valid2$prot %in% names(AGBC_GGCC9), ]
valid4<-valid3[,-ncol(valid3)]
row.names(valid4)<-valid3$prot
valid5<-data.frame(t(valid4))
valid5$label<-row.names(valid5)
valid5$label<-gsub("[0-9]","",valid5$label)
# valid6<-2^valid5[,-c(ncol(valid5))]


valid5[is.na(valid5)]<-0
###valid5 is valid matrix
# write.csv(valid6,"RandomForest/KMDR_valid_matrix.csv")

############################################################################################################for AG GG
AG_GG_pathway_prot<-read.csv("RandomForest/AG_GG/AG_GG_pathwayprot.csv")
AG_GG_train<-AGBC_GGCC9[,names(AGBC_GGCC9) %in% AG_GG_pathway_prot$X]
AG_GG_train$label<-AGBC_GGCC9$label
AG_GG_train<-AG_GG_train[AG_GG_train$label %in% c("AG","GG"),]
AG_GG_valid<-valid5[valid5$label %in% c("AG","GG"),]

set.seed(2022)
tmpRF_AG_GG <- randomForest(as.factor(label) ~ . ,data=AG_GG_train,importance=T,ntree=1000,nodesize=1)
result_AG_GG <- data.frame(importance(tmpRF_AG_GG,type=1))
feature<-result_AG_GG %>%  top_n(10, MeanDecreaseAccuracy)
feature$MeanDecreaseAccuracy<-row.names(feature)
# plot(tmpRF_BC_CC)
pdf("RandomForest/AG_GG/varImpPlot_AG_GG_20220823.pdf")
varImpPlot(tmpRF_AG_GG)
dev.off()


trainsModel<-AG_GG_train[,names(AG_GG_train)%in% feature$MeanDecreaseAccuracy ]
trainsModel$label<-AG_GG_train$label
validsModel<-AG_GG_valid[,names(AG_GG_valid) %in% names(AG_GG_train)]






set.seed(2022)
folds <- createFolds(trainsModel$label,2)
#randomforest
for (aa in 3:5) {
accu <- c()
for (i in aa) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1:ncol(feature2) ) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
for (k in 1:2) {
  set.seed(2020.3)
fold= as.vector(unlist(folds[1]))
trains <- data.frame(trainsModel[,result1])
trains$label<-trainsModel$label
trains_cross <- data.frame(trains[setdiff(1:dim(trains)[1],fold),])
test_cross <- data.frame(trains[fold,])
valids <- data.frame(validsModel[,result1])
valids$label <- validsModel$label
tmpRF_cross <- randomForest(as.factor(label) ~ . ,data=trains_cross,importance=T,ntree=1000,nodesize=1,proximity=T)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
predicts<- data.frame(predict(tmpRF,valids,type='prob'))
predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
predicts$observed <- valids$label
 ROC <- roc(predicts$observed, as.numeric(predicts$AG))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
  train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$AG))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
train_model_predict_cross<-data.frame(tmpRF_cross$votes,tmpRF_cross$predicted, trains_cross$label)
names(train_model_predict_cross)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict_cross <- roc(train_model_predict_cross$observed, as.numeric(train_model_predict_cross$AG))
ROC_train_model_predict_auc_cross <- as.numeric(ROC_train_model_predict_cross[["auc"]])
predicts_cross<- data.frame(predict(tmpRF_cross,test_cross,type='prob'))
predicts_cross$predicted <- apply(predicts_cross,1,function(v){names(v)[max(v)==v]})
predicts_cross$observed <- test_cross$label
 ROC_cross <- roc(predicts_cross$observed, as.numeric(predicts_cross$AG))
         auc_cross <- as.numeric(ROC_cross[["auc"]])
      	 acc_cross <- sum(predicts_cross$predicted==predicts_cross$observed)
	 
      	 sum<-c(i,m, k,acc/25,auc,ROC_train_model_predict_auc,acc_cross/nrow(test_cross),auc_cross,ROC_train_model_predict_auc_cross )
         accu <- data.frame(rbind(accu,sum))
         
}
}
}
names(accu)<-c("i","m","k","acc","test_auc","train_auc","acc_cross","test_auc_cross","train_auc_cross")
accu1 <- accu
accu2<-aggregate(accu1[,-3],by=list(accu1$m,accu1$i),mean)
write.csv(accu2,paste0("RandomForest/AG_GG/accu2/",i,"accu2_0815.csv"))
write.csv(accu1,paste0("RandomForest/AG_GG/accu1/",i,"accu1_0815.csv"))

}


source("D:\\onedrive\\OneDrive_WU\\FUDAN\\rFUN_LiuW/basic-functions.R")
AG_GG_accu1<-lw.combineAllFile(file = "RandomForest/AG_GG/accu1/",file.type = "csv")
AG_GG_accu2<-lw.combineAllFile(file = "RandomForest/AG_GG/accu2/",file.type = "csv")



#bestfeature i=3 m=1

for (aa in 3) {
accu <- c()
for (i in aa) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
set.seed(2020.3)
for (k in 1:2) {
fold= as.vector(unlist(folds[1]))
trains <- data.frame(trainsModel[,result1])
trains$label<-trainsModel$label
trains_cross <- data.frame(trains[setdiff(1:dim(trains)[1],fold),])
test_cross <- data.frame(trains[fold,])
valids <- data.frame(validsModel[,result1])
valids$label <- validsModel$label
tmpRF_cross <- randomForest(as.factor(label) ~ . ,data=trains_cross,importance=T,ntree=1000,nodesize=1,proximity=T)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
predicts<- data.frame(predict(tmpRF,valids,type='prob'))
predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
predicts$observed <- valids$label
 ROC <- roc(predicts$observed, as.numeric(predicts$AG))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
  train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$AG))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
train_model_predict_cross<-data.frame(tmpRF_cross$votes,tmpRF_cross$predicted, trains_cross$label)
names(train_model_predict_cross)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict_cross <- roc(train_model_predict_cross$observed, as.numeric(train_model_predict_cross$AG))
ROC_train_model_predict_auc_cross <- as.numeric(ROC_train_model_predict_cross[["auc"]])
predicts_cross<- data.frame(predict(tmpRF_cross,test_cross,type='prob'))
predicts_cross$predicted <- apply(predicts_cross,1,function(v){names(v)[max(v)==v]})
predicts_cross$observed <- test_cross$label
 ROC_cross <- roc(predicts_cross$observed, as.numeric(predicts_cross$AG))
         auc_cross <- as.numeric(ROC_cross[["auc"]])
      	 acc_cross <- sum(predicts_cross$predicted==predicts_cross$observed)
	 
      	 sum<-c(i,m, k,acc/25,auc,ROC_train_model_predict_auc,acc_cross/nrow(test_cross),auc_cross,ROC_train_model_predict_auc_cross )
         accu <- data.frame(rbind(accu,sum))
         
}
}
}
}

###plot model

for (pointLine in 0.6) {
  
##ROC
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("AG", "GG","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$AG))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
pdf("RandomForest/AG_GG/AG_GG_ROC_train20220823.pdf")
plot(ROC_train_model_predict,cor="blue",main= ROC_train_model_predict_auc)
dev.off()
pdf("RandomForest/AG_GG/AG_GG_ROC_test20230613.pdf")
plot(ROC,cor="blue",main= auc)
dev.off()

##Confusion matrix
library(dplyr)
train_model_comfusion<-train_model_predict
train_model_comfusion$predicted<-ifelse(train_model_comfusion$GG > pointLine, "GG", "AG")
Train_comfusion<-confusionMatrix( factor(train_model_comfusion$predicted, levels = c( "AG","GG")),factor(train_model_comfusion$observed, levels = c( "AG","GG")))
capture.output(Train_comfusion, file = "RandomForest/AG_GG/train_model_statistics_20230613.txt")

test_model_comfusion<-predicts
test_model_comfusion$predicted<-ifelse(test_model_comfusion$GG > pointLine, "GG", "AG")

Test_comfusion<-confusionMatrix( factor(test_model_comfusion$predicted, levels = c( "AG","GG")),factor(test_model_comfusion$observed, levels = c( "AG","GG")))

capture.output(Test_comfusion, file = "RandomForest/AG_GG/test_model_statistics_20230613.txt")



  ##point plot
  mean <- apply( valids[,-ncol(valids)],1,mean)
  data <- data.frame(mean,predicts=predicts$GG,sample2=row.names(predicts),type2=predicts$observed )
  
  ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
    a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
      geom_point()+geom_vline(xintercept = pointLine ,linetype="dotted")+
      ggtitle(paste0(title,"_pointplot"))+
      xlab(xlab)+
      ylab(ylab)+
      xlim(0,1)+
      theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
            legend.title = element_text(size=15,color="black") ,
            panel.grid.major =element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            axis.line = element_line(colour = "black"))+
      scale_color_manual(values=c("#FDB462","#BC80BD"))+
      theme(panel.grid =element_blank())+
      theme(axis.text = element_text(size = 10,color = "black"))+
      theme(axis.text.x = element_text( hjust = 0.5))+
      theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
      theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
      theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
    ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
  }
  
  ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/AG_GG/AG_GG_PointPlot_test_20220823","predict value","mean")
  
write.csv(valids,"RandomForest/AG_GG/AG_GG_proteins_in_valids_20230613.csv")
  
 mean <- apply( trains[,-ncol(trains)],1,mean)
  data <- data.frame(mean,predicts=train_model_predict$GG,sample2=row.names(train_model_predict),type2=train_model_predict$observed )
  # data$sample2<-gsub(".Total.Area.Fragment","",data$sample2)
  # data$sample2<-gsub("H20210803yixiao_KRUK_MRM_60min_","",data$sample2)
  # data$sample2<-gsub("_20210805133011","",data$sample2)
  # data$sample2<-gsub("_20210805144702","",data$sample2)
  ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
    a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
      geom_point()+geom_vline(xintercept = pointLine ,linetype="dotted")+
      ggtitle(paste0(title,"_pointplot"))+
      xlab(xlab)+
      ylab(ylab)+
      xlim(0,1)+
      theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
            legend.title = element_text(size=15,color="black") ,
            panel.grid.major =element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            axis.line = element_line(colour = "black"))+
      scale_color_manual(values=c("#FDB462","#BC80BD"))+
      theme(panel.grid =element_blank())+
      theme(axis.text = element_text(size = 10,color = "black"))+
      theme(axis.text.x = element_text( hjust = 0.5))+
      theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
      theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
      theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
    ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
  }
  ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/AG_GG/AG_GG_PointPlot_train_20220823","predict value","mean")
  write.csv(trains,"RandomForest/AG_GG/AG_GG_proteins_in_trains_20230613.csv")
  
###boxplot
library(ggpubr)
library(reshape2)
boxplot1<-melt(trains,id.vars = c("label"))
p <- ggboxplot(boxplot1, x = "variable", y = "value",
          color = "label", palette = "jco",
          add = "jitter", title = "train AG GG")
a<-p + stat_compare_means(aes(group = label),label = "p.format",method ="t.test")
 ggsave(plot=a,"RandomForest/AG_GG/boxplot_for_AG_GG_trains_20230613.pdf",device = NULL)

 boxplot1<-melt(valids,id.vars = c("label"))
p <- ggboxplot(boxplot1, x = "variable", y = "value",
          color = "label", palette = "jco",
          add = "jitter", title = "valid AG GG")
a<-p + stat_compare_means(aes(group = label),label = "p.format",method ="t.test")
 ggsave(plot=a,"RandomForest/AG_GG/boxplot_for_AG_GG_valid_20230613.pdf",device = NULL)

}

############################################################################################################for BC CC cross-validation
BC_CC_pathway_prot<-read.csv("RandomForest/BC_CC/BC_CC_pathwayprot.csv")
BC_CC_train<-AGBC_GGCC9[,names(AGBC_GGCC9) %in% BC_CC_pathway_prot$X]
BC_CC_train$label<-AGBC_GGCC9$label
BC_CC_train<-BC_CC_train[BC_CC_train$label %in% c("BC","CC"),]
BC_CC_valid<-valid5[valid5$label %in% c("BC","CC"),]

###BC_CC_valid is BC_CC train matrix
set.seed(2022)
tmpRF_BC_CC <- randomForest(as.factor(label) ~ . ,data=BC_CC_train,importance=T,ntree=1000,nodesize=1)
result_BC_CC <- data.frame(importance(tmpRF_BC_CC,type=1))
feature<-result_BC_CC %>%  top_n(10, MeanDecreaseAccuracy)
feature$MeanDecreaseAccuracy<-row.names(feature)
# plot(tmpRF_BC_CC)
pdf("RandomForest/BC_CC/varImpPlot_BC_CC_20220823.pdf")
varImpPlot(tmpRF_BC_CC)
dev.off()
trainsModel<-BC_CC_train[,names(BC_CC_train)%in% feature$MeanDecreaseAccuracy ]
trainsModel$label<-BC_CC_train$label
validsModel<-BC_CC_valid[,names(BC_CC_valid) %in% names(trainsModel)]

#randomforest
set.seed(2022)
folds <- createFolds(trainsModel$label,2)
#randomforest
for (aa in 3:5) {
accu <- c()
for (i in aa) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 1:ncol(feature2) ) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
for (k in 1:2) {
  set.seed(2020.3)
fold= as.vector(unlist(folds[1]))
trains <- data.frame(trainsModel[,result1])
trains$label<-trainsModel$label
trains_cross <- data.frame(trains[setdiff(1:dim(trains)[1],fold),])
test_cross <- data.frame(trains[fold,])
valids <- data.frame(validsModel[,result1])
valids$label <- validsModel$label
tmpRF_cross <- randomForest(as.factor(label) ~ . ,data=trains_cross,importance=T,ntree=1000,nodesize=1,proximity=T)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
predicts<- data.frame(predict(tmpRF,valids,type='prob'))
predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
predicts$observed <- valids$label
 ROC <- roc(predicts$observed, as.numeric(predicts$BC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
  train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("BC", "CC","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$BC))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
train_model_predict_cross<-data.frame(tmpRF_cross$votes,tmpRF_cross$predicted, trains_cross$label)
names(train_model_predict_cross)<-c("BC", "CC","predicted", "observed" )
ROC_train_model_predict_cross <- roc(train_model_predict_cross$observed, as.numeric(train_model_predict_cross$BC))
ROC_train_model_predict_auc_cross <- as.numeric(ROC_train_model_predict_cross[["auc"]])
predicts_cross<- data.frame(predict(tmpRF_cross,test_cross,type='prob'))
predicts_cross$predicted <- apply(predicts_cross,1,function(v){names(v)[max(v)==v]})
predicts_cross$observed <- test_cross$label
 ROC_cross <- roc(predicts_cross$observed, as.numeric(predicts_cross$BC))
         auc_cross <- as.numeric(ROC_cross[["auc"]])
      	 acc_cross <- sum(predicts_cross$predicted==predicts_cross$observed)
	       sum<-c(i,m, k,acc/53,auc,ROC_train_model_predict_auc,acc_cross/nrow(test_cross),auc_cross,ROC_train_model_predict_auc_cross )
         accu <- data.frame(rbind(accu,sum))
         
}
}
}
names(accu)<-c("i","m","k","acc","test_auc","train_auc","acc_cross","test_auc_cross","train_auc_cross")
accu1 <- accu
accu2<-aggregate(accu1[,-3],by=list(accu1$m,accu1$i),mean)
write.csv(accu2,paste0("RandomForest/BC_CC/accu2/",i,"accu2_0815.csv"))
write.csv(accu1,paste0("RandomForest/BC_CC/accu1/",i,"accu1_0815.csv"))

}

source("D:\\onedrive\\OneDrive_WU\\FUDAN\\rFUN_LiuW/basic-functions.R")
BC_CC_accu1<-lw.combineAllFile(file = "RandomForest/BC_CC/accu1/",file.type = "csv")
BC_CC_accu2<-lw.combineAllFile(file = "RandomForest/BC_CC/accu2",file.type = "csv")

for (aa in 5) {
accu <- c()
for (i in aa) {
feature2 <-data.frame(combn(c( 1:nrow(feature)),i))
for (m in 33 ) {
feature3<-as.numeric(feature2[,m])
result1<-c(as.matrix(feature[feature3,1]))
for (k in 1:2) {
  set.seed(2020.3)
fold= as.vector(unlist(folds[1]))
trains <- data.frame(trainsModel[,result1])
trains$label<-trainsModel$label
trains_cross <- data.frame(trains[setdiff(1:dim(trains)[1],fold),])
test_cross <- data.frame(trains[fold,])
valids <- data.frame(validsModel[,result1])
valids$label <- validsModel$label
tmpRF_cross <- randomForest(as.factor(label) ~ . ,data=trains_cross,importance=T,ntree=1000,nodesize=1,proximity=T)
tmpRF <- randomForest(as.factor(label) ~ . ,data=trains,importance=T,ntree=1000,nodesize=1,proximity=T)
predicts<- data.frame(predict(tmpRF,valids,type='prob'))
predicts$predicted <- apply(predicts,1,function(v){names(v)[max(v)==v]})
predicts$observed <- valids$label
 ROC <- roc(predicts$observed, as.numeric(predicts$BC))
         auc <- as.numeric(ROC[["auc"]])
      	 acc <- sum(predicts$predicted==predicts$observed)
  train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("BC", "CC","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$BC))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
train_model_predict_cross<-data.frame(tmpRF_cross$votes,tmpRF_cross$predicted, trains_cross$label)
names(train_model_predict_cross)<-c("BC", "CC","predicted", "observed" )
ROC_train_model_predict_cross <- roc(train_model_predict_cross$observed, as.numeric(train_model_predict_cross$BC))
ROC_train_model_predict_auc_cross <- as.numeric(ROC_train_model_predict_cross[["auc"]])
predicts_cross<- data.frame(predict(tmpRF_cross,test_cross,type='prob'))
predicts_cross$predicted <- apply(predicts_cross,1,function(v){names(v)[max(v)==v]})
predicts_cross$observed <- test_cross$label
 ROC_cross <- roc(predicts_cross$observed, as.numeric(predicts_cross$BC))
         auc_cross <- as.numeric(ROC_cross[["auc"]])
      	 acc_cross <- sum(predicts_cross$predicted==predicts_cross$observed)
	 
      	 sum<-c(i,m, k,acc/53,auc,ROC_train_model_predict_auc,acc_cross/nrow(test_cross),auc_cross,ROC_train_model_predict_auc_cross )
         accu <- data.frame(rbind(accu,sum))
         
}
}
}
names(accu)<-c("i","m","k","acc","test_auc","train_auc","acc_cross","test_auc_cross","train_auc_cross")
accu1 <- accu
accu2<-aggregate(accu1[,-3],by=list(accu1$m,accu1$i),mean)

}

###plot model

for (pointLine in 0.5) {
##ROC
train_model_predict<-data.frame(tmpRF$votes,tmpRF$predicted, trainsModel$label)
names(train_model_predict)<-c("BC", "CC","predicted", "observed" )
ROC_train_model_predict <- roc(train_model_predict$observed, as.numeric(train_model_predict$BC))
ROC_train_model_predict_auc <- as.numeric(ROC_train_model_predict[["auc"]])
pdf("RandomForest/BC_CC/train_BC_CC_ROC_20230613.pdf")
plot(ROC_train_model_predict,cor="blue",main= ROC_train_model_predict_auc)
dev.off()
pdf("RandomForest/BC_CC/test_BC_CC_ROC_20230613.pdf")
plot(ROC,cor="blue",main= auc)
dev.off()

##Confusion matrix

library(dplyr)
train_model_comfusion<-train_model_predict
train_model_comfusion$predicted<-ifelse(train_model_comfusion$CC > pointLine, "CC", "BC")
Train_comfusion<-confusionMatrix( factor(train_model_comfusion$predicted, levels = c(  "CC", "BC")),factor(train_model_comfusion$observed, levels = c( "CC","BC")))
capture.output(Train_comfusion, file = "RandomForest/BC_CC//BC_CC_train_model_statistics_20230613.txt")

test_model_comfusion<-predicts
test_model_comfusion$predicted<-ifelse(test_model_comfusion$CC > pointLine,  "CC", "BC")

Test_comfusion<-confusionMatrix( factor(test_model_comfusion$predicted, levels = c("CC", "BC")),factor(test_model_comfusion$observed, levels = c("CC", "BC")))
capture.output(Test_comfusion, file = "RandomForest/BC_CC/BC_CC_test_model_statistics_20230613.txt")

  ##point plot
  mean <- apply( valids[,-ncol(valids)],1,mean)
  data <- data.frame(mean,predicts=predicts$CC,sample2=row.names(predicts),type2=predicts$observed )
  
  ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
    a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
      geom_point()+geom_vline(xintercept = pointLine ,linetype="dotted")+
      ggtitle(paste0(title,"_pointplot"))+
      xlab(xlab)+
      ylab(ylab)+
      xlim(0,1)+
      theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
            legend.title = element_text(size=15,color="black") ,
            panel.grid.major =element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            axis.line = element_line(colour = "black"))+
      scale_color_manual(values=c("#FDB462","#BC80BD"))+
      theme(panel.grid =element_blank())+
      theme(axis.text = element_text(size = 10,color = "black"))+
      theme(axis.text.x = element_text( hjust = 0.5))+
      theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
      theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
      theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
    ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
  }
  
  
  ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/BC_CC/BC_CC_PointPlot_test_20230605_2","predict value","mean")
  
write.csv(valids,"RandomForest/BC_CC/BC_CC_proteins_in_valids_20230613.csv")
  
 mean <- apply( trains[,-ncol(trains)],1,mean)
  data <- data.frame(mean,predicts=train_model_predict$CC,sample2=row.names(train_model_predict),type2=train_model_predict$observed )
  # data$sample2<-gsub(".Total.Area.FrBCment","",data$sample2)
  # data$sample2<-gsub("H20210803yixiao_KRUK_MRM_60min_","",data$sample2)
  # data$sample2<-gsub("_20210805133011","",data$sample2)
  # data$sample2<-gsub("_20210805144702","",data$sample2)
  ge.plot.point <- function(data,sample,value,type,group,title="",xlab="sample",ylab="value"){
    a <- ggplot(data,aes(x=sample,y=value,group=group,color=group))+ 
      geom_point()+geom_vline(xintercept = pointLine ,linetype="dotted")+
      ggtitle(paste0(title,"_pointplot"))+
      xlab(xlab)+
      ylab(ylab)+
      xlim(0,1)+
      theme(legend.text = element_text(size = 15,color = "black"),legend.position = 'top',
            legend.title = element_text(size=15,color="black") ,
            panel.grid.major =element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            axis.line = element_line(colour = "black"))+
      scale_color_manual(values=c("#FDB462","#BC80BD"))+
      theme(panel.grid =element_blank())+
      theme(axis.text = element_text(size = 10,color = "black"))+
      theme(axis.text.x = element_text( hjust = 0.5))+
      theme(plot.subtitle=element_text(size=30, hjust=0, color="black"))+
      theme(axis.title.x=element_text(size=17, hjust=0.5, color="black"))+
      theme(axis.title.y=element_text(size=17, hjust=0.5, color="black"))+  geom_text(aes(label=type,vjust = -0.5, hjust = 0.3),size = 2,show.legend = FALSE)
    ggsave(paste0(title,"_pointplot.pdf"),plot=a,width=4,height=6)
  }
  ge.plot.point(data,data$predicts,data$mean,data$sample2,data$type2, "RandomForest/BC_CC/BC_CC_PointPlot_train__20230613","predict value","mean")
  
  
  
  write.csv(trains,"RandomForest/BC_CC_proteins_in_trains_20230613.csv")
  
  ###boxplot
  library(ggpubr)
library(reshape2)
boxplot1<-melt(trains,id.vars = c("label"))
p <- ggboxplot(boxplot1, x = "variable", y = "value",
          color = "label", palette = "jco",
          add = "jitter", title = "trains BC CC")
a<-p + stat_compare_means(aes(group = label),label = "p.format",method ="t.test")
 ggsave(plot=a,"RandomForest/BC_CC/boxplot_for_BC_CC_trains_20230613.pdf",device = NULL )
  
boxplot1<-melt(valids,id.vars = c("label"))
p <- ggboxplot(boxplot1, x = "variable", y = "value",
          color = "label", palette = "jco",
          add = "jitter", title = "valids BC CC")
a<-p + stat_compare_means(aes(group = label),label = "p.format",method ="t.test")
 ggsave(plot=a,"RandomForest/BC_CC/boxplot_for_BC_CC_valids__20230613.pdf",device = NULL,width = 15,height = 5 )
}








```



```{r}
del_NA_col<-function(mat,ratio=1){
  mat = mat[,apply(mat, 2, function(x) {sum(!is.na(x))/length(x) == ratio})]
  return(mat)
}
df<-read.csv("AG_GG_BC_CC_matrix0.531_10837Protein_20220317.csv",header = T)
# df1<-df[,13:ncol(df)]
# df1<-del_NA_col(df1)

#####
#
unique(df$subtype)
df$group<-"KTGC"
df$group[df$subtype=="BC"]<-"KTCC"
df$group[df$subtype=="CC"]<-"CC"
df$group[df$subtype=="GG"]<-"GC"
df$group<-factor(df$group,levels=c("KTCC","CC","KTGC","GC"))
df$sum<-apply(!is.na(df[,13:(ncol(df)-1)]),1,sum)
df1<-df[,c(1,2,(ncol(df)-1),(ncol(df)))]

library(ggplot2)
library(dplyr)

# 
label_data <- df1 %>%
  group_by(group) %>%
  summarise(
    x_pos = mean(as.numeric(factor(batch, levels = unique(batch)))),
    y_pos = 0  # 标签放在y轴底部
  )

df1$group <- factor(df1$group, levels = unique(df1$group))

# 
df_sorted <- df1[order(df1$group), ]
df_sorted$batch <- factor(df_sorted$batch, levels = unique(df_sorted$batch))

# 
a<-ggplot(df_sorted, aes(x = batch, y = sum, fill = group)) +
  geom_bar(stat = "identity", width = 0.7) +
  
 
  scale_fill_discrete(name = "Group") +
  
  
  labs(x = NULL, y = "Sum Value") +  # 
  
  # 
  theme_classic() +  #）
  
  # 
  theme(
    panel.background = element_rect(fill = "white"),  # 
    axis.line = element_line(color = "black"),  # 
    axis.text.x = element_blank(),  # 
    axis.ticks.x = element_blank(),  # 
    axis.title.x = element_blank(),  # 
    plot.margin = margin(t = 10, r = 10, b = 30, l = 10)  # 
  )

a
ggsave("20250807_KT_samp_sum_barplot.pdf",a,width = 10,height = 6)






```














